<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>BY DevOps | 今晚打老虎</title>
  <meta name="author" content="林文杰">
  
  <meta name="description" content="DevOps 技术运维小学生">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="BY DevOps | 今晚打老虎">

  
    <meta property="og:image" content="undefined">
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>
</html>
 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">BY DevOps | 今晚打老虎</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1>记录Linux的点点滴滴（DevOps技术运维小学生）</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Welcome to my blog.
</div>    

		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2020-02-13 </div>
			<div class="article-title"><a href="/2020/02/13/小公司如何优雅地推进应用上Kubernetes容器云/">小公司如何优雅地推进应用上Kubernetes容器云</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="一、引言">一、引言</h3><blockquote>
<p>分享摘要：随着公司业务高速发展，叠加市场变化莫测，业务也要及时作出反应，这要求我们需要更快速的交付和部署。本次分享主要关于公司在容器化落地过程中遇到的困难和解决方案，希望能帮助正在上或准备上容器云平台的朋友们。</p>
</blockquote>
<h3 id="二、_为何要上容器？">二、    为何要上容器？</h3><p>首先了解下公司背景，如下图所示：<br><img src="/img/202002/1.png" style="width: 550x;"><br>2.1、随着公司业务高发展，市场变化莫测，业务也要及时作出反应，这要求我们需要更快速的交付和部署。<br>2.2、系统资源利用率可提升空间大，随着业务规模不断扩大后，会引起服务器资源浪费。<br>2.3、系统环境多，久而久之存在环境差异严重的可能性增大，影响业务交付效率，同时环境相对较复杂，维护管理成本较大。<br>综上所述3大原因导致运维团队迫不及待推进容器云平台，主要为了达到以下三大点收益：<br><img src="/img/202002/2.png" style="width: 550x;"></p>
<h3 id="三、容器编排如何选择？">三、容器编排如何选择？</h3><p><img src="/img/202002/3.png" style="width: 550x;"></p>
<p>通过对比现阶段几个主流编排工具优缺点，从生产经验、学习和运维成本几个维度后，公司运维团队成员在技术选型上毅然一致性选择kubernetes。Kubernetes（简称为K8s）是用于自动部署、扩展和管理容器化（containerized）应用程序的开源系统。它适用于多种生产环境，包括裸机，内部部署虚拟机，大多数云提供商，以及三者的组合/混合。目前已经从CNCF毕业，已然成为容器编排领域的标准，Kubernete包括以下所列功能：</p>
<ul>
<li>服务发现</li>
<li>健康检测</li>
<li>实例复制</li>
<li>弹性伸缩、自动扩展</li>
<li>负载均衡</li>
<li>自动部署和回滚</li>
<li>资源监控</li>
<li>调试应用程序</li>
<li>提供认证和授权</li>
<li>……</li>
</ul>
<h3 id="四、如何推动应用落地kubernetes?">四、如何推动应用落地kubernetes?</h3><p>上面列举kubernetes能实现如此之多功能，那么到底应该如何快速落地？经团队商议研究简单归纳总结了以下五大痛点：</p>
<ul>
<li>变更不能太大（包括开发修改难度、原发布系统修改、日志访问等）</li>
<li>需要解决的问题？（如：Dubbo连接，网络等）</li>
<li>如何快速安装扩容节点？</li>
<li>如何保证高可用？（如：集群等）</li>
<li>监控告警如何做？</li>
</ul>
<h4 id="4-1_如何做到变更不能太大？？？">4.1 如何做到变更不能太大？？？</h4><p>4.1.1 尽可能减少开发人员代码变改，不能单纯地为了上容器而推翻原有代码。如涉及到代码变更或需重构过大，会影响业务开发进度，进而加慢kubernetes落地速度。同时建议Dockerfile编写尽可能掌握在运维手上，减少开发人员学习成本,同时有效减少分层问题发生。<br>4.1.2 兼容原来发布系统，在此采取新增容器发布页面，原来应用发布方式保留，应用在Jenkins构建过程中推送多一份镜像到harbor仓库，原来的压缩包方式保留。</p>
<p>简单画了下架构图如下所示：<br><img src="/img/202002/4.png" style="width: 550x;"></p>
<p>发布过程此处并没有使用Helm，当然Helm是管理 Kubernetes 应用程序的非常友好的打包工具。发布平台发布主要是基于K8s Api调用执行指定的yaml文件，进而达到更新、回滚、重启效果，具体可参考:<a href="https://github.com/kubernetes-client/python" target="_blank" rel="noopener">https://github.com/kubernetes-client/python</a><br><img src="/img/202002/5.png" style="width: 550x;"><br><img src="/img/202002/6.png" style="width: 550x;"></p>
<p>4.1.3日志访问，兼容原有日志访问方式，原来的日志采取上传到阿里云的日志服务，上容器后保留原有的方式，同时为了保证磁盘IO问题，日志采取不落盘模式（建议大家根据司情出发，如原使用EFk方式查看，可以兼容原有系统，毕竟让开发去改变已经习惯的事情时候，还是需要点时间适应。）<br><img src="/img/202002/7.png" style="width: 550x;"><br>具体架构图如上所示：Java/Node –&gt; Syslog–&gt; Logstash–&gt; Kafka –&gt; Logstash –&gt; 阿里云日志服务</p>
<h4 id="4-2网络问题如何解决？？？">4.2网络问题如何解决？？？</h4><p>4.2.1 注册中心(如Dubbo或Eureka)的注册IP网络问题等可以采取路由跳转方式解决<br>4.2.2 DNS采取kubernete集群内coredns+原来外置自建DNS方式，原内网域名依然支持使用<br>4.2.3 为了减少发布过程网络推送慢问题，本地和生产采取Harbor自带复制模式，镜像推送后自动同步到生产仓库，减少异地拉取镜像慢问题出现。</p>
<h4 id="4-3如何快速安装扩容节点？？？">4.3如何快速安装扩容节点？？？</h4><p>4.3.1 Node节点部署方式主要采取基于Ansible快速安装，建议初学者采取二进制安装一次集群，主要加深各组件认知，以便出现问题时能快速定位问题所在。<br><img src="/img/202002/8.png" style="width: 550x;"><br><img src="/img/202002/9.png" style="width: 550x;"><br>4.3.2 Pod伸缩提供变更页面<br><img src="/img/202002/10.png" style="width: 550x;"></p>
<h4 id="4-4如何保证高可用？？？">4.4如何保证高可用？？？</h4><p>4.4.1 首先保证组件高可用，特别是Master组件高可用，具体可参考<a href="https://k8smeetup.github.io/docs/admin/high-availability/" target="_blank" rel="noopener">https://k8smeetup.github.io/docs/admin/high-availability/</a><br>为何上面强调建议二进制安装一次，主要加深对下图（来源于网络）每个组件的认识。<br><img src="/img/202002/11.png" style="width: 550x;"></p>
<p>在Master组件中需保证的高可用组件包括：Apiserver（提供认证、授权、访问控制、API注册和发现等机制）、Controller Manager（负责维护集群的状态，比如故障检测、自动扩展、滚动更新等）、Scheduler（负责资源的调度），可以采取手段为：Haproxy+ Keepalived(如果是使用云服务器也可使用相应的负载均衡器，例如阿里云的SLB)</p>
<ul>
<li>Keepalived提供 Kube-apiserver 对外服务访问的 VIP</li>
<li>Haproxy提供健康检查和负载均衡功能，后端服务为 Kube-apiserver</li>
</ul>
<p>4.4.2 保证Etcd数据库高可用<br>Etcd保存了整个集群的状态，基本上核心不能再核心的组件了。所以推荐部署多节点，组成Etcd集群模式，在Etcd高可用集群中可挂节点数为(n-1)/2个，所以推荐部署3个节点或以上，同时养成良好备份习惯，定时备份。注意下v2和v3版本数据结构完全不同，互不兼容，各自创建的数据只能使用对应的版本访问。<br>3.4.3保证镜像仓库高可用<br>Harbor高可用可包括以下方案，公司采取两者混合使用（测试高可用仓库– &gt; 生产高可用仓库）</p>
<ul>
<li>多实例共享后端存储(采取挂载文件系统方式)<br><img src="/img/202002/12.png" style="width: 550x;"></li>
<li>多实例相互数据同步(基于镜像复制模式)<br>4.4.4进行容灾演练，提前预知风险问题点，可以参考以下图（篇幅问题截取部分内容），具体可依据司情制定方案：<br><img src="/img/202002/13.png" style="width: 550x;"></li>
</ul>
<h4 id="4-5_监控告警如何做？？？">4.5 监控告警如何做？？？</h4><p>4.5.1 监控方面采取主流监控方案Prometheus，Prometheus是一个云原生计算基础项目，是一个系统和服务监控系统。目前Prometheus已经从CNCF孵化完成，应该可以说是容器云场景中监控的首选方案，具体架构图如下：<br><img src="/img/202002/14.png" style="width: 550x;"><br>安装方式采取用了Prometheus-operator,当然也推荐使用Helm chart安装部署，可参考<a href="https://github.com/coreos/prometheus-operator" target="_blank" rel="noopener">https://github.com/coreos/prometheus-operator</a></p>
<p>网页图形展示使用Grafana UI如下所示： (截取测试环境某台Node)<br><img src="/img/202002/15.png" style="width: 550x;"><br>4.5.2告警方案：<br>如上面的架构图所示，Alertmanager通过配置Webhook告警信息发送到监控平台，开发或者运维人员到监控平台订阅相关指标即可实现推送。<br><img src="/img/202002/16.png" style="width: 550x;"><br><img src="/img/202002/17.png" style="width: 550x;"><br>微信接收告警如下所示：<br><img src="/img/202002/18.png" style="width: 550x;"></p>
<h3 id="五、_后期将要做些啥？">五、    后期将要做些啥？</h3><p>5.1 进一步提高应用容器化接入率<br>5.2 完善容器接入CMDB平台数据<br>5.3 评估是否需要引入服务网格，将服务治理能力降到基础设施层面<br>5.4 容器计费系统，把运维成本转化为开发业务部门上，记录业务所花费资源</p>
<p>当然也可以查看：<a href="https://blog.csdn.net/M2l0ZgSsVc7r69eFdTj/article/details/100072142" target="_blank" rel="noopener">https://blog.csdn.net/M2l0ZgSsVc7r69eFdTj/article/details/100072142</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2020/02/13/小公司如何优雅地推进应用上Kubernetes容器云/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-24 </div>
			<div class="article-title"><a href="/2019/03/24/使用非root用户操作Docker/">使用非root用户操作Docker</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h4 id="1、使用普通用户登录报错">1、使用普通用户登录报错</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[dev@kube-node1 ~]$ docker ps -a</span><br><span class="line">Got permission denied <span class="keyword">while</span> trying to connect to the Docker daemon socket at unix:<span class="regexp">//</span><span class="regexp">/var/</span>run<span class="regexp">/docker.sock: Get http:/</span><span class="regexp">/%2Fvar%2Frun%2Fdocker.sock/</span>v1.<span class="number">37</span><span class="regexp">/containers/</span>json?all=<span class="number">1</span>: dial unix <span class="regexp">/var/</span>run<span class="regexp">/docker.sock: connect: permission denied</span></span><br></pre></td></tr></table></figure>
<h4 id="2、查阅官方资料_https://docs-docker-com/install/linux/linux-postinstall/_得到以下：">2、查阅官方资料 <a href="https://docs.docker.com/install/linux/linux-postinstall/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/linux-postinstall/</a> 得到以下：</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The Docker daemon binds <span class="keyword">to</span> a Unix socket instead of a TCP port. By<span class="built_in"> default </span>that Unix socket is owned by the<span class="built_in"> user </span>root <span class="keyword">and</span> other<span class="built_in"> users </span>can only access it using sudo. The Docker daemon always runs as the root user.</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> you don’t want <span class="keyword">to</span> preface the docker command with sudo, create a Unix<span class="built_in"> group </span>called docker <span class="keyword">and</span> <span class="builtin-name">add</span><span class="built_in"> users </span><span class="keyword">to</span> it. When the Docker daemon starts, it creates a Unix socket accessible by members of the docker group.</span><br></pre></td></tr></table></figure>
<h4 id="3、解决方案：">3、解决方案：</h4><h5 id="3-1、创建docker组">3.1、创建docker组</h5><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># groupadd docker</span></span><br></pre></td></tr></table></figure>
<h5 id="3-2、将所需用户加入docker组">3.2、将所需用户加入docker组</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gpasswd -a $&#123;USER&#125; docker</span></span><br></pre></td></tr></table></figure>
<h5 id="3-3、重启docker">3.3、重启docker</h5><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>
<h5 id="3-4、验证">3.4、验证</h5><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-node1 /home/yunwei]<span class="comment"># su - dev</span></span><br><span class="line">Last login: Wed Feb <span class="number">20</span> <span class="number">14</span>:<span class="number">08</span>:<span class="number">20</span> CST <span class="number">2019</span> <span class="literal">on</span> pts/<span class="number">0</span></span><br><span class="line">[dev@kube-node1 ~]$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                                                        COMMAND                  CREATED             STATUS                     PORTS                       NAMES</span><br><span class="line">e8404a144626        f57c75cd7b0a                                                 <span class="string">"/heapster --source=…"</span>   <span class="number">11</span> days ago         Exited (<span class="number">137</span>) <span class="number">11</span> days ago                               k8s_heapster_heapster<span class="number">-9</span>cc69ddcf-qlww2_kube-system_f8345be8<span class="number">-1</span>d5e<span class="number">-11e9</span>-acd8<span class="number">-005056</span>b22233_11</span><br></pre></td></tr></table></figure>
<p>参考资料：</p>
<ul>
<li><a href="https://docs.docker.com/install/linux/linux-postinstall/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/linux-postinstall/</a></li>
</ul>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/03/24/使用非root用户操作Docker/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-24 </div>
			<div class="article-title"><a href="/2019/03/24/如何进入Docker容器和Pod？/">如何进入Docker容器和Pod？</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h5 id="两种方案：">两种方案：</h5><h6 id="进入docker容器_：">进入docker容器 ：</h6><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -ti  <span class="params">&lt;your-container-name&gt;</span>   <span class="meta-keyword">/bin/</span>sh</span><br></pre></td></tr></table></figure>
<h6 id="进入pod：">进入pod：</h6><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -ti <span class="params">&lt;your-pod-name&gt;</span>  -n <span class="params">&lt;your-namespace&gt;</span>  -- <span class="meta-keyword">/bin/</span>sh</span><br></pre></td></tr></table></figure>
<p>附：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">kubectl logs -f deploy/<span class="built_in">test</span>-6549dd8c94-w8kb9 -n huidu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n huidu <span class="built_in">test</span>-6549dd8c94-w8kb9 -- /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启pod</span></span><br><span class="line">kubectl delete po -n huidu <span class="built_in">test</span>-6549dd8c94-w8kb9</span><br></pre></td></tr></table></figure></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/03/24/如何进入Docker容器和Pod？/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-24 </div>
			<div class="article-title"><a href="/2019/03/24/如何解决The-connection-to-the-server-localhost8080-was-refused》？/">如何解决The connection to the server localhost8080 was refused？</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="查看集群信息报错">查看集群信息报错</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@gzzsg-test-k8smaster03 ~]<span class="comment"># kubectl cluster-info</span></span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, <span class="keyword">use</span> <span class="string">'kubectl cluster-info dump'</span>.</span><br><span class="line">The <span class="keyword">connection</span> <span class="keyword">to</span> the <span class="keyword">server</span> localhost:<span class="number">8080</span> was refused - did you specify the <span class="keyword">right</span> host <span class="keyword">or</span> port?</span><br></pre></td></tr></table></figure>
<h3 id="原因分析：">原因分析：</h3><ul>
<li>1、apiserver启动时候端没有开启8080</li>
<li>2、配置文件设置为–insecure-port=0</li>
</ul>
<h3 id="解决方案：">解决方案：</h3><ul>
<li>1、开启8080端口 –insecure-port=8080</li>
<li>2、指定~/.kube/config<br>复制kubernetes 部署 dashboard 插件中创建使用 token 的 KubeConfig 文件内容到~/.kube/config即可<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@gzzsg-test-k8smaster01 cfg]# kubectl  cluster-info</span><br><span class="line">Kubernetes master <span class="keyword">is</span> running at http<span class="variable">s:</span>//k8s-api-test.xxx.<span class="keyword">com</span>:<span class="number">8443</span></span><br><span class="line">kubernetes-dashboard <span class="keyword">is</span> running at http<span class="variable">s:</span>//k8s-api-test.xxx.<span class="keyword">com</span>:<span class="number">8443</span>/api/v1/namespaces/kube-<span class="built_in">system</span>/services/http<span class="variable">s:kubernetes</span>-dashboard:/proxy</span><br><span class="line"></span><br><span class="line">To further <span class="keyword">debug</span> <span class="built_in">and</span> diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br></pre></td></tr></table></figure>
</li>
</ul>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/03/24/如何解决The-connection-to-the-server-localhost8080-was-refused》？/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-03 </div>
			<div class="article-title"><a href="/2019/03/03/python-cStringIO模块-附生成excel并发送邮件实例/">python cStringIO模块( 附生成excel并发送邮件实例)</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <blockquote>
<p>在计算机中，IO是Input/Output的简写，也就是输入和输出。<br>IO编程中，Stream（流）是一个很重要的概念，可以把流想象成一个水管，数据就是水管里的水，但是只能单向流动。Input Stream就是数据从外面（磁盘、网络）流进内存，Output Stream就是数据从内存流到外面去。对于浏览网页来说，浏览器和服务器之间至少需要建立两根水管，才可以既能发数据，又能收数据。<br>cStringIO类似于StringIO（用法参见Python:StringIO模块），很多时候我们可以内存中读写str,并非一定要写先文件到磁盘。cStringIO其优势在于cStringIO是由C语言写成，运行速度较StringIO快。如果需要大量使用StringIO，就可以考虑使用cStringIO替代。官方文档：<a href="https://docs.python.org/2/library/stringio.html" target="_blank" rel="noopener">https://docs.python.org/2/library/stringio.html</a></p>
</blockquote>
<h5 id="使用cStringIO时有几点需要非常注意：">使用cStringIO时有几点需要非常注意：</h5><ul>
<li><strong>cStringIO.StringIO([s])是工厂函数，不能自行对其进行扩展。</strong></li>
<li>**不能使用不能被转码为ASCII的Unicode编码格式的字符串。</li>
<li><strong>带字符串参数创建的内存文件，如：</strong><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cStringIO </span><br><span class="line">s=<span class="string">'abcd'</span></span><br><span class="line">a=cStringIO.StringIO(s)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>则a为只读文件，没有write()函数。<br>若不带参数，则同时有read()函数和write()函数。</p>
<h6 id="Example_usage:">Example usage:</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cStringIO</span><br><span class="line"></span><br><span class="line">output = cStringIO.StringIO()</span><br><span class="line">output.write(<span class="string">'First line.\n'</span>)</span><br><span class="line"><span class="keyword">print</span> &gt;&gt;output, <span class="string">'Second line.'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Retrieve file contents -- this will be</span></span><br><span class="line"><span class="comment"># 'First line.\nSecond line.\n'</span></span><br><span class="line">contents = output.getvalue()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Close object and discard memory buffer -- </span></span><br><span class="line"><span class="comment"># .getvalue() will now raise an exception.</span></span><br><span class="line">output.close()</span><br></pre></td></tr></table></figure>
<h6 id="实操例子：">实操例子：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xlsxwriter</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> cStringIO <span class="keyword">as</span> StringIO</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">import</span> StringIO</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建内存文件</span></span><br><span class="line">xls = StringIO.StringIO()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># 创建文件</span></span><br><span class="line">    workbook = xlsxwriter.Workbook(xls)</span><br><span class="line">    <span class="comment"># 创建工作薄</span></span><br><span class="line">    worksheet = workbook.add_worksheet()</span><br><span class="line">    <span class="comment"># 写入标题（第一行）</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    title = [<span class="string">"start_timestamp"</span>, <span class="string">"db_instance_id"</span>, <span class="string">"lock_time"</span>, <span class="string">"query_time"</span>, <span class="string">"return_row_count"</span>, <span class="string">"parse_row_count"</span>, <span class="string">"db_name"</span>, <span class="string">"sql"</span>, <span class="string">"user"</span>, <span class="string">"host"</span>]</span><br><span class="line">    worksheet.write_row(<span class="number">0</span>, i, title)</span><br><span class="line">    j = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">        worksheet.write(j, <span class="number">0</span>, time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime(i[<span class="number">0</span>])))</span><br><span class="line">        worksheet.write(j, <span class="number">1</span>, i[<span class="number">1</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">2</span>, i[<span class="number">2</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">3</span>, i[<span class="number">3</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">4</span>, i[<span class="number">4</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">5</span>, i[<span class="number">5</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">6</span>, i[<span class="number">6</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">7</span>, i[<span class="number">7</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">8</span>, i[<span class="number">8</span>])</span><br><span class="line">        worksheet.write(j, <span class="number">9</span>, i[<span class="number">9</span>])</span><br><span class="line">        j+=<span class="number">1</span></span><br><span class="line">    workbook.close()</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    print(str(e))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将内存文件偏移量改为开始，便于邮件中读出所有内容，并发出</span></span><br><span class="line">xls.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">##发送邮件时，从内存读取</span></span><br><span class="line">attach = MIMEText(xls.read(), <span class="string">"base64"</span>, <span class="string">"gb2312"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除内存文件</span></span><br><span class="line">xls.close()</span><br></pre></td></tr></table></figure>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/03/03/python-cStringIO模块-附生成excel并发送邮件实例/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-03-03 </div>
			<div class="article-title"><a href="/2019/03/03/pyevn-pipenv初始化你需要的python环境/">pyevn+pipenv初始化你需要的python环境</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="一、引言">一、引言</h3><blockquote>
<p>现在很多运维小伙伴都基于go或者python语言来编写些小工具或者平台。同时不少小伙伴都存在多个版本的python环境，特别是以前基于python2.7开发，现在基于python3开发。今天我们来简单介绍两个工具来初始化你需要的python环境</p>
</blockquote>
<h3 id="二、PYENV">二、PYENV</h3><h4 id="PYENV可以干嘛？">PYENV可以干嘛？</h4><ul>
<li>让您基于每个用户更改全局Python版本。</li>
<li>为每个项目的Python版本提供支持。</li>
<li>允许您使用环境变量覆盖Python版本。</li>
<li>一次从多个版本的Python中搜索命令。</li>
</ul>
<h4 id="PYENV安装">PYENV安装</h4><h5 id="1、安装依赖">1、安装依赖</h5><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install </span>gcc make patch gdbm-devel openssl-devel sqlite-devel zlib-devel <span class="keyword">bzip2-devel </span>readline-devel</span><br></pre></td></tr></table></figure>
<h5 id="2、安装">2、安装</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"/root/.pyenv/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv init -)</span>"</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv virtualenv-init -)</span>"</span></span><br></pre></td></tr></table></figure>
<h4 id="pyevn用法可参考">pyevn用法可参考</h4><p> <img src="/img/201903/pyenv01.png" style="width: 550x;"></p>
<p>具体可参考：<a href="https://github.com/pyenv/pyenv" target="_blank" rel="noopener">https://github.com/pyenv/pyenv</a></p>
<h3 id="三、pipenv是啥？">三、pipenv是啥？</h3><p>pipenv这个管理工具，是 Kennethreitz 大神的作品，requests模块作者，主要解决使用同一模块多个版本的问题</p>
<h5 id="PIPENV安装">PIPENV安装</h5><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> pipenv</span><br></pre></td></tr></table></figure>
<h5 id="pipenv_用法可参考">pipenv 用法可参考</h5><p> <img src="/img/201903/pipenv01.png" style="width: 550x;"><br>更详细用法可参考：<a href="https://github.com/pypa/pipenv" target="_blank" rel="noopener">https://github.com/pypa/pipenv</a></p>
<h4 id="如何结合pycharm使用">如何结合pycharm使用</h4><p> <img src="/img/201903/pycharm01.png" style="width: 550x;"><br>  <img src="/img/201903/pycharm02.png" style="width: 550x;"></p>
<p> <img src="/img/201903/pycharm03.png" style="width: 550x;"></p>
<p>附加：<br>django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module: No module named MySQLdb<br>解决方案：<br>sudo yum install mysql-devel<br>sudo yum install python-devel<br>sudo pipenv install mysql-python</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/03/03/pyevn-pipenv初始化你需要的python环境/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-18 </div>
			<div class="article-title"><a href="/2019/02/18/Ansible模块中核心类（附执行剧本实例代码）/">Ansible模块中核心类（附执行剧本实例代码）</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="一、引言">一、引言</h3><blockquote>
<p>现阶段不少小伙伴都有自研CMDB平台，不过也有不少朋友询问如何定时获取系统硬件数据更新到数据库？对此，博主推荐使用自动化运维工具，如salt、ansible等，并不是自行写脚本就不可以。如做到标准化、规范化、机器规模达到一定量，还是比较推荐使用自动化运维工具。</p>
</blockquote>
<h3 id="二、简单看以下执行shell模块中ls命令">二、简单看以下执行shell模块中ls命令</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">引用模块</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> ansible.parsing.dataloader <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> ansible.vars.manager <span class="keyword">import</span> VariableManager</span><br><span class="line"><span class="keyword">from</span> ansible.inventory.manager <span class="keyword">import</span> InventoryManager</span><br><span class="line"><span class="keyword">from</span> ansible.playbook.play <span class="keyword">import</span> Play</span><br><span class="line"><span class="keyword">from</span> ansible.executor.task_queue_manager <span class="keyword">import</span> TaskQueueManager</span><br><span class="line"><span class="keyword">from</span> ansible.plugins.callback <span class="keyword">import</span> CallbackBase</span><br><span class="line"><span class="keyword">import</span> ansible.constants <span class="keyword">as</span> C</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultCallback</span><span class="params">(CallbackBase)</span>:</span></span><br><span class="line">    <span class="string">"""A sample callback plugin used for performing an action as results come in</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If you want to collect all results into a single object for processing at</span></span><br><span class="line"><span class="string">    the end of the execution, look into utilizing the ``json`` callback plugin</span></span><br><span class="line"><span class="string">    or writing your own custom callback plugin</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_ok</span><span class="params">(self, result, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""Print a json representation of the result</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        This method could store the result in an instance attribute for retrieval later</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        host = result._host</span><br><span class="line">        print(json.dumps(&#123;host.name: result._result&#125;, indent=<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># since API is constructed for CLI it expects certain options to always be set, named tuple 'fakes' the args parsing options object</span></span><br><span class="line">Options = namedtuple(<span class="string">'Options'</span>, [<span class="string">'connection'</span>, <span class="string">'module_path'</span>, <span class="string">'forks'</span>, <span class="string">'become'</span>, <span class="string">'become_method'</span>, <span class="string">'become_user'</span>, <span class="string">'check'</span>, <span class="string">'diff'</span>])</span><br><span class="line">options = Options(connection=<span class="string">'local'</span>, module_path=[<span class="string">'/to/mymodules'</span>], forks=<span class="number">10</span>, become=<span class="keyword">None</span>, become_method=<span class="keyword">None</span>, become_user=<span class="keyword">None</span>, check=<span class="keyword">False</span>, diff=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># initialize needed objects</span></span><br><span class="line">loader = DataLoader() <span class="comment"># Takes care of finding and reading yaml, json and ini files</span></span><br><span class="line">passwords = dict(vault_pass=<span class="string">'secret'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Instantiate our ResultCallback for handling results as they come in. Ansible expects this to be one of its main display outlets</span></span><br><span class="line">results_callback = ResultCallback()</span><br><span class="line"></span><br><span class="line"><span class="comment"># create inventory, use path to host config file as source or hosts in a comma separated string</span></span><br><span class="line">inventory = InventoryManager(loader=loader, sources=<span class="string">'localhost,'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># variable manager takes care of merging all the different sources to give you a unifed view of variables available in each context</span></span><br><span class="line">variable_manager = VariableManager(loader=loader, inventory=inventory)</span><br><span class="line"></span><br><span class="line"><span class="comment"># create datastructure that represents our play, including tasks, this is basically what our YAML loader does internally.</span></span><br><span class="line">play_source =  dict(</span><br><span class="line">        name = <span class="string">"Ansible Play"</span>,</span><br><span class="line">        hosts = <span class="string">'localhost'</span>,</span><br><span class="line">        gather_facts = <span class="string">'no'</span>,</span><br><span class="line">        tasks = [</span><br><span class="line">            dict(action=dict(module=<span class="string">'shell'</span>, args=<span class="string">'ls'</span>), register=<span class="string">'shell_out'</span>),</span><br><span class="line">            dict(action=dict(module=<span class="string">'debug'</span>, args=dict(msg=<span class="string">'&#123;&#123;shell_out.stdout&#125;&#125;'</span>)))</span><br><span class="line">         ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create play object, playbook objects use .load instead of init or new methods,</span></span><br><span class="line"><span class="comment"># this will also automatically create the task objects from the info provided in play_source</span></span><br><span class="line">play = Play().load(play_source, variable_manager=variable_manager, loader=loader)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run it - instantiate task queue manager, which takes care of forking and setting up all objects to iterate over host list and tasks</span></span><br><span class="line">tqm = <span class="keyword">None</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    tqm = TaskQueueManager(</span><br><span class="line">              inventory=inventory,</span><br><span class="line">              variable_manager=variable_manager,</span><br><span class="line">              loader=loader,</span><br><span class="line">              options=options,</span><br><span class="line">              passwords=passwords,</span><br><span class="line">              stdout_callback=results_callback,  <span class="comment"># Use our custom callback instead of the ``default`` callback plugin, which prints to stdout</span></span><br><span class="line">          )</span><br><span class="line">    result = tqm.run(play) <span class="comment"># most interesting data for a play is actually sent to the callback's methods</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># we always need to cleanup child procs and the structres we use to communicate with them</span></span><br><span class="line">    <span class="keyword">if</span> tqm <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        tqm.cleanup()</span><br><span class="line"></span><br><span class="line">     <span class="comment"># Remove ansible tmpdir</span></span><br><span class="line">     shutil.rmtree(C.DEFAULT_LOCAL_TMP, <span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>运行结果如下：<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost python]<span class="comment"># python ansible_api.py </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"localhost"</span>: &#123;</span><br><span class="line">        <span class="string">"_ansible_parsed"</span>: true, </span><br><span class="line">        <span class="string">"stderr_lines"</span>: [], </span><br><span class="line">        <span class="string">"changed"</span>: true, </span><br><span class="line">        <span class="string">"end"</span>: <span class="string">"2018-05-29 03:44:27.292832"</span>, </span><br><span class="line">        <span class="string">"_ansible_no_log"</span>: false, </span><br><span class="line">        <span class="string">"stdout"</span>: <span class="string">"ansible_api.py\nsaomiao.py"</span>, </span><br><span class="line">        <span class="string">"cmd"</span>: <span class="string">"ls"</span>, </span><br><span class="line">        <span class="string">"start"</span>: <span class="string">"2018-05-29 03:44:27.262984"</span>, </span><br><span class="line">        <span class="string">"delta"</span>: <span class="string">"0:00:00.029848"</span>, </span><br><span class="line">        <span class="string">"stderr"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="string">"rc"</span>: <span class="number">0</span>, </span><br><span class="line">        <span class="string">"invocation"</span>: &#123;</span><br><span class="line">            <span class="string">"module_args"</span>: &#123;</span><br><span class="line">                <span class="string">"creates"</span>: null, </span><br><span class="line">                <span class="string">"executable"</span>: null, </span><br><span class="line">                <span class="string">"_uses_shell"</span>: true, </span><br><span class="line">                <span class="string">"_raw_params"</span>: <span class="string">"ls"</span>, </span><br><span class="line">                <span class="string">"removes"</span>: null, </span><br><span class="line">                <span class="string">"warn"</span>: true, </span><br><span class="line">                <span class="string">"chdir"</span>: null, </span><br><span class="line">                <span class="string">"stdin"</span>: null</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"stdout_lines"</span>: [</span><br><span class="line">            <span class="string">"ansible_api.py"</span>, </span><br><span class="line">            <span class="string">"saomiao.py"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"localhost"</span>: &#123;</span><br><span class="line">        <span class="string">"msg"</span>: <span class="string">"ansible_api.py\nsaomiao.py"</span>, </span><br><span class="line">        <span class="string">"changed"</span>: false, </span><br><span class="line">        <span class="string">"_ansible_verbose_always"</span>: true, </span><br><span class="line">        <span class="string">"_ansible_no_log"</span>: false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过以上可举例，当获取硬件如cpu、硬盘、内存等信息时候，可以使用setup模块获取，过滤即可入库保存。</p>
<h3 id="三、Ansible模块中核心类">三、Ansible模块中核心类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ansible.parsing.dataloader <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> ansible.vars.manager <span class="keyword">import</span> VariableManager</span><br><span class="line"><span class="keyword">from</span> ansible.inventory.manager <span class="keyword">import</span> InventoryManager</span><br><span class="line"><span class="keyword">from</span> ansible.playbook.play <span class="keyword">import</span> Play</span><br><span class="line"><span class="keyword">from</span> ansible.executor.task_queue_manager <span class="keyword">import</span> TaskQueueManager</span><br><span class="line"><span class="keyword">from</span> ansible.plugins.callback <span class="keyword">import</span> CallbackBase</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>核心类</th>
<th>用途</th>
<th>路径</th>
</tr>
</thead>
<tbody>
<tr>
<td>DataLoader</td>
<td>读取yam、json格式文件</td>
<td>ansible.parsing.dataloader</td>
</tr>
<tr>
<td>VariableManager</td>
<td>存储变量信息</td>
<td>ansible.inventory.manager</td>
</tr>
<tr>
<td>InventoryManager</td>
<td>用于导入Invetory文件</td>
<td>ansible.inventory.manager</td>
</tr>
<tr>
<td>Play</td>
<td>存储hosts角色信息</td>
<td>ansible.playbook.play</td>
</tr>
<tr>
<td>TaskQueueManager</td>
<td>任务队列</td>
<td>ansible.executor.task_queue_manager</td>
</tr>
<tr>
<td>CallbackBase</td>
<td>状态回调</td>
<td>ansible.plugins.callback</td>
</tr>
</tbody>
</table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: <span class="keyword">from</span> ansible.vars.manager <span class="keyword">import</span> VariableManager</span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: <span class="keyword">from</span> ansible.inventory.manager <span class="keyword">import</span> InventoryManager</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: <span class="keyword">from</span> ansible.playbook.play <span class="keyword">import</span> Play</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="keyword">from</span> ansible.executor.playbook_executor <span class="keyword">import</span> PlaybookExecutor</span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: <span class="keyword">from</span> ansible.executor.task_queue_manager <span class="keyword">import</span> TaskQueueManager</span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: <span class="keyword">from</span> ansible.plugins.callback <span class="keyword">import</span> CallbackBase</span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: loader = DataLoader() <span class="comment">##实例对象</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: inventory = InventoryManager(loader=loader, sources=[<span class="string">'/etc/ansible/hosts'</span>])  <span class="comment">##调用InventoryManager返回实例对象</span></span><br></pre></td></tr></table></figure>
<h5 id="执行dir查看函数">执行dir查看函数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">10</span>]: dir(inventory)</span><br><span class="line">Out[<span class="number">10</span>]: </span><br><span class="line">[<span class="string">'__class__'</span>,</span><br><span class="line"> <span class="string">'__delattr__'</span>,</span><br><span class="line"> <span class="string">'__dict__'</span>,</span><br><span class="line"> <span class="string">'__doc__'</span>,</span><br><span class="line"> <span class="string">'__format__'</span>,</span><br><span class="line"> <span class="string">'__getattribute__'</span>,</span><br><span class="line"> <span class="string">'__hash__'</span>,</span><br><span class="line"> <span class="string">'__init__'</span>,</span><br><span class="line"> <span class="string">'__module__'</span>,</span><br><span class="line"> <span class="string">'__new__'</span>,</span><br><span class="line"> <span class="string">'__reduce__'</span>,</span><br><span class="line"> <span class="string">'__reduce_ex__'</span>,</span><br><span class="line"> <span class="string">'__repr__'</span>,</span><br><span class="line"> <span class="string">'__setattr__'</span>,</span><br><span class="line"> <span class="string">'__sizeof__'</span>,</span><br><span class="line"> <span class="string">'__str__'</span>,</span><br><span class="line"> <span class="string">'__subclasshook__'</span>,</span><br><span class="line"> <span class="string">'__weakref__'</span>,</span><br><span class="line"> <span class="string">'_apply_subscript'</span>,</span><br><span class="line"> <span class="string">'_enumerate_matches'</span>,</span><br><span class="line"> <span class="string">'_evaluate_patterns'</span>,</span><br><span class="line"> <span class="string">'_hosts_patterns_cache'</span>,</span><br><span class="line"> <span class="string">'_inventory'</span>,</span><br><span class="line"> <span class="string">'_inventory_plugins'</span>,</span><br><span class="line"> <span class="string">'_loader'</span>,</span><br><span class="line"> <span class="string">'_match_list'</span>,</span><br><span class="line"> <span class="string">'_match_one_pattern'</span>,</span><br><span class="line"> <span class="string">'_pattern_cache'</span>,</span><br><span class="line"> <span class="string">'_restriction'</span>,</span><br><span class="line"> <span class="string">'_setup_inventory_plugins'</span>,</span><br><span class="line"> <span class="string">'_sources'</span>,</span><br><span class="line"> <span class="string">'_split_subscript'</span>,</span><br><span class="line"> <span class="string">'_subset'</span>,</span><br><span class="line"> <span class="string">'add_group'</span>,</span><br><span class="line"> <span class="string">'add_host'</span>,</span><br><span class="line"> <span class="string">'clear_caches'</span>,</span><br><span class="line"> <span class="string">'clear_pattern_cache'</span>,</span><br><span class="line"> <span class="string">'get_groups_dict'</span>,</span><br><span class="line"> <span class="string">'get_host'</span>,</span><br><span class="line"> <span class="string">'get_hosts'</span>,</span><br><span class="line"> <span class="string">'get_vars'</span>,</span><br><span class="line"> <span class="string">'groups'</span>,</span><br><span class="line"> <span class="string">'hosts'</span>,</span><br><span class="line"> <span class="string">'list_groups'</span>,</span><br><span class="line"> <span class="string">'list_hosts'</span>,</span><br><span class="line"> <span class="string">'localhost'</span>,</span><br><span class="line"> <span class="string">'parse_source'</span>,</span><br><span class="line"> <span class="string">'parse_sources'</span>,</span><br><span class="line"> <span class="string">'reconcile_inventory'</span>,</span><br><span class="line"> <span class="string">'refresh_inventory'</span>,</span><br><span class="line"> <span class="string">'remove_restriction'</span>,</span><br><span class="line"> <span class="string">'restrict_to_hosts'</span>,</span><br><span class="line"> <span class="string">'subset'</span>]</span><br></pre></td></tr></table></figure>
<h5 id="/etc/ansible/hosts">/etc/ansible/hosts</h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># tail /etc/ansible/hosts </span></span><br><span class="line"><span class="comment"># leading 0s:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## db-[99:101]-node.example.com</span></span><br><span class="line"></span><br><span class="line">[VM_129]</span><br><span class="line">192.168.72.129</span><br><span class="line">192.168.72.130</span><br><span class="line"><span class="section">[VM_129:vars]</span></span><br><span class="line">ansible_ssh_port=22</span><br><span class="line">nginx_version=1.13.1</span><br></pre></td></tr></table></figure>
<h5 id="获取主机group">获取主机group</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">30</span>]: <span class="keyword">print</span> inventory.get_groups_dict()</span><br><span class="line">&#123;<span class="string">'ungrouped'</span>: [], <span class="string">'all'</span>: [<span class="string">u'192.168.72.129'</span>, <span class="string">u'192.168.72.130'</span>], <span class="string">u'VM_129'</span>: [<span class="string">u'192.168.72.129'</span>, <span class="string">u'192.168.72.130'</span>]&#125;</span><br></pre></td></tr></table></figure>
<h5 id="获取主机host">获取主机host</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">31</span>]: inventory.hosts</span><br><span class="line">Out[<span class="number">31</span>]: &#123;<span class="string">u'192.168.72.129'</span>: <span class="number">192.168</span><span class="number">.72</span><span class="number">.129</span>, <span class="string">u'192.168.72.130'</span>: <span class="number">192.168</span><span class="number">.72</span><span class="number">.130</span>&#125;</span><br></pre></td></tr></table></figure>
<h5 id="variable_manager">variable_manager</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">32</span>]: variable_manager = VariableManager(loader=loader, inventory=inventory)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">###查看相关模块</span></span><br><span class="line">In [<span class="number">33</span>]: variable_manager.</span><br><span class="line">variable_manager.clear_facts              variable_manager.set_host_facts</span><br><span class="line">variable_manager.extra_vars               variable_manager.set_host_variable</span><br><span class="line">variable_manager.get_vars                 variable_manager.set_inventory</span><br><span class="line">variable_manager.options_vars             variable_manager.set_nonpersistent_facts</span><br></pre></td></tr></table></figure>
<p>重点说三个variable_manager模块</p>
<ul>
<li>1、查看变量variable_manager.get_vars </li>
<li>2、扩展变量variable_manager.extra_vars</li>
<li>3、设置主机变量variable_manager.set_host_variable</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">37</span>]: host=inventory.get_host(hostname=<span class="string">'192.168.72.129'</span>)</span><br><span class="line">           </span><br><span class="line">In [<span class="number">38</span>]: variable_manager.get_vars(host=host)</span><br><span class="line">Out[<span class="number">38</span>]: </span><br><span class="line">&#123;<span class="string">'ansible_playbook_python'</span>: <span class="string">'/usr/bin/python2'</span>,</span><br><span class="line"> <span class="string">u'ansible_ssh_port'</span>: <span class="number">22</span>,</span><br><span class="line"> <span class="string">'group_names'</span>: [<span class="string">u'VM_129'</span>],</span><br><span class="line"> <span class="string">'groups'</span>: &#123;<span class="string">u'VM_129'</span>: [<span class="string">u'192.168.72.129'</span>, <span class="string">u'192.168.72.130'</span>],</span><br><span class="line">  <span class="string">'all'</span>: [<span class="string">u'192.168.72.129'</span>, <span class="string">u'192.168.72.130'</span>],</span><br><span class="line">  <span class="string">'ungrouped'</span>: []&#125;,</span><br><span class="line"> <span class="string">'inventory_dir'</span>: <span class="string">u'/etc/ansible'</span>,</span><br><span class="line"> <span class="string">'inventory_file'</span>: <span class="string">u'/etc/ansible/hosts'</span>,</span><br><span class="line"> <span class="string">'inventory_hostname'</span>: <span class="string">u'192.168.72.129'</span>,</span><br><span class="line"> <span class="string">'inventory_hostname_short'</span>: <span class="string">u'192'</span>,</span><br><span class="line"> <span class="string">u'nginx_version'</span>: <span class="string">u'1.13.1'</span>,</span><br><span class="line"> <span class="string">'omit'</span>: <span class="string">'__omit_place_holder__91ac78f3a75e01eaa7d20ff0db9463023de382b8'</span>,</span><br><span class="line"> <span class="string">'playbook_dir'</span>: <span class="string">'/root'</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="四、如何执行剧本？">四、如何执行剧本？</h3><p>上面如何介绍了执行命令，下面顺便提供执行剧本的代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="comment"># python 2.7.5</span></span><br><span class="line"><span class="comment"># ansible 2.4.2.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> ansible.parsing.dataloader <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> ansible.vars.manager <span class="keyword">import</span> VariableManager</span><br><span class="line"><span class="keyword">from</span> ansible.inventory.manager <span class="keyword">import</span> InventoryManager</span><br><span class="line"><span class="keyword">from</span> ansible.playbook.play <span class="keyword">import</span> Play</span><br><span class="line"><span class="keyword">from</span> ansible.executor.playbook_executor <span class="keyword">import</span> PlaybookExecutor</span><br><span class="line"><span class="keyword">from</span> ansible.executor.task_queue_manager <span class="keyword">import</span> TaskQueueManager</span><br><span class="line"><span class="keyword">from</span> ansible.plugins.callback <span class="keyword">import</span> CallbackBase</span><br><span class="line"><span class="keyword">from</span> ansible.errors <span class="keyword">import</span> AnsibleParserError</span><br><span class="line"><span class="keyword">import</span> ansible.constants <span class="keyword">as</span> C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ad_hocResultsCollector</span><span class="params">(CallbackBase)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super(Ad_hocResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.host_ok = &#123;&#125;</span><br><span class="line">        self.host_unreachable = &#123;&#125;</span><br><span class="line">        self.host_failed = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_unreachable</span><span class="params">(self, result)</span>:</span></span><br><span class="line">        self.host_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_ok</span><span class="params">(self, result, *args, **kwargs)</span>:</span></span><br><span class="line">        self.host_ok[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_failed</span><span class="params">(self, result, *args, **kwargs)</span>:</span></span><br><span class="line">        self.host_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAd_hocResult</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 获取结果的回调函数</span></span><br><span class="line">        results_info = &#123;<span class="string">'success'</span>: &#123;&#125;, <span class="string">'failed'</span>: &#123;&#125;, <span class="string">'unreachable'</span>: &#123;&#125;&#125;</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.host_ok.items():</span><br><span class="line">            results_info[<span class="string">'success'</span>][host] = result._result</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.host_failed.items():</span><br><span class="line">            results_info[<span class="string">'failed'</span>][host] = result._result</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.host_unreachable.items():</span><br><span class="line">            results_info[<span class="string">'unreachable'</span>][host] = result._result</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayBookResultsCollector</span><span class="params">(CallbackBase)</span>:</span></span><br><span class="line">    CALLBACK_VERSION = <span class="number">2.0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super(PlayBookResultsCollector, self).__init__(*args, **kwargs)</span><br><span class="line">        self.task_ok = &#123;&#125;</span><br><span class="line">        self.task_skipped = &#123;&#125;</span><br><span class="line">        self.task_failed = &#123;&#125;</span><br><span class="line">        self.task_status = &#123;&#125;</span><br><span class="line">        self.task_unreachable = &#123;&#125;</span><br><span class="line">        self.status_no_hosts = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_ok</span><span class="params">(self, result, *args, **kwargs)</span>:</span></span><br><span class="line">        self.task_ok[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_failed</span><span class="params">(self, result, *args, **kwargs)</span>:</span></span><br><span class="line">        self.task_failed[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_unreachable</span><span class="params">(self, result)</span>:</span></span><br><span class="line">        self.task_unreachable[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_skipped</span><span class="params">(self, result)</span>:</span></span><br><span class="line">        self.task_skipped[result._host.get_name()] = result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_playbook_on_no_hosts_matched</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.status_no_hosts = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_playbook_on_stats</span><span class="params">(self, stats)</span>:</span></span><br><span class="line"></span><br><span class="line">        hosts = sorted(stats.processed.keys())</span><br><span class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> hosts:</span><br><span class="line">            t = stats.summarize(h)</span><br><span class="line">            self.task_status[h] = &#123;</span><br><span class="line">                <span class="string">"success"</span>: t[<span class="string">'ok'</span>],</span><br><span class="line">                <span class="string">"changed"</span>: t[<span class="string">'changed'</span>],</span><br><span class="line">                <span class="string">"unreachable"</span>: t[<span class="string">'unreachable'</span>],</span><br><span class="line">                <span class="string">"skipped"</span>: t[<span class="string">'skipped'</span>],</span><br><span class="line">                <span class="string">"failed"</span>: t[<span class="string">'failures'</span>]</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getPlaybookResult</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.status_no_hosts:</span><br><span class="line">            results = &#123;<span class="string">'msg'</span>: <span class="string">"Could not match supplied host pattern"</span>, <span class="string">'flag'</span>: <span class="keyword">False</span>, <span class="string">'executed'</span>: <span class="keyword">False</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> results</span><br><span class="line">        results_info = &#123;<span class="string">'skipped'</span>: &#123;&#125;, <span class="string">'failed'</span>: &#123;&#125;, <span class="string">'success'</span>: &#123;&#125;, <span class="string">"status"</span>: &#123;&#125;, <span class="string">'unreachable'</span>: &#123;&#125;, <span class="string">"changed"</span>: &#123;&#125;&#125;</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.task_ok.items():</span><br><span class="line">            results_info[<span class="string">'success'</span>][host] = result._result</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.task_failed.items():</span><br><span class="line">            results_info[<span class="string">'failed'</span>][host] = result</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.task_status.items():</span><br><span class="line">            results_info[<span class="string">'status'</span>][host] = result</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.task_skipped.items():</span><br><span class="line">            results_info[<span class="string">'skipped'</span>][host] = result</span><br><span class="line">        <span class="keyword">for</span> host, result <span class="keyword">in</span> self.task_unreachable.items():</span><br><span class="line">            results_info[<span class="string">'unreachable'</span>][host] = result</span><br><span class="line">        <span class="keyword">return</span> results_info</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnsRunner</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.resource = <span class="keyword">None</span></span><br><span class="line">        self.inventory = <span class="keyword">None</span></span><br><span class="line">        self.variable_manager = <span class="keyword">None</span></span><br><span class="line">        self.loader = <span class="keyword">None</span></span><br><span class="line">        self.options = <span class="keyword">None</span></span><br><span class="line">        self.passwords = <span class="keyword">None</span></span><br><span class="line">        self.__initializeData()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__initializeData</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 初始化需要的对象</span></span><br><span class="line">        Options = namedtuple(<span class="string">'Options'</span>, [<span class="string">'connection'</span>, <span class="string">'module_path'</span>, <span class="string">'forks'</span>, <span class="string">'timeout'</span>, <span class="string">'remote_user'</span>,</span><br><span class="line">                                         <span class="string">'ask_pass'</span>, <span class="string">'private_key_file'</span>, <span class="string">'ssh_common_args'</span>, <span class="string">'ssh_extra_args'</span>,</span><br><span class="line">                                         <span class="string">'sftp_extra_args'</span>,</span><br><span class="line">                                         <span class="string">'scp_extra_args'</span>, <span class="string">'become'</span>, <span class="string">'become_method'</span>, <span class="string">'become_user'</span>, <span class="string">'ask_value_pass'</span>,</span><br><span class="line">                                         <span class="string">'verbosity'</span>,</span><br><span class="line">                                         <span class="string">'check'</span>, <span class="string">'listhosts'</span>, <span class="string">'listtasks'</span>, <span class="string">'listtags'</span>, <span class="string">'syntax'</span>, <span class="string">'diff'</span>])</span><br><span class="line"></span><br><span class="line">        self.options = Options(connection=<span class="string">'ssh'</span>, module_path=<span class="keyword">None</span>, forks=<span class="number">100</span>, timeout=<span class="number">10</span>,</span><br><span class="line">                               remote_user=<span class="string">'root'</span>, ask_pass=<span class="keyword">False</span>, private_key_file=<span class="keyword">None</span>, ssh_common_args=<span class="keyword">None</span>,</span><br><span class="line">                               ssh_extra_args=<span class="keyword">None</span>,</span><br><span class="line">                               sftp_extra_args=<span class="keyword">None</span>, scp_extra_args=<span class="keyword">None</span>, become=<span class="keyword">None</span>, become_method=<span class="keyword">None</span>,</span><br><span class="line">                               become_user=<span class="string">'root'</span>, ask_value_pass=<span class="keyword">False</span>, verbosity=<span class="keyword">None</span>, check=<span class="keyword">False</span>, listhosts=<span class="keyword">False</span>,</span><br><span class="line">                               listtasks=<span class="keyword">False</span>, listtags=<span class="keyword">False</span>, syntax=<span class="keyword">False</span>, diff=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">        self.loader = DataLoader()  <span class="comment"># Takes care of finding and reading yaml, json and ini files</span></span><br><span class="line">        self.passwords = dict(vault_pass=<span class="string">'secret'</span>)</span><br><span class="line">        self.results_callback = Ad_hocResultsCollector()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create inventory, use path to host config file as source or hosts in a comma separated string e.g. sources=['10.1.30.193',]</span></span><br><span class="line">        self.inventory = InventoryManager(loader=self.loader, sources=[<span class="string">'/etc/ansible/hosts'</span>])</span><br><span class="line">        <span class="comment"># variable manager takes care of merging all the different sources to give you a unifed view of variables available in each context</span></span><br><span class="line">        self.variable_manager = VariableManager(loader=self.loader, inventory=self.inventory)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_ad_hoc</span><span class="params">(self, host_list=None, module_name=None, module_args=None)</span>:</span></span><br><span class="line">        self.results_callback = Ad_hocResultsCollector()</span><br><span class="line">        <span class="comment"># create datastructure that represents our play, including tasks, this is basically what our YAML loader does internally.</span></span><br><span class="line">        play_source = dict(</span><br><span class="line">            name=<span class="string">"Ansible Play"</span>,</span><br><span class="line">            hosts=host_list,</span><br><span class="line">            gather_facts=<span class="string">'no'</span>,</span><br><span class="line">            tasks=[</span><br><span class="line">                dict(action=dict(module=module_name, args=module_args), register=<span class="string">'shell_out'</span>),</span><br><span class="line">                dict(action=dict(module=<span class="string">'debug'</span>, args=dict(msg=<span class="string">'&#123;&#123;shell_out.stdout&#125;&#125;'</span>)))</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        play = Play().load(play_source, variable_manager=self.variable_manager, loader=self.loader)</span><br><span class="line">        tqm = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            tqm = TaskQueueManager(</span><br><span class="line">                inventory=self.inventory,</span><br><span class="line">                variable_manager=self.variable_manager,</span><br><span class="line">                loader=self.loader,</span><br><span class="line">                options=self.options,</span><br><span class="line">                passwords=self.passwords,</span><br><span class="line">                stdout_callback=self.results_callback,</span><br><span class="line">                <span class="comment"># Use our custom callback instead of the ``default`` callback plugin, which prints to stdout</span></span><br><span class="line">            )</span><br><span class="line">            result = tqm.run(play)  <span class="comment"># most interesting data for a play is actually sent to the callback's methods</span></span><br><span class="line">            <span class="keyword">return</span> self.results_callback.getAd_hocResult()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># we always need to cleanup child procs and the structres we use to communicate with them</span></span><br><span class="line">            <span class="keyword">if</span> tqm <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                tqm.cleanup()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Remove ansible tmpdir</span></span><br><span class="line">            shutil.rmtree(C.DEFAULT_LOCAL_TMP, <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cmdb_info</span><span class="params">(self, host_list)</span>:</span></span><br><span class="line">        self.results_callback = Ad_hocResultsCollector()</span><br><span class="line">        play_source = dict(</span><br><span class="line">            name=<span class="string">"Ansible setup Play"</span>,</span><br><span class="line">            hosts=host_list,</span><br><span class="line">            gather_facts=<span class="string">'no'</span>,</span><br><span class="line">            tasks=[</span><br><span class="line">                dict(action=dict(module=<span class="string">'setup'</span>), register=<span class="string">'shell_out'</span>),</span><br><span class="line"></span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        play = Play().load(play_source, variable_manager=self.variable_manager, loader=self.loader)</span><br><span class="line">        tqm = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            tqm = TaskQueueManager(</span><br><span class="line">                inventory=self.inventory,</span><br><span class="line">                variable_manager=self.variable_manager,</span><br><span class="line">                loader=self.loader,</span><br><span class="line">                options=self.options,</span><br><span class="line">                passwords=self.passwords,</span><br><span class="line">                stdout_callback=self.results_callback,</span><br><span class="line">            )</span><br><span class="line">            result = tqm.run(play)</span><br><span class="line">            <span class="keyword">return</span> self.results_callback.getAd_hocResult()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="keyword">if</span> tqm <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                tqm.cleanup()</span><br><span class="line">            shutil.rmtree(C.DEFAULT_LOCAL_TMP, <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_playbook</span><span class="params">(self, playbook_path, host_list=None, extra_vars=None)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> playbook_path:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(i):</span><br><span class="line">                <span class="keyword">print</span></span><br><span class="line">                <span class="string">'[INFO] The [%s] playbook does not exist'</span> % i</span><br><span class="line">                sys.exit()</span><br><span class="line"></span><br><span class="line">        self.variable_manager.extra_vars = extra_vars</span><br><span class="line">        passwords = <span class="keyword">None</span></span><br><span class="line">        self.results_callback = PlayBookResultsCollector()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            playbook = PlaybookExecutor(playbooks=playbook_path, inventory=self.inventory,</span><br><span class="line">                                        variable_manager=self.variable_manager,</span><br><span class="line">                                        loader=self.loader, options=self.options, passwords=passwords)</span><br><span class="line">            playbook._tqm._stdout_callback = self.results_callback</span><br><span class="line">            <span class="comment"># 执行playbook</span></span><br><span class="line">            result = playbook.run()</span><br><span class="line">            <span class="keyword">return</span> self.results_callback.getPlaybookResult()</span><br><span class="line">        <span class="keyword">except</span> AnsibleParserError:</span><br><span class="line">            code = <span class="number">1001</span></span><br><span class="line">            results = &#123;<span class="string">'playbook'</span>: playbook_path, <span class="string">'msg'</span>: playbook_path + <span class="string">' playbook have syntax error'</span>, <span class="string">'flag'</span>: <span class="keyword">False</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> code, results</span><br><span class="line">        <span class="comment"># except Exception as e:</span></span><br><span class="line">        <span class="comment">#    return False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ANS = AnsRunner()</span><br><span class="line">    ret=ANS.run_ad_hoc(host_list=<span class="string">'*'</span>, module_name=<span class="string">'shell'</span>, module_args=<span class="string">'ls'</span>)</span><br><span class="line">    <span class="comment">#ret=ANS.get_cmdb_info(host_list='*')</span></span><br><span class="line">    <span class="comment">#print(ret)</span></span><br><span class="line">    print(ANS.run_playbook(playbook_path=[<span class="string">'/data/Playbook/install_jdk18.yaml'</span>],</span><br><span class="line">                     extra_vars=&#123;<span class="string">"remote_server"</span>: <span class="string">"*"</span>&#125;))</span><br></pre></td></tr></table></figure></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/18/Ansible模块中核心类（附执行剧本实例代码）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-18 </div>
			<div class="article-title"><a href="/2019/02/18/Docker如何推送镜像到Harbor？/">Docker如何推送镜像到Harbor？</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="登录">登录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 harbor]# docker login -u admin -p Harbor12345  http://10.80.80.251</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">Error response from daemon: Get https://10.80.80.251/v2/: read tcp 10.80.80.251:50374-&gt;10.80.80.251:443: read: connection reset by peer</span><br></pre></td></tr></table></figure>
<h6 id="原因如下：">原因如下：</h6><p>docker 默认使用https（生产建议走生产带证书域名），如果仓库使用了http，则要修改下Docker的配置:/etc/docker/daemon.json, 添加参数insecure-registries:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 harbor]#  cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  "registry-mirrors": ["https://v5d7kh0f.mirror.aliyuncs.com"],</span><br><span class="line">  "insecure-registries": ["10.80.80.251"]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启docker</span></span><br><span class="line">[root@node1 harbor]# systemctl restart docker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启后登录</span></span><br><span class="line">[root@node1 harbor]# docker login -u admin -p Harbor12345  http://10.80.80.251</span><br><span class="line">WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure></p>
<h3 id="查看镜像列表">查看镜像列表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 harbor]# docker images</span><br><span class="line">REPOSITORY                                                                         TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line"></span><br><span class="line">gcr.io/google_containers/cluster-proportional-autoscaler-amd64                     1.3.0               33813c948942        3 months ago        45.8MB</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/ringtail/cluster-proportional-autoscaler-amd64   v1.3.0              33813c948942        3 months ago        45.8MB</span><br><span class="line">cr.io/google_containers/cluster-proportional-autoscaler-amd64                      1.3.0               33813c948942        3 months ago        45.8MB</span><br><span class="line">google_containers/cluster-proportional-autoscaler-amd64                            1.3.0               33813c948942        3 months ago        45.8MB</span><br></pre></td></tr></table></figure>
<p>例如需要把 registry.cn-hangzhou.aliyuncs.com/google_containers/cluster-proportional-autoscaler-amd64 上传到horbar仓库，则步操如下：</p>
<h4 id="1、打tag">1、打tag</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/ringtail/cluster-proportional-autoscaler-amd64:v1.3.0 10.80.80.251/google_containers/cluster-proportional-autoscaler-amd64:1.3.0</span><br></pre></td></tr></table></figure>
<h4 id="2、登录">2、登录</h4><p>看开头上文</p>
<h4 id="3、PUSH(需要提前在Horbar新增项目google_containers)">3、PUSH(需要提前在Horbar新增项目google_containers)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 harbor]# docker push   10.80.80.251/google_containers/cluster-proportional-autoscaler-amd64:1.3.0</span><br><span class="line">The push refers to repository [10.80.80.251/google_containers/cluster-proportional-autoscaler-amd64]</span><br><span class="line">a636ea940e54: Pushed </span><br><span class="line">1.3.0: digest: sha256:4fd37c5b29a38b02c408c56254bd1a3a76f3e236610bc7a8382500bbf9ecfc76 size: 528</span><br></pre></td></tr></table></figure>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/18/Docker如何推送镜像到Harbor？/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-18 </div>
			<div class="article-title"><a href="/2019/02/18/如何搭建高可用Docker-Harbor仓库/">如何搭建高可用Docker Harbor仓库</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="一、首先探究Docker仓库分类?">一、首先探究Docker仓库分类?</h3><ul>
<li>1、公有仓库(docker hub、阿里云仓库、网易云仓库等)</li>
<li>2、私有仓库(harbor、docker-registry)</li>
</ul>
<p>Docker-registry是官方提供的工具，可以用于构建私有的镜像仓库。Harbor是由VMware团队负责开发的开源企业级Docker Registry，</p>
<h3 id="二、What_is_Harbor?">二、What is Harbor?</h3><blockquote>
<p>Harbor is an open source cloud native registry that stores, signs, and scans container images for vulnerabilities.</p>
<p>Harbor solves common challenges by delivering trust, compliance, performance, and interoperability. It fills a gap for organizations and applications that cannot use a public or cloud-based registry, or want a consistent experience across clouds.</p>
</blockquote>
<h3 id="三、首先介绍下Horbar组件">三、首先介绍下Horbar组件</h3><p> <img src="/img/201902/harbor01.png" style="width: 550x;"></p>
<p>如上图所示，Harbor包含6个组件：</p>
<ul>
<li><p><strong>Proxy：</strong> Harbor的组件，例如注册表，UI和令牌服务，都在反向代理之后。代理将来自浏览器和Docker客户端的请求转发给各种后端服务。</p>
</li>
<li><p><strong>Registry：</strong> 负责存储Docker镜像和处理Docker pull/push命令。由于Harbor需要对图像强制实施访问控制，因此Registry会将客户端定向到token，以获取每个pull/push有效的token。</p>
</li>
<li><p><strong>Core services：</strong> horbar的核心功能，主要提供以下服务：</p>
<ul>
<li>UI： 一个图形用户界面，用于帮助用户管理Registry;</li>
<li>Webhook: 是一种在Registry中配置的机制，因此可以将Registry中的图像状态更改填充到Harbor的Webhook端点。Harbor使用webhook更新日志，启动复制和其他一些功能;</li>
<li>Token：负责根据用户的项目角色为每个docker push / pull命令发出令牌。如果从Docker客户端发送的请求中没有令牌，则注册表会将请求重定向到令牌服务；</li>
</ul>
</li>
<li><p><strong>Database：</strong> 数据库存储项目，用户，角色，复制策略和图像的元数据。</p>
</li>
<li><p><strong>Job services：</strong> 用于图像复制，本地图像可以复制（同步）到其他Harbor实例。</p>
</li>
<li><p><strong>Log collector：</strong> 负责收集其他模块的日志。</p>
</li>
</ul>
<h3 id="四、Docker登陆过程">四、Docker登陆过程</h3><p> <img src="/img/201902/harbor02.png" style="width: 550x;"></p>
<ul>
<li><p>（a）通过端口80监听的代理容器接收该请求。容器中的Nginx将请求转发给后端的Registry容器。</p>
</li>
<li><p>（b）注册表容器已配置为基于token的身份验证，如果验证失败将会返回错误代码401，通知Docker客户端从指定的URL获取有效token。在Harbor中，此URL指向Core Services的token服务;</p>
</li>
<li><p>（c）当Docker客户端收到错误代码时，它会向token服务URL发送请求，根据HTTP规范的基本身份验证在请求头中带上用户名和密码;</p>
</li>
<li><p>（d）在通过端口80将该请求发送到代理容器之后，Nginx再次根据预先配置的规则将请求转发到UI容器。UI容器内的token服务接收请求，解码请求并获取用户名和密码;</p>
</li>
<li><p>（e）获取用户名和密码后，token服务检查数据库并通过MySql数据库中的数据对用户进行身份验证。为LDAP / AD身份验证配置token服务时，它将向外部LDAP / AD服务器发起请求进行身份验证。身份验证成功后，token服务将返回指示成功的HTTP代码。HTTP响应主体包含由私钥生成的token。</p>
</li>
</ul>
<h3 id="五、Harbor高可用方案有哪些？">五、Harbor高可用方案有哪些？</h3><blockquote>
<p>在日常维护中，仓库对于我们来说，可谓十分重要。当生产仓库当宕机后，而不能快速恢复时候，对开发和业务影响甚大，建议在日常运维中采取相对高可用方案，最起码保证数不会丢失。</p>
<h4 id="Harbor高可用可包括以下方案：">Harbor高可用可包括以下方案：</h4><ul>
<li>多实例共享后端存储(采取挂载文件系统方式)<br><img src="/img/201902/harbor03.png" style="width: 550x;"></li>
</ul>
</blockquote>
<ul>
<li>多实例相互数据同步(基于镜像复制模式)</li>
</ul>
<h3 id="六、Horbar安装与配置">六、Horbar安装与配置</h3><h4 id="6-1、安装方式">6.1、安装方式</h4><ul>
<li><strong>在线下载安装：</strong> 安装程序从Docker hub下载Harbor的镜像</li>
<li><strong>离线脱机安装：</strong> 当主机不能上网时候可使用此安装程序</li>
</ul>
<p>建议使用最新稳定版离线脱机安装，相关程序包下载地址为：<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a></p>
<blockquote>
<p>基础环境</p>
<ul>
<li><strong>系统版本：</strong> CentOS Linux release 7.4.1708 (Core)</li>
<li><strong>Harbor版本：</strong> harbor-offline-installer-v1.7.1.tgz</li>
</ul>
</blockquote>
<p>注意：安装前需要安装Compose</p>
<h4 id="6-2、在Linux系统上安装Compose">6.2、在Linux系统上安装Compose</h4><h5 id="6-2-1_运行此命令以下载最新版本的Docker_Compose：">6.2.1 运行此命令以下载最新版本的Docker Compose：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L "https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<h5 id="6-2-2_对二进制文件应用可执行权限：">6.2.2 对二进制文件应用可执行权限：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果docker-compose安装后命令失败，请检查路径。您还可以创建/usr/bin路径中的符号链接或任何其他目录。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-compose <span class="regexp">/usr/</span>bin<span class="regexp">/docker-compose</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="6-2-3_验证：">6.2.3 验证：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 harbor]# docker-compose version </span><br><span class="line">docker-compose version 1.23.2, build 1110ad01</span><br><span class="line">docker-py version: 3.6.0</span><br><span class="line">CPython version: 3.6.7</span><br><span class="line">OpenSSL version: OpenSSL 1.1.0f  25 May 2017</span><br></pre></td></tr></table></figure>
<h4 id="6-3_配置参数">6.3 配置参数</h4><p>horbar配置参数位于文件harbor.cfg中，在harbor.cfg中有两类参数，</p>
<ul>
<li><strong>必需参数：</strong> 需要在配置文件中设置这些参数。如果用户更新它们harbor.cfg并运行install.sh脚本以重新安装Harbor，它们将生效。</li>
<li><strong>可选参数：</strong> 这些参数对于更新是可选的，即用户可以将它们保留为默认值，并在启动Harbour后在Web Portal上更新它们。如果它们已经启用harbor.cfg，它们只会在首次启动Harbour时生效。harbor.cfg将忽略对这些参数的后续更新。</li>
</ul>
<p>重要的几个参数（如需要用到其它参数可以参考官方文档）</p>
<ul>
<li><strong>hostname：</strong> 目标主机的主机名，不建议使用localhost或127.0.0.1作为主机名 </li>
<li><strong>ui_url_protocol：</strong> 访问使用协议为http或https,默认为http</li>
<li><strong>db_password：</strong> 用于db_auth的PostgreSQL数据库的root密码</li>
<li><strong>max_job_workers：</strong> (默认值为10）作业服务中的最大复制工作数</li>
<li><strong>ssl_cert：</strong> SSL证书的路径，仅在协议设置为https时应用</li>
<li><strong>ssl_cert_key：</strong> SSL密钥的路径，仅在协议设置为https时应用</li>
<li><strong>harbor_admin_password：</strong> 管理员的初始密码。此密码仅在Harbor首次启动时生效。之后，将忽略此设置，并且应在Portal中设置管理员密码。请注意，默认用户名/密码为admin / Harbor12345</li>
<li><strong>auth_mode：</strong> 使用的身份验证类型。默认情况下，它是db_auth</li>
</ul>
<h4 id="6-4_安装harbor">6.4 安装harbor</h4><h5 id="6-4-1_推荐离线安装">6.4.1 推荐离线安装</h5><h6 id="下载程序包：https://github-com/goharbor/harbor/releases">下载程序包：<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a></h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.1.tgz</span><br></pre></td></tr></table></figure>
<h6 id="建议使用https增加安全性">建议使用https增加安全性</h6><p>由于Harbor未附带任何证书，因此默认情况下使用HTTP来提供注册表请求。但是，强烈建议为任何生产环境启用安全性。Harbor有一个Nginx实例作为所有服务的反向代理，您可以使用prepare脚本配置Nginx以启用https。</p>
<p>在测试或开发环境中，您可以选择使用自签名证书，而不是来自受信任的第三方CA的证书。以下内容将向您展示如何创建自己的CA，并使用您的CA签署服务器证书和客户端证书。</p>
<h6 id="获得证书授权">获得证书授权</h6><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.<span class="type">key</span> <span class="number">4096</span></span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days <span class="number">3650</span> \</span><br><span class="line">  -subj <span class="string">"/C=TW/ST=Taipei/L=Taipei/O=example/OU=Personal/CN=yourdomain.com"</span> \</span><br><span class="line">  -<span class="type">key</span> ca.<span class="type">key</span> \</span><br><span class="line">  -out ca.crt</span><br></pre></td></tr></table></figure>
<h5 id="获得服务器证书">获得服务器证书</h5><p>假设您的注册表的主机名是yourdomain.com，并且其DNS记录指向您正在运行Harbor的主机。在生产环境中，您首先应该从CA获得证书。在测试或开发环境中，您可以使用自己的CA. 证书通常包含.crt文件和.key文件，例如yourdomain.com.crt和yourdomain.com.key。</p>
<ul>
<li><p>1）创建自己的私钥：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out yourdomain<span class="selector-class">.com</span><span class="selector-class">.key</span> <span class="number">4096</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2）生成证书签名请求：</p>
</li>
</ul>
<p>如果您使用像yourdomain.com这样的FQDN 连接注册表主机，那么您必须使用yourdomain.com作为CN（通用名称）。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl req -sha512 -new \</span><br><span class="line">  -subj <span class="string">"/C=TW/ST=Taipei/L=Taipei/O=example/OU=Personal/CN=yourdomain.com"</span> \</span><br><span class="line">  -key yourdomain<span class="selector-class">.com</span><span class="selector-class">.key</span> \</span><br><span class="line">  -out yourdomain<span class="selector-class">.com</span><span class="selector-class">.csr</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>3）生成注册表主机的证书：</li>
</ul>
<p>无论您是使用类似yourdomain.com的 FQDN 还是IP来连接注册表主机，请运行此命令以生成符合主题备用名称（SAN）和x509 v3扩展要求的注册表主机证书：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; v3<span class="selector-class">.ext</span> &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth </span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.<span class="number">1</span>=yourdomain.com</span><br><span class="line">DNS.<span class="number">2</span>=yourdomain</span><br><span class="line">DNS.<span class="number">3</span>=hostname</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">  openssl x509 -req -sha512 -days <span class="number">3650</span> \</span><br><span class="line">    -extfile v3<span class="selector-class">.ext</span> \</span><br><span class="line">    -CA ca<span class="selector-class">.crt</span> -CAkey ca<span class="selector-class">.key</span> -CAcreateserial \</span><br><span class="line">    -<span class="keyword">in</span> yourdomain<span class="selector-class">.com</span><span class="selector-class">.csr</span> \</span><br><span class="line">    -out yourdomain<span class="selector-class">.com</span><span class="selector-class">.crt</span></span><br></pre></td></tr></table></figure>
<h5 id="6-4-2_配置harbor">6.4.2 配置harbor</h5><p>复制证书和密钥(建议使用外网域名购买的证书,docker pull/push 默认走https)<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp yourdomain<span class="selector-class">.com</span><span class="selector-class">.crt</span> /data/cert/</span><br><span class="line">cp yourdomain<span class="selector-class">.com</span><span class="selector-class">.key</span> /data/cert/</span><br></pre></td></tr></table></figure></p>
<p>修改配置文件<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostname</span> = <span class="number">192.168</span>.<span class="number">0.6</span></span><br><span class="line"><span class="attr">ui_url_protocol</span> = https</span><br><span class="line"><span class="attr">ssl_cert</span> = /data/cert/yourdomain.com.crt</span><br><span class="line"><span class="attr">ssl_cert_key</span> = /data/cert/yourdomain.com.key</span><br></pre></td></tr></table></figure></p>
<p>为Harbor生成配置文件<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="built_in">prepare</span></span><br></pre></td></tr></table></figure></p>
<p>安装harbor<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="keyword">install</span>.sh</span><br></pre></td></tr></table></figure></p>
<p>如果安装过程出现以下错误，请确认Docker Compose是否安装成功！<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">✖ Need to install docker-compose(1.7.1+) by yourself first and run this script again.</span><br></pre></td></tr></table></figure></p>
<h5 id="6-4-3_如外接pg配置，新版暂时不支持mysql（https://github-com/goharbor/harbor/issues/6534_）">6.4.3 如外接pg配置，新版暂时不支持mysql（<a href="https://github.com/goharbor/harbor/issues/6534" target="_blank" rel="noopener">https://github.com/goharbor/harbor/issues/6534</a> ）</h5><h5 id="harbor-cfg配置如下：">harbor.cfg配置如下：</h5><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db_host</span> = <span class="number">192.168</span>.<span class="number">32.18</span></span><br><span class="line"><span class="attr">db_password</span> = password</span><br><span class="line"><span class="attr">db_port</span> = <span class="number">5432</span></span><br><span class="line"><span class="attr">db_user</span> = harbor</span><br></pre></td></tr></table></figure>
<h6 id="安装和配置">安装和配置</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> https://download.postgresql.org/pub/repos/yum/<span class="number">10</span>/redhat/rhel<span class="number">-7</span>-x86_64/pgdg-centos10<span class="number">-10</span><span class="number">-1.</span>noarch.rpm</span><br><span class="line"><span class="comment">#安装客户端</span></span><br><span class="line">yum <span class="keyword">install</span> postgresql10</span><br><span class="line"><span class="comment">#安装服务端</span></span><br><span class="line">yum <span class="keyword">install</span> postgresql10-<span class="keyword">server</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化和启动</span></span><br><span class="line">postgresql-setup initdb</span><br><span class="line">systemctl <span class="keyword">enable</span> postgresql.service</span><br><span class="line">systemctl <span class="keyword">start</span> postgresql.service</span><br></pre></td></tr></table></figure>
<p>具体可参考：<a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">https://www.postgresql.org/download/linux/redhat/</a></p>
<h6 id="创建用户和数据库">创建用户和数据库</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE registry;</span><br><span class="line">CREATE USER harbor  WITH PASSWORD 'password';</span><br><span class="line">CREATE DATABASE registry OWNER harbor;</span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE registry to harbor;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 postgresql.conf</span></span><br><span class="line">listen_addresses = '*'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改pg_hba.conf</span></span><br><span class="line">host  all  all 0.0.0.0/0 md5</span><br></pre></td></tr></table></figure>
<h5 id="踩坑记录">踩坑记录</h5><h6 id="踩坑之一：用户界面无法登陆">踩坑之一：用户界面无法登陆</h6><p>解决：<br>1、docker ps 发现harbor-adminserver 不断重启<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bf880eb451cd </span>       goharbor/harbor-adminserver:<span class="built_in">v1</span>.<span class="number">7</span>.<span class="number">1</span>       <span class="string">"/harbor/start.sh"</span>       <span class="number">48</span> seconds ago      Restarting (<span class="number">1</span>) <span class="number">17</span> secons ago                                                                         harbor-adminserver</span><br></pre></td></tr></table></figure></p>
<p>2、查看日志发现以下<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Jan</span> <span class="selector-tag">30</span> <span class="selector-tag">08</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29</span> <span class="selector-tag">172</span><span class="selector-class">.22</span><span class="selector-class">.0</span><span class="selector-class">.1</span> <span class="selector-tag">adminserver</span><span class="selector-attr">[64872]</span>: <span class="selector-tag">2019-01-30T00</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29Z</span> <span class="selector-attr">[INFO]</span> <span class="selector-tag">the</span> <span class="selector-tag">path</span> <span class="selector-tag">of</span> <span class="selector-tag">key</span> <span class="selector-tag">used</span> <span class="selector-tag">by</span> <span class="selector-tag">key</span> <span class="selector-tag">provider</span>: /<span class="selector-tag">etc</span>/<span class="selector-tag">adminserverkey</span></span><br><span class="line"><span class="selector-tag">Jan</span> <span class="selector-tag">30</span> <span class="selector-tag">08</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29</span> <span class="selector-tag">172</span><span class="selector-class">.22</span><span class="selector-class">.0</span><span class="selector-class">.1</span> <span class="selector-tag">adminserver</span><span class="selector-attr">[64872]</span>: <span class="selector-tag">2019-01-30T00</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29Z</span> <span class="selector-attr">[FATAL]</span> <span class="selector-attr">[main.go:45]</span>: <span class="selector-tag">failed</span> <span class="selector-tag">to</span> <span class="selector-tag">initialize</span> <span class="selector-tag">the</span> <span class="selector-tag">system</span>: <span class="selector-tag">read</span> /<span class="selector-tag">tc</span>/<span class="selector-tag">adminserver</span>/<span class="selector-tag">key</span>: <span class="selector-tag">is</span> <span class="selector-tag">a</span> <span class="selector-tag">directory</span></span><br></pre></td></tr></table></figure></p>
<p>3、由于修改了secretkey_path in harbor.cfg，并没有更改docker-compose.yml配置导致，修改后docker-compose.yml执行以下命令即可：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="meta">down</span></span><br><span class="line">./prepare</span><br><span class="line">docker-compose <span class="meta">up</span> -d</span><br></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/goharbor/harbor/wiki/Architecture-Overview-of-Harbor" target="_blank" rel="noopener">https://github.com/goharbor/harbor/wiki/Architecture-Overview-of-Harbor</a></li>
<li><a href="https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="noopener">https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md</a></li>
<li><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">https://www.postgresql.org/download/linux/redhat/</a></li>
<li><a href="https://github.com/goharbor/harbor/issues/6534" target="_blank" rel="noopener">https://github.com/goharbor/harbor/issues/6534</a></li>
</ul>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/18/如何搭建高可用Docker-Harbor仓库/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-17 </div>
			<div class="article-title"><a href="/2019/02/17/Python调用Jenkins-api-文档/">Python调用Jenkins api 文档</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="1、引言：">1、引言：</h3><p>现阶段大部分公司，在日常运维中使用jenkins频率还是相对多，今天我们简单探讨下jenkins api的使用。</p>
<h3 id="2、Python库">2、Python库</h3><h4 id="2-1、python-jenkins">2.1、python-jenkins</h4><p>python-jenkins官方链接：<br><a href="http://python-jenkins.readthedocs.io/en/latest/examples.html#example-1-get-version-of-jenkins" target="_blank" rel="noopener">http://python-jenkins.readthedocs.io/en/latest/examples.html#example-1-get-version-of-jenkins</a></p>
<h4 id="2-2、jenkinsapi">2.2、jenkinsapi</h4><p>jenkinsapi 官方链接：<br><a href="https://pypi.org/project/jenkinsapi/#description" target="_blank" rel="noopener">https://pypi.org/project/jenkinsapi/#description</a></p>
<h3 id="3、python-jenkins库">3、python-jenkins库</h3><h4 id="3-1安装">3.1安装</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install </span>python-<span class="keyword">jenkins</span></span><br><span class="line"><span class="keyword"># </span>或者</span><br><span class="line">easy_install python-<span class="keyword">jenkins</span></span><br></pre></td></tr></table></figure>
<h3 id="3-2案例">3.2案例</h3><h4 id="3-2-1_获取版本号">3.2.1 获取版本号</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import jenkins </span><br><span class="line"><span class="keyword">server</span> = jenkins.Jenkins(<span class="string">'http://localhost:8080'</span>, username=<span class="string">'admin'</span>, password=<span class="string">'admin'</span>) </span><br><span class="line">user = <span class="keyword">server</span>.get_whoami() </span><br><span class="line">version = <span class="keyword">server</span>.get_version() </span><br><span class="line">print(<span class="string">'Hello %s from Jenkins %s'</span> % (user[<span class="string">'fullName'</span>], version))</span><br></pre></td></tr></table></figure>
<p>3.2.2 简单API<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line">import jenkins</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jenkins_Api</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>._url=<span class="string">'http://192.168.72.128:8080'</span></span><br><span class="line">        <span class="keyword">self</span>._username=<span class="string">"admin"</span></span><br><span class="line">        <span class="keyword">self</span>._password=<span class="string">"admin"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        server=jenkins.Jenkins(<span class="keyword">self</span>._url, username=<span class="keyword">self</span>._username, password=<span class="keyword">self</span>._password)</span><br><span class="line">        user=server.get_whoami()</span><br><span class="line">        <span class="keyword">return</span> server</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_version</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_version()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_jobs</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">"jobs_count"</span><span class="symbol">:self</span>.get_server_instance().jobs_count(),</span><br><span class="line">             <span class="string">"get_jobs"</span><span class="symbol">:self</span>.get_server_instance().get_jobs()&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_job</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().create_job(job_name)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_job_confing</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_job_config(job_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_job</span><span class="params">(<span class="keyword">self</span>,job_name,new_job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().copy_job(job_name,new_job_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_job</span><span class="params">(<span class="keyword">self</span>,job_name,parameters=None,)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().build_job(job_name,parameters=parameters)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_build</span><span class="params">(<span class="keyword">self</span>,job_name,number)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().delete_build(job_name,number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_job_info</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_job_info(<span class="string">'test'</span>)[<span class="string">'lastCompletedBuild'</span>][<span class="string">'number'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_build_info</span><span class="params">(<span class="keyword">self</span>,job_name,number)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_build_info(job_name, number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_build_console_output</span><span class="params">(<span class="keyword">self</span>, job_name, number)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_build_console_output(job_name, number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_view</span><span class="params">(<span class="keyword">self</span>,view_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().create_view(view_name,config_xml=jenkins.EMPTY_VIEW_CONFIG_XML)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_views</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_views()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span>==<span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    print(Jenkins_Api().get_views())</span><br><span class="line">    <span class="comment"># print(Jenkins_Api().get_build_console_output(job_name='test',number=7))</span></span><br><span class="line">    print(Jenkins_Api().build_job(job_name=<span class="string">'test'</span>,parameters=&#123;<span class="string">"Branch"</span><span class="symbol">:<span class="string">"origin/master"</span></span>&#125;))</span><br></pre></td></tr></table></figure></p>
<h3 id="4、jenkinsapi库">4、jenkinsapi库</h3><h4 id="4-1安装">4.1安装</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install </span>python-<span class="keyword">jenkins</span></span><br><span class="line"><span class="keyword"># </span>或者</span><br><span class="line">easy_install python-<span class="keyword">jenkins</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2案例">4.2案例</h3><h4 id="4-2-1获取版本号">4.2.1获取版本号</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import jenkinsapi</span><br><span class="line">from jenkinsapi<span class="selector-class">.jenkins</span> import Jenkins</span><br><span class="line">J=Jenkins(<span class="string">'http://192.168.72.128:8080'</span>,username=<span class="string">"admin"</span>,password=<span class="string">"admin"</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(J.version)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="4-2-2_获取Job详细输出">4.2.2 获取Job详细输出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Jenkins server</span><br><span class="line"><span class="keyword">from</span> jenkinsapi.jenkins <span class="keyword">import</span> Jenkins</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">()</span>:</span></span><br><span class="line">    jenkins_url = <span class="string">'http://jenkins_host:8080'</span></span><br><span class="line">    server = Jenkins(<span class="string">'http://192.168.72.128:8080'</span>,username=<span class="string">"admin"</span>,password=<span class="string">"admin"</span>)</span><br><span class="line">    <span class="keyword">return</span> server</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_job_details</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Refer Example #1 for definition of function 'get_server_instance'</span></span><br><span class="line">    server = get_server_instance()</span><br><span class="line">    <span class="keyword">for</span> job_name, job_instance <span class="keyword">in</span> server.get_jobs():</span><br><span class="line">        print(<span class="string">"-"</span>*<span class="number">20</span>)</span><br><span class="line">        print(<span class="string">'Job Name:%s'</span> % (job_instance.name))</span><br><span class="line">        print(<span class="string">'Job Description:%s'</span> % (job_instance.get_description()))</span><br><span class="line">        print(<span class="string">'Is Job running:%s'</span> % (job_instance.is_running()))</span><br><span class="line">        print(<span class="string">'Is Job enabled:%s'</span> % (job_instance.is_enabled()))</span><br></pre></td></tr></table></figure>
<h4 id="4-2-3_获取最新构建输出">4.2.3 获取最新构建输出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jenkinsapi</span><br><span class="line"><span class="keyword">from</span> jenkinsapi.jenkins <span class="keyword">import</span> Jenkins</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">()</span>:</span></span><br><span class="line">    jenkins_url = <span class="string">'http://jenkins_host:8080'</span></span><br><span class="line">    server = Jenkins(<span class="string">'http://192.168.72.128:8080'</span>,username=<span class="string">"admin"</span>,password=<span class="string">"admin"</span>)</span><br><span class="line">    <span class="keyword">return</span> server</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_console</span><span class="params">()</span>:</span></span><br><span class="line">    server = get_server_instance()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> server.keys():</span><br><span class="line">        print(server[i].get_last_completed_build().get_console())</span><br></pre></td></tr></table></figure>
<h4 id="4-2-4_简单API">4.2.4 简单API</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from jenkinsapi.jenkins import Jenkins</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jenkins_Api</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>._url=<span class="string">'http://192.168.72.128:8080'</span></span><br><span class="line">        <span class="keyword">self</span>._username=<span class="string">"admin"</span></span><br><span class="line">        <span class="keyword">self</span>._password=<span class="string">"admin"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        server = Jenkins(<span class="keyword">self</span>._url, username=<span class="keyword">self</span>._username, password=<span class="keyword">self</span>._password)</span><br><span class="line">        <span class="keyword">return</span> server</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_version</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">self</span>.get_server_instance().version</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_job_last_console</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        data=&#123;</span><br><span class="line">                <span class="string">'time'</span>: str(<span class="keyword">self</span>.get_server_instance()[job_name].get_last_completed_build().get_timestamp()),</span><br><span class="line">                <span class="string">'status'</span><span class="symbol">:self</span>.get_server_instance()[job_name].get_last_completed_build().get_status(),</span><br><span class="line">                 <span class="string">'res'</span><span class="symbol">:self</span>.get_server_instance()[job_name].get_last_completed_build().get_console()</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">        <span class="comment">#return json.dumps(data)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span>==<span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    print(Jenkins_Api().get_job_last_console(job_name=<span class="string">'test'</span>))</span><br></pre></td></tr></table></figure>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/17/Python调用Jenkins-api-文档/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div class="widget tag">
    <h3 class="title">归档</h3>
    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">2020年02月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">2019年03月</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">2019年02月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">2018年07月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">2018年06月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">2018年05月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">2018年03月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">2018年02月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">2018年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">2017年11月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">2017年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">2017年08月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">2017年07月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">2017年03月</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">2017年02月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">2016年01月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">2015年12月</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">2015年11月</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">2015年10月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">2015年09月</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">2015年08月</a><span class="archive-list-count">5</span></li></ul>
  </div>

		
			
		
			

		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2020/02/13/小公司如何优雅地推进应用上Kubernetes容器云/"><i class="fa fa-file-o"></i>小公司如何优雅地推进应用上Kubernetes容器云</a>
      </li>
    
      <li>
        <a href="/2019/03/24/使用非root用户操作Docker/"><i class="fa fa-file-o"></i>使用非root用户操作Docker</a>
      </li>
    
      <li>
        <a href="/2019/03/24/如何进入Docker容器和Pod？/"><i class="fa fa-file-o"></i>如何进入Docker容器和Pod？</a>
      </li>
    
      <li>
        <a href="/2019/03/24/如何解决The-connection-to-the-server-localhost8080-was-refused》？/"><i class="fa fa-file-o"></i>如何解决The connection to the s...</a>
      </li>
    
      <li>
        <a href="/2019/03/03/python-cStringIO模块-附生成excel并发送邮件实例/"><i class="fa fa-file-o"></i>python cStringIO模块( 附生成exce...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://linuxops.cc" title="Macro博客" target="_blank" ]);">Macro博客</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.uinion.com/" title="uinion小站" target="_blank" ]);">uinion小站</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2020 林文杰
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'ZP2ZSuHgipSZfRyU8uTR','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'linuxunix' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
