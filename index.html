<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>BY DevOps | 今晚打老虎</title>
  <meta name="author" content="林文杰">
  
  <meta name="description" content="DevOps 技术运维小学生">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="BY DevOps | 今晚打老虎">

  
    <meta property="og:image" content="undefined">
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>
</html>
 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">BY DevOps | 今晚打老虎</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1>记录Linux的点点滴滴（DevOps技术运维小学生）</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Welcome to my blog.
</div>    

		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-18 </div>
			<div class="article-title"><a href="/2019/02/18/如何搭建高可用Docker-Harbor仓库/">如何搭建高可用Docker Harbor仓库</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="一、首先探究Docker仓库分类?">一、首先探究Docker仓库分类?</h3><ul>
<li>1、公有仓库(docker hub、阿里云仓库、网易云仓库等)</li>
<li>2、私有仓库(harbor、docker-registry)</li>
</ul>
<p>Docker-registry是官方提供的工具，可以用于构建私有的镜像仓库。Harbor是由VMware团队负责开发的开源企业级Docker Registry，</p>
<h3 id="二、What_is_Harbor?">二、What is Harbor?</h3><blockquote>
<p>Harbor is an open source cloud native registry that stores, signs, and scans container images for vulnerabilities.</p>
<p>Harbor solves common challenges by delivering trust, compliance, performance, and interoperability. It fills a gap for organizations and applications that cannot use a public or cloud-based registry, or want a consistent experience across clouds.</p>
</blockquote>
<h3 id="三、首先介绍下Horbar组件">三、首先介绍下Horbar组件</h3><p> <img src="/img/201902/harbor01.png" style="width: 550x;"></p>
<p>如上图所示，Harbor包含6个组件：</p>
<ul>
<li><p><strong>Proxy：</strong> Harbor的组件，例如注册表，UI和令牌服务，都在反向代理之后。代理将来自浏览器和Docker客户端的请求转发给各种后端服务。</p>
</li>
<li><p><strong>Registry：</strong> 负责存储Docker镜像和处理Docker pull/push命令。由于Harbor需要对图像强制实施访问控制，因此Registry会将客户端定向到token，以获取每个pull/push有效的token。</p>
</li>
<li><p><strong>Core services：</strong> horbar的核心功能，主要提供以下服务：</p>
<ul>
<li>UI： 一个图形用户界面，用于帮助用户管理Registry;</li>
<li>Webhook: 是一种在Registry中配置的机制，因此可以将Registry中的图像状态更改填充到Harbor的Webhook端点。Harbor使用webhook更新日志，启动复制和其他一些功能;</li>
<li>Token：负责根据用户的项目角色为每个docker push / pull命令发出令牌。如果从Docker客户端发送的请求中没有令牌，则注册表会将请求重定向到令牌服务；</li>
</ul>
</li>
<li><p><strong>Database：</strong> 数据库存储项目，用户，角色，复制策略和图像的元数据。</p>
</li>
<li><p><strong>Job services：</strong> 用于图像复制，本地图像可以复制（同步）到其他Harbor实例。</p>
</li>
<li><p><strong>Log collector：</strong> 负责收集其他模块的日志。</p>
</li>
</ul>
<h3 id="四、Docker登陆过程">四、Docker登陆过程</h3><p> <img src="/img/201902/harbor02.png" style="width: 550x;"></p>
<ul>
<li><p>（a）通过端口80监听的代理容器接收该请求。容器中的Nginx将请求转发给后端的Registry容器。</p>
</li>
<li><p>（b）注册表容器已配置为基于token的身份验证，如果验证失败将会返回错误代码401，通知Docker客户端从指定的URL获取有效token。在Harbor中，此URL指向Core Services的token服务;</p>
</li>
<li><p>（c）当Docker客户端收到错误代码时，它会向token服务URL发送请求，根据HTTP规范的基本身份验证在请求头中带上用户名和密码;</p>
</li>
<li><p>（d）在通过端口80将该请求发送到代理容器之后，Nginx再次根据预先配置的规则将请求转发到UI容器。UI容器内的token服务接收请求，解码请求并获取用户名和密码;</p>
</li>
<li><p>（e）获取用户名和密码后，token服务检查数据库并通过MySql数据库中的数据对用户进行身份验证。为LDAP / AD身份验证配置token服务时，它将向外部LDAP / AD服务器发起请求进行身份验证。身份验证成功后，token服务将返回指示成功的HTTP代码。HTTP响应主体包含由私钥生成的token。</p>
</li>
</ul>
<h3 id="五、Harbor高可用方案有哪些？">五、Harbor高可用方案有哪些？</h3><blockquote>
<p>在日常维护中，仓库对于我们来说，可谓十分重要。当生产仓库当宕机后，而不能快速恢复时候，对开发和业务影响甚大，建议在日常运维中采取相对高可用方案，最起码保证数不会丢失。</p>
<h4 id="Harbor高可用可包括以下方案：">Harbor高可用可包括以下方案：</h4><ul>
<li>多实例共享后端存储(采取挂载文件系统方式)<br><img src="/img/201902/harbor03.png" style="width: 550x;"></li>
</ul>
</blockquote>
<ul>
<li>多实例相互数据同步(基于镜像复制模式)</li>
</ul>
<h3 id="六、Horbar安装与配置">六、Horbar安装与配置</h3><h4 id="6-1、安装方式">6.1、安装方式</h4><ul>
<li><strong>在线下载安装：</strong> 安装程序从Docker hub下载Harbor的镜像</li>
<li><strong>离线脱机安装：</strong> 当主机不能上网时候可使用此安装程序</li>
</ul>
<p>建议使用最新稳定版离线脱机安装，相关程序包下载地址为：<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a></p>
<blockquote>
<p>基础环境</p>
<ul>
<li><strong>系统版本：</strong> CentOS Linux release 7.4.1708 (Core)</li>
<li><strong>Harbor版本：</strong> harbor-offline-installer-v1.7.1.tgz</li>
</ul>
</blockquote>
<p>注意：安装前需要安装Compose</p>
<h4 id="6-2、在Linux系统上安装Compose">6.2、在Linux系统上安装Compose</h4><h5 id="6-2-1_运行此命令以下载最新版本的Docker_Compose：">6.2.1 运行此命令以下载最新版本的Docker Compose：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L "https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<h5 id="6-2-2_对二进制文件应用可执行权限：">6.2.2 对二进制文件应用可执行权限：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果docker-compose安装后命令失败，请检查路径。您还可以创建/usr/bin路径中的符号链接或任何其他目录。<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>docker-compose <span class="regexp">/usr/</span>bin<span class="regexp">/docker-compose</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h5 id="6-2-3_验证：">6.2.3 验证：</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 harbor]# docker-compose version </span><br><span class="line">docker-compose version 1.23.2, build 1110ad01</span><br><span class="line">docker-py version: 3.6.0</span><br><span class="line">CPython version: 3.6.7</span><br><span class="line">OpenSSL version: OpenSSL 1.1.0f  25 May 2017</span><br></pre></td></tr></table></figure>
<h4 id="6-3_配置参数">6.3 配置参数</h4><p>horbar配置参数位于文件harbor.cfg中，在harbor.cfg中有两类参数，</p>
<ul>
<li><strong>必需参数：</strong> 需要在配置文件中设置这些参数。如果用户更新它们harbor.cfg并运行install.sh脚本以重新安装Harbor，它们将生效。</li>
<li><strong>可选参数：</strong> 这些参数对于更新是可选的，即用户可以将它们保留为默认值，并在启动Harbour后在Web Portal上更新它们。如果它们已经启用harbor.cfg，它们只会在首次启动Harbour时生效。harbor.cfg将忽略对这些参数的后续更新。</li>
</ul>
<p>重要的几个参数（如需要用到其它参数可以参考官方文档）</p>
<ul>
<li><strong>hostname：</strong> 目标主机的主机名，不建议使用localhost或127.0.0.1作为主机名 </li>
<li><strong>ui_url_protocol：</strong> 访问使用协议为http或https,默认为http</li>
<li><strong>db_password：</strong> 用于db_auth的PostgreSQL数据库的root密码</li>
<li><strong>max_job_workers：</strong> (默认值为10）作业服务中的最大复制工作数</li>
<li><strong>ssl_cert：</strong> SSL证书的路径，仅在协议设置为https时应用</li>
<li><strong>ssl_cert_key：</strong> SSL密钥的路径，仅在协议设置为https时应用</li>
<li><strong>harbor_admin_password：</strong> 管理员的初始密码。此密码仅在Harbor首次启动时生效。之后，将忽略此设置，并且应在Portal中设置管理员密码。请注意，默认用户名/密码为admin / Harbor12345</li>
<li><strong>auth_mode：</strong> 使用的身份验证类型。默认情况下，它是db_auth</li>
</ul>
<h4 id="6-4_安装harbor">6.4 安装harbor</h4><h5 id="6-4-1_推荐离线安装">6.4.1 推荐离线安装</h5><h6 id="下载程序包：https://github-com/goharbor/harbor/releases">下载程序包：<a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases</a></h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.1.tgz</span><br></pre></td></tr></table></figure>
<h6 id="建议使用https增加安全性">建议使用https增加安全性</h6><p>由于Harbor未附带任何证书，因此默认情况下使用HTTP来提供注册表请求。但是，强烈建议为任何生产环境启用安全性。Harbor有一个Nginx实例作为所有服务的反向代理，您可以使用prepare脚本配置Nginx以启用https。</p>
<p>在测试或开发环境中，您可以选择使用自签名证书，而不是来自受信任的第三方CA的证书。以下内容将向您展示如何创建自己的CA，并使用您的CA签署服务器证书和客户端证书。</p>
<h6 id="获得证书授权">获得证书授权</h6><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.<span class="type">key</span> <span class="number">4096</span></span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days <span class="number">3650</span> \</span><br><span class="line">  -subj <span class="string">"/C=TW/ST=Taipei/L=Taipei/O=example/OU=Personal/CN=yourdomain.com"</span> \</span><br><span class="line">  -<span class="type">key</span> ca.<span class="type">key</span> \</span><br><span class="line">  -out ca.crt</span><br></pre></td></tr></table></figure>
<h5 id="获得服务器证书">获得服务器证书</h5><p>假设您的注册表的主机名是yourdomain.com，并且其DNS记录指向您正在运行Harbor的主机。在生产环境中，您首先应该从CA获得证书。在测试或开发环境中，您可以使用自己的CA. 证书通常包含.crt文件和.key文件，例如yourdomain.com.crt和yourdomain.com.key。</p>
<ul>
<li><p>1）创建自己的私钥：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out yourdomain<span class="selector-class">.com</span><span class="selector-class">.key</span> <span class="number">4096</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2）生成证书签名请求：</p>
</li>
</ul>
<p>如果您使用像yourdomain.com这样的FQDN 连接注册表主机，那么您必须使用yourdomain.com作为CN（通用名称）。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl req -sha512 -new \</span><br><span class="line">  -subj <span class="string">"/C=TW/ST=Taipei/L=Taipei/O=example/OU=Personal/CN=yourdomain.com"</span> \</span><br><span class="line">  -key yourdomain<span class="selector-class">.com</span><span class="selector-class">.key</span> \</span><br><span class="line">  -out yourdomain<span class="selector-class">.com</span><span class="selector-class">.csr</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>3）生成注册表主机的证书：</li>
</ul>
<p>无论您是使用类似yourdomain.com的 FQDN 还是IP来连接注册表主机，请运行此命令以生成符合主题备用名称（SAN）和x509 v3扩展要求的注册表主机证书：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; v3<span class="selector-class">.ext</span> &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth </span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.<span class="number">1</span>=yourdomain.com</span><br><span class="line">DNS.<span class="number">2</span>=yourdomain</span><br><span class="line">DNS.<span class="number">3</span>=hostname</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">  openssl x509 -req -sha512 -days <span class="number">3650</span> \</span><br><span class="line">    -extfile v3<span class="selector-class">.ext</span> \</span><br><span class="line">    -CA ca<span class="selector-class">.crt</span> -CAkey ca<span class="selector-class">.key</span> -CAcreateserial \</span><br><span class="line">    -<span class="keyword">in</span> yourdomain<span class="selector-class">.com</span><span class="selector-class">.csr</span> \</span><br><span class="line">    -out yourdomain<span class="selector-class">.com</span><span class="selector-class">.crt</span></span><br></pre></td></tr></table></figure>
<h5 id="6-4-2_配置harbor">6.4.2 配置harbor</h5><p>复制证书和密钥(建议使用外网域名购买的证书,docker pull/push 默认走https)<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp yourdomain<span class="selector-class">.com</span><span class="selector-class">.crt</span> /data/cert/</span><br><span class="line">cp yourdomain<span class="selector-class">.com</span><span class="selector-class">.key</span> /data/cert/</span><br></pre></td></tr></table></figure></p>
<p>修改配置文件<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hostname</span> = <span class="number">192.168</span>.<span class="number">0.6</span></span><br><span class="line"><span class="attr">ui_url_protocol</span> = https</span><br><span class="line"><span class="attr">ssl_cert</span> = /data/cert/yourdomain.com.crt</span><br><span class="line"><span class="attr">ssl_cert_key</span> = /data/cert/yourdomain.com.key</span><br></pre></td></tr></table></figure></p>
<p>为Harbor生成配置文件<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="built_in">prepare</span></span><br></pre></td></tr></table></figure></p>
<p>安装harbor<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./<span class="keyword">install</span>.sh</span><br></pre></td></tr></table></figure></p>
<p>如果安装过程出现以下错误，请确认Docker Compose是否安装成功！<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">✖ Need to install docker-compose(1.7.1+) by yourself first and run this script again.</span><br></pre></td></tr></table></figure></p>
<h5 id="6-4-3_如外接pg配置，新版暂时不支持mysql（https://github-com/goharbor/harbor/issues/6534_）">6.4.3 如外接pg配置，新版暂时不支持mysql（<a href="https://github.com/goharbor/harbor/issues/6534" target="_blank" rel="noopener">https://github.com/goharbor/harbor/issues/6534</a> ）</h5><h5 id="harbor-cfg配置如下：">harbor.cfg配置如下：</h5><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db_host</span> = <span class="number">192.168</span>.<span class="number">32.18</span></span><br><span class="line"><span class="attr">db_password</span> = password</span><br><span class="line"><span class="attr">db_port</span> = <span class="number">5432</span></span><br><span class="line"><span class="attr">db_user</span> = harbor</span><br></pre></td></tr></table></figure>
<h6 id="安装和配置">安装和配置</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> https://download.postgresql.org/pub/repos/yum/<span class="number">10</span>/redhat/rhel<span class="number">-7</span>-x86_64/pgdg-centos10<span class="number">-10</span><span class="number">-1.</span>noarch.rpm</span><br><span class="line"><span class="comment">#安装客户端</span></span><br><span class="line">yum <span class="keyword">install</span> postgresql10</span><br><span class="line"><span class="comment">#安装服务端</span></span><br><span class="line">yum <span class="keyword">install</span> postgresql10-<span class="keyword">server</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化和启动</span></span><br><span class="line">postgresql-setup initdb</span><br><span class="line">systemctl <span class="keyword">enable</span> postgresql.service</span><br><span class="line">systemctl <span class="keyword">start</span> postgresql.service</span><br></pre></td></tr></table></figure>
<p>具体可参考：<a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">https://www.postgresql.org/download/linux/redhat/</a></p>
<h6 id="创建用户和数据库">创建用户和数据库</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE registry;</span><br><span class="line">CREATE USER harbor  WITH PASSWORD 'password';</span><br><span class="line">CREATE DATABASE registry OWNER harbor;</span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE registry to harbor;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 postgresql.conf</span></span><br><span class="line">listen_addresses = '*'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改pg_hba.conf</span></span><br><span class="line">host  all  all 0.0.0.0/0 md5</span><br></pre></td></tr></table></figure>
<h5 id="踩坑记录">踩坑记录</h5><h6 id="踩坑之一：用户界面无法登陆">踩坑之一：用户界面无法登陆</h6><p>解决：<br>1、docker ps 发现harbor-adminserver 不断重启<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bf880eb451cd </span>       goharbor/harbor-adminserver:<span class="built_in">v1</span>.<span class="number">7</span>.<span class="number">1</span>       <span class="string">"/harbor/start.sh"</span>       <span class="number">48</span> seconds ago      Restarting (<span class="number">1</span>) <span class="number">17</span> secons ago                                                                         harbor-adminserver</span><br></pre></td></tr></table></figure></p>
<p>2、查看日志发现以下<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Jan</span> <span class="selector-tag">30</span> <span class="selector-tag">08</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29</span> <span class="selector-tag">172</span><span class="selector-class">.22</span><span class="selector-class">.0</span><span class="selector-class">.1</span> <span class="selector-tag">adminserver</span><span class="selector-attr">[64872]</span>: <span class="selector-tag">2019-01-30T00</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29Z</span> <span class="selector-attr">[INFO]</span> <span class="selector-tag">the</span> <span class="selector-tag">path</span> <span class="selector-tag">of</span> <span class="selector-tag">key</span> <span class="selector-tag">used</span> <span class="selector-tag">by</span> <span class="selector-tag">key</span> <span class="selector-tag">provider</span>: /<span class="selector-tag">etc</span>/<span class="selector-tag">adminserverkey</span></span><br><span class="line"><span class="selector-tag">Jan</span> <span class="selector-tag">30</span> <span class="selector-tag">08</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29</span> <span class="selector-tag">172</span><span class="selector-class">.22</span><span class="selector-class">.0</span><span class="selector-class">.1</span> <span class="selector-tag">adminserver</span><span class="selector-attr">[64872]</span>: <span class="selector-tag">2019-01-30T00</span><span class="selector-pseudo">:48</span><span class="selector-pseudo">:29Z</span> <span class="selector-attr">[FATAL]</span> <span class="selector-attr">[main.go:45]</span>: <span class="selector-tag">failed</span> <span class="selector-tag">to</span> <span class="selector-tag">initialize</span> <span class="selector-tag">the</span> <span class="selector-tag">system</span>: <span class="selector-tag">read</span> /<span class="selector-tag">tc</span>/<span class="selector-tag">adminserver</span>/<span class="selector-tag">key</span>: <span class="selector-tag">is</span> <span class="selector-tag">a</span> <span class="selector-tag">directory</span></span><br></pre></td></tr></table></figure></p>
<p>3、由于修改了secretkey_path in harbor.cfg，并没有更改docker-compose.yml配置导致，修改后docker-compose.yml执行以下命令即可：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="meta">down</span></span><br><span class="line">./prepare</span><br><span class="line">docker-compose <span class="meta">up</span> -d</span><br></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/goharbor/harbor/wiki/Architecture-Overview-of-Harbor" target="_blank" rel="noopener">https://github.com/goharbor/harbor/wiki/Architecture-Overview-of-Harbor</a></li>
<li><a href="https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="noopener">https://github.com/goharbor/harbor/blob/master/docs/installation_guide.md</a></li>
<li><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">https://www.postgresql.org/download/linux/redhat/</a></li>
<li><a href="https://github.com/goharbor/harbor/issues/6534" target="_blank" rel="noopener">https://github.com/goharbor/harbor/issues/6534</a></li>
</ul>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/18/如何搭建高可用Docker-Harbor仓库/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-17 </div>
			<div class="article-title"><a href="/2019/02/17/Python调用Jenkins-api-文档/">Python调用Jenkins api 文档</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="1、引言：">1、引言：</h3><p>现阶段大部分公司，在日常运维中使用jenkins频率还是相对多，今天我们简单探讨下jenkins api的使用。</p>
<h3 id="2、Python库">2、Python库</h3><h4 id="2-1、python-jenkins">2.1、python-jenkins</h4><p>python-jenkins官方链接：<br><a href="http://python-jenkins.readthedocs.io/en/latest/examples.html#example-1-get-version-of-jenkins" target="_blank" rel="noopener">http://python-jenkins.readthedocs.io/en/latest/examples.html#example-1-get-version-of-jenkins</a></p>
<h4 id="2-2、jenkinsapi">2.2、jenkinsapi</h4><p>jenkinsapi 官方链接：<br><a href="https://pypi.org/project/jenkinsapi/#description" target="_blank" rel="noopener">https://pypi.org/project/jenkinsapi/#description</a></p>
<h3 id="3、python-jenkins库">3、python-jenkins库</h3><h4 id="3-1安装">3.1安装</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install </span>python-<span class="keyword">jenkins</span></span><br><span class="line"><span class="keyword"># </span>或者</span><br><span class="line">easy_install python-<span class="keyword">jenkins</span></span><br></pre></td></tr></table></figure>
<h3 id="3-2案例">3.2案例</h3><h4 id="3-2-1_获取版本号">3.2.1 获取版本号</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import jenkins </span><br><span class="line"><span class="keyword">server</span> = jenkins.Jenkins(<span class="string">'http://localhost:8080'</span>, username=<span class="string">'admin'</span>, password=<span class="string">'admin'</span>) </span><br><span class="line">user = <span class="keyword">server</span>.get_whoami() </span><br><span class="line">version = <span class="keyword">server</span>.get_version() </span><br><span class="line">print(<span class="string">'Hello %s from Jenkins %s'</span> % (user[<span class="string">'fullName'</span>], version))</span><br></pre></td></tr></table></figure>
<p>3.2.2 简单API<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line">import jenkins</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jenkins_Api</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>._url=<span class="string">'http://192.168.72.128:8080'</span></span><br><span class="line">        <span class="keyword">self</span>._username=<span class="string">"admin"</span></span><br><span class="line">        <span class="keyword">self</span>._password=<span class="string">"admin"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        server=jenkins.Jenkins(<span class="keyword">self</span>._url, username=<span class="keyword">self</span>._username, password=<span class="keyword">self</span>._password)</span><br><span class="line">        user=server.get_whoami()</span><br><span class="line">        <span class="keyword">return</span> server</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_version</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_version()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_jobs</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">"jobs_count"</span><span class="symbol">:self</span>.get_server_instance().jobs_count(),</span><br><span class="line">             <span class="string">"get_jobs"</span><span class="symbol">:self</span>.get_server_instance().get_jobs()&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_job</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().create_job(job_name)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_job_confing</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_job_config(job_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copy_job</span><span class="params">(<span class="keyword">self</span>,job_name,new_job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().copy_job(job_name,new_job_name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build_job</span><span class="params">(<span class="keyword">self</span>,job_name,parameters=None,)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().build_job(job_name,parameters=parameters)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_build</span><span class="params">(<span class="keyword">self</span>,job_name,number)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().delete_build(job_name,number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_job_info</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_job_info(<span class="string">'test'</span>)[<span class="string">'lastCompletedBuild'</span>][<span class="string">'number'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_build_info</span><span class="params">(<span class="keyword">self</span>,job_name,number)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_build_info(job_name, number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_build_console_output</span><span class="params">(<span class="keyword">self</span>, job_name, number)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_build_console_output(job_name, number)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_view</span><span class="params">(<span class="keyword">self</span>,view_name)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().create_view(view_name,config_xml=jenkins.EMPTY_VIEW_CONFIG_XML)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_views</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.get_server_instance().get_views()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span>==<span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    print(Jenkins_Api().get_views())</span><br><span class="line">    <span class="comment"># print(Jenkins_Api().get_build_console_output(job_name='test',number=7))</span></span><br><span class="line">    print(Jenkins_Api().build_job(job_name=<span class="string">'test'</span>,parameters=&#123;<span class="string">"Branch"</span><span class="symbol">:<span class="string">"origin/master"</span></span>&#125;))</span><br></pre></td></tr></table></figure></p>
<h3 id="4、jenkinsapi库">4、jenkinsapi库</h3><h4 id="4-1安装">4.1安装</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install </span>python-<span class="keyword">jenkins</span></span><br><span class="line"><span class="keyword"># </span>或者</span><br><span class="line">easy_install python-<span class="keyword">jenkins</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2案例">4.2案例</h3><h4 id="4-2-1获取版本号">4.2.1获取版本号</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import jenkinsapi</span><br><span class="line">from jenkinsapi<span class="selector-class">.jenkins</span> import Jenkins</span><br><span class="line">J=Jenkins(<span class="string">'http://192.168.72.128:8080'</span>,username=<span class="string">"admin"</span>,password=<span class="string">"admin"</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(J.version)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="4-2-2_获取Job详细输出">4.2.2 获取Job详细输出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Jenkins server</span><br><span class="line"><span class="keyword">from</span> jenkinsapi.jenkins <span class="keyword">import</span> Jenkins</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">()</span>:</span></span><br><span class="line">    jenkins_url = <span class="string">'http://jenkins_host:8080'</span></span><br><span class="line">    server = Jenkins(<span class="string">'http://192.168.72.128:8080'</span>,username=<span class="string">"admin"</span>,password=<span class="string">"admin"</span>)</span><br><span class="line">    <span class="keyword">return</span> server</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_job_details</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Refer Example #1 for definition of function 'get_server_instance'</span></span><br><span class="line">    server = get_server_instance()</span><br><span class="line">    <span class="keyword">for</span> job_name, job_instance <span class="keyword">in</span> server.get_jobs():</span><br><span class="line">        print(<span class="string">"-"</span>*<span class="number">20</span>)</span><br><span class="line">        print(<span class="string">'Job Name:%s'</span> % (job_instance.name))</span><br><span class="line">        print(<span class="string">'Job Description:%s'</span> % (job_instance.get_description()))</span><br><span class="line">        print(<span class="string">'Is Job running:%s'</span> % (job_instance.is_running()))</span><br><span class="line">        print(<span class="string">'Is Job enabled:%s'</span> % (job_instance.is_enabled()))</span><br></pre></td></tr></table></figure>
<h4 id="4-2-3_获取最新构建输出">4.2.3 获取最新构建输出</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jenkinsapi</span><br><span class="line"><span class="keyword">from</span> jenkinsapi.jenkins <span class="keyword">import</span> Jenkins</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">()</span>:</span></span><br><span class="line">    jenkins_url = <span class="string">'http://jenkins_host:8080'</span></span><br><span class="line">    server = Jenkins(<span class="string">'http://192.168.72.128:8080'</span>,username=<span class="string">"admin"</span>,password=<span class="string">"admin"</span>)</span><br><span class="line">    <span class="keyword">return</span> server</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_last_console</span><span class="params">()</span>:</span></span><br><span class="line">    server = get_server_instance()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> server.keys():</span><br><span class="line">        print(server[i].get_last_completed_build().get_console())</span><br></pre></td></tr></table></figure>
<h4 id="4-2-4_简单API">4.2.4 简单API</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from jenkinsapi.jenkins import Jenkins</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jenkins_Api</span>(<span class="title">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>._url=<span class="string">'http://192.168.72.128:8080'</span></span><br><span class="line">        <span class="keyword">self</span>._username=<span class="string">"admin"</span></span><br><span class="line">        <span class="keyword">self</span>._password=<span class="string">"admin"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_server_instance</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        server = Jenkins(<span class="keyword">self</span>._url, username=<span class="keyword">self</span>._username, password=<span class="keyword">self</span>._password)</span><br><span class="line">        <span class="keyword">return</span> server</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_version</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">self</span>.get_server_instance().version</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_job_last_console</span><span class="params">(<span class="keyword">self</span>,job_name)</span></span><span class="symbol">:</span></span><br><span class="line">        data=&#123;</span><br><span class="line">                <span class="string">'time'</span>: str(<span class="keyword">self</span>.get_server_instance()[job_name].get_last_completed_build().get_timestamp()),</span><br><span class="line">                <span class="string">'status'</span><span class="symbol">:self</span>.get_server_instance()[job_name].get_last_completed_build().get_status(),</span><br><span class="line">                 <span class="string">'res'</span><span class="symbol">:self</span>.get_server_instance()[job_name].get_last_completed_build().get_console()</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">        <span class="comment">#return json.dumps(data)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span>==<span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    print(Jenkins_Api().get_job_last_console(job_name=<span class="string">'test'</span>))</span><br></pre></td></tr></table></figure>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/17/Python调用Jenkins-api-文档/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-17 </div>
			<div class="article-title"><a href="/2019/02/17/centos7-docker-使用ss科学上网/">centos7 docker 使用ss科学上网</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="安装privoxy客户端">安装privoxy客户端</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install privoxy</span><br></pre></td></tr></table></figure>
<h3 id="配置privoxy">配置privoxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 docker.service.d]# grep -v "^#\|^$" /etc/privoxy/config|grep forward-socks5t</span><br><span class="line">forward-socks5t / 10.80.80.78:1080 .</span><br></pre></td></tr></table></figure>
<h3 id="Docker开启ss科学上网">Docker开启ss科学上网</h3><h5 id="在_/etc/systemd/system/docker-service-d目录下新增">在 /etc/systemd/system/docker.service.d目录下新增</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">Environment=HTTP_PROXY=http://127.0.0.1:8118/</span><br><span class="line">Environment=HTTPS_PROXY=http://127.0.0.1:8118/</span><br><span class="line">Environment=NO_PROXY=localhost,10.80.80.251,m1empwb1.mirror.aliyuncs.com,docker.io,registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 docker.service.d]# systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">[root@node1 docker.service.d]# systemctl show docker |grep 127.0.0.1</span><br><span class="line">Environment=GOTRACEBACK=crash DOCKER_DNS_OPTIONS=\x20\x20\x20\x20\x20--dns\x20192.168.5.21\x20--dns\x20192.168.5.22\x20--dns\x20223.5.5.5\x20\x20\x20\x20\x20\x20\x20--dns-search\x20default.svc.cluster.local\x20--dns-search\x20svc.cluster.local\x20\x20\x20\x20\x20\x20\x20--dns-opt\x20ndots:2\x20--dns-opt\x20timeout:2\x20--dns-opt\x20attempts:2\x20\x20\x20 DOCKER_OPTS=\x20\x20--data-root=/var/lib/docker\x20--log-opt\x20max-size=50m\x20--log-opt\x20max-file=5\x20--iptables=false HTTP_PROXY=http://127.0.0.1:8118/ HTTPS_PROXY=http://127.0.0.1:8118/ NO_PROXY=localhost,10.80.80.251,m1empwb1.mirror.aliyuncs.com,docker.io,registry.cn-hangzhou.aliyuncs.com</span><br><span class="line"></span><br><span class="line">[root@node1 docker.service.d]# systemctl restart docker</span><br></pre></td></tr></table></figure>
<h5 id="验证">验证</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 docker.service.d]# docker pull gcr.io/kubernetes-helm/tiller:v2.2.2</span><br><span class="line">v2.2.2: Pulling from kubernetes-helm/tiller</span><br><span class="line">53ebc9bfbcc0: Pull complete </span><br><span class="line">8065d4c79ab9: Pull complete </span><br><span class="line">Digest: sha256:82677f561f8dd67b6095fe7b9646e6913ee99e1d6fdf86705adbf99a69a7d744</span><br><span class="line">Status: Downloaded newer image for gcr.io/kubernetes-helm/tiller:v2.2.2</span><br></pre></td></tr></table></figure>
<p>如果验证失败报以下错误，注销登录即可<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 docker.service.d]# docker pull gcr.io/google_containers/cluster-proportional-autoscaler-amd64:1.3.0</span><br><span class="line">Error response from daemon: Get https://gcr.io/v2/google_containers/cluster-proportional-autoscaler-amd64/manifests/1.3.0: unauthorized: Not Authorized.</span><br><span class="line"></span><br><span class="line">[root@node1 docker.service.d]# docker logout  gcr.io</span><br><span class="line">Removing login credentials for gcr.io</span><br></pre></td></tr></table></figure></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/17/centos7-docker-使用ss科学上网/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2019-02-17 </div>
			<div class="article-title"><a href="/2019/02/17/分布式时序数据库InfluxDB/">分布式时序数据库InfluxDB</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="什么是InfluxDB？">什么是InfluxDB？</h3><blockquote>
<p>InfluxDB 是一个开源分布式时序、事件和指标数据库。使用 Go 语言编写，无需外部依赖。其设计目标是实现分布式和水平伸缩扩展。</p>
</blockquote>
<p>它有三大特性：</p>
<ul>
<li><strong>Time Series （时间序列）：</strong> 你可以使用与时间有关的相关函数（如最大，最小，求和等）</li>
<li>  <strong>Metrics（度量）：</strong>你可以实时对大量数据进行计算 </li>
<li><strong>Eevents（事件）：</strong>它支持任意的事件数据</li>
</ul>
<p>官网介绍：<a href="https://www.influxdata.com/" target="_blank" rel="noopener">https://www.influxdata.com/</a></p>
<h3 id="如何安装InfluxDB？">如何安装InfluxDB？</h3><p>系统环境：CentOS Linux release 7.3.1611 (Core)<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.influxdata.com/influxdb/releases/influxdb-<span class="number">1.2</span>.<span class="number">4</span>.x86_64.rpm</span><br><span class="line">sudo yum localinstall influxdb-<span class="number">1.2</span>.<span class="number">4</span>.x86_64.rpm</span><br><span class="line">sudo systemctl  start  influxdb</span><br></pre></td></tr></table></figure></p>
<p>官网下载连接：<a href="https://portal.influxdata.com/downloads" target="_blank" rel="noopener">https://portal.influxdata.com/downloads</a></p>
<h3 id="简单介绍InfluxDB用法">简单介绍InfluxDB用法</h3><p>默认开启WEB访问界面地址为IP:8083,默认登录账号和密码为root/root</p>
<p> <img src="/img/201902/influxBD01.png" style="width: 550x;"></p>
<p>Linux字符进入直接输入influx</p>
<h4 id="influxDB名词">influxDB名词</h4><ul>
<li><strong>database：</strong> 数据库；</li>
<li><strong>measurement：</strong> 数据库中的表；</li>
<li><strong>points：</strong> 表里面的一行数据。</li>
</ul>
<h4 id="influxDB中独有的一些概念">influxDB中独有的一些概念</h4><p>Point由时间戳（time）、数据（field）和标签（tags）组成。</p>
<ul>
<li><strong>time：</strong> 每条数据记录的时间，也是数据库自动生成的主索引；</li>
<li><strong>fields：</strong> 各记录的值；</li>
<li><strong>tags：</strong> 各种有索引的属性。</li>
</ul>
<h4 id="新增数据库">新增数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">"db_name"</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">DATABASES</span> <span class="comment">#显示所有数据库</span></span><br></pre></td></tr></table></figure>
<h4 id="进入数据库">进入数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">USE</span> <span class="string">"db_name"</span></span><br><span class="line"><span class="comment"># 显示该数据库中所有的表  </span></span><br><span class="line"><span class="keyword">show</span> measurements</span><br></pre></td></tr></table></figure>
<h4 id="创建表，直接在插入数据的时候指定表名">创建表，直接在插入数据的时候指定表名</h4><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; insert <span class="keyword">test</span>-measurements,host=<span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>,monitor_name=<span class="keyword">test</span> count=<span class="number">1</span></span><br><span class="line">&gt; SHOW MEASUREMENTS</span><br><span class="line"><span class="symbol">name:</span> measurements</span><br><span class="line">------------------</span><br><span class="line">name</span><br><span class="line"><span class="keyword">test</span>-measurements</span><br></pre></td></tr></table></figure>
<h4 id="删除表">删除表</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">drop</span> measurement <span class="string">"measurement_name"</span></span><br></pre></td></tr></table></figure>
<h4 id="通过API插入数据">通过API插入数据</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -<span class="selector-tag">i</span> -XPOST -u username:password <span class="string">"http://192.168.162.113:8086/write?db=test"</span> --data-binary <span class="string">'test-measurements  value=120'</span></span><br></pre></td></tr></table></figure>
<p> <img src="/img/201902/influxBD02.png" style="width: 550x;"></p>
<h6 id="注意是否存在test数据库，没有则新增">注意是否存在test数据库，没有则新增</h6><p> <img src="/img/201902/influxBD03.png" style="width: 550x;"></p>
<h4 id="查询语法">查询语法</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="tag">&lt;<span class="name">field_key</span>&gt;</span>[,<span class="tag">&lt;<span class="name">field_key</span>&gt;</span>,<span class="tag">&lt;<span class="name">tag_key</span>&gt;</span>] FROM <span class="tag">&lt;<span class="name">measurement_name</span>&gt;</span>[,<span class="tag">&lt;<span class="name">measurement_name</span>&gt;</span>]</span><br></pre></td></tr></table></figure>
<p>官方文档：<a href="https://docs.influxdata.com/influxdb/v1.0/query_language/data_exploration/?spm=5176.100239.blogcont61915.11.R6KaBi" target="_blank" rel="noopener">https://docs.influxdata.com/influxdb/v1.0/query_language/data_exploration/?spm=5176.100239.blogcont61915.11.R6KaBi</a></p>
<h3 id="结合Grafana">结合Grafana</h3><h4 id="官网介绍：">官网介绍：</h4><ul>
<li><a href="https://github.com/torkelo/grafana" target="_blank" rel="noopener">https://github.com/torkelo/grafana</a></li>
<li><a href="http://docs.grafana.org/features/datasources/influxdb/" target="_blank" rel="noopener">http://docs.grafana.org/features/datasources/influxdb/</a></li>
</ul>
<h4 id="安装下载Grafana">安装下载Grafana</h4><p>下载链接：<a href="https://github.com/grafana/grafana/releases" target="_blank" rel="noopener">https://github.com/grafana/grafana/releases</a><br>或者直接使用rpm安装：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://s3-us-west<span class="string">-2</span>.amazonaws.com/grafana-releases/release/grafana<span class="string">-4</span>.4.1<span class="string">-1</span>.x86_64.rpm</span><br><span class="line">yum install initscripts fontconfig</span><br><span class="line">yum localinstall grafana<span class="string">-4</span>.4.1<span class="string">-1</span>.x86_64.rpm\</span><br></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="keyword">start</span> grafana-<span class="keyword">server</span></span><br><span class="line">systemctl <span class="keyword">status</span> grafana-<span class="keyword">server</span></span><br><span class="line">netstat -ntlp|grep <span class="number">3000</span></span><br><span class="line">lsof -i:<span class="number">3000</span></span><br></pre></td></tr></table></figure>
<h4 id="简单配置Grafana">简单配置Grafana</h4><p>官方文档：<a href="http://docs.grafana.org/features/datasources/influxdb/" target="_blank" rel="noopener">http://docs.grafana.org/features/datasources/influxdb/</a></p>
<p>安装后登陆地址为：<a href="http://IP:3000/login,默认账号和密码都是admin" target="_blank" rel="noopener">http://IP:3000/login,默认账号和密码都是admin</a><br> <img src="/img/201902/influxBD04.png" style="width: 550x;"><br> <img src="/img/201902/influxBD05.png" style="width: 550x;"><br> <img src="/img/201902/influxBD06.png" style="width: 550x;"></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2019/02/17/分布式时序数据库InfluxDB/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-07-29 </div>
			<div class="article-title"><a href="/2018/07/29/企业常用几种部署方式-蓝绿部署、滚动部署、金丝雀部署/">企业常用几种部署方式(蓝绿部署、滚动部署、金丝雀部署)</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <blockquote>
<p>部署是将服务的某个版本投入生产环境的过程。部署的总体目标是：对系统用户产生最小影响的情况下，把服务的升级版本投放到生产环境中。</p>
</blockquote>
<h3 id="服务变更的主要原因：">服务变更的主要原因：</h3><ul>
<li>1、修复错误</li>
<li>2、提高服务的质量</li>
<li>3、增加新的功能</li>
</ul>
<h3 id="服务变更需要注意哪些(或者说如何产生最小影响)？">服务变更需要注意哪些(或者说如何产生最小影响)？</h3><p>SRE 经验告诉我们，大概 70% 的生产事故由某种部署的变更而触发。变更管理的最佳实践可使用自动化来完成以下几点：</p>
<ul>
<li>1、部署尽可能在用户少的时候。</li>
<li>2、每次部署前备份原始数据。</li>
<li>3、采用渐进式发布机制。</li>
<li>4、迅速而准确地检测到问题的发生。</li>
<li>5、当出现问题时，安全迅速地回退改动。</li>
</ul>
<h3 id="常用部署方式存在以下几种:">常用部署方式存在以下几种:</h3><ul>
<li>蓝绿部署</li>
<li>滚动部署</li>
<li>灰度部署/金丝雀部署</li>
</ul>
<h4 id="蓝绿部署">蓝绿部署</h4><h5 id="定义：">定义：</h5><p>蓝绿部署(部分称大翻转或红/黑部署)，首先准备N台提供版本A服务的机器，同时准备N台提供版本B的机器。一旦版本B的N台机器配置好并准备好服务请求，通过切换路由到版本B,例子如下所示：</p>
<p>1、绿色表示当前的生产应用程序V1<br> <img src="/img/201807/greendeployment.png" style="width: 550x;"></p>
<p>2、现在，当您准备对app2进行更改并将其升级到v2时，您将在”蓝色环境”中执行此操作。在该环境中，您可以部署新版本的应用程序，运行冒烟测试以及任何其他测试（包括操作系统，缓存，CPU等）。当结果看起来不错时，您可以将负载均衡器/反向代理/路由器更改为指向蓝色环境：</p>
<p> <img src="/img/201807/bluedeployment.png" style="width: 550x;"></p>
<h5 id="方法：">方法：</h5><ul>
<li>可以通过切换域名服务器（DNS）</li>
<li>更改负载均衡器路由切换</li>
</ul>
<h5 id="优点：">优点：</h5><ul>
<li>更新过程无需停机，风险较少</li>
<li>回滚方便，只需要更改路由或者切换DNS服务器，效率较高</li>
</ul>
<h5 id="缺点：">缺点：</h5><ul>
<li>需要部署两套机器，费用开销大</li>
<li>在非隔离的机器（Docker、VM）上操作时，可能会导致蓝绿环境被摧毁风险</li>
<li>负载均衡器/反向代理/路由/DNS处理不当，将导致流量没有切换过来情况出现</li>
</ul>
<h4 id="滚动发布：">滚动发布：</h4><h5 id="定义：-1">定义：</h5><p>现生产N台机器都为版本A的机器，部署取出一个或者多个服务器停止服务，执行更新版本B，更新后重新将其投入使用，继续不断更新其他机器，直到集群中所有的实例都更新成版本B。</p>
<h5 id="流程：">流程：</h5><ul>
<li>1、负载均衡或者路由移除一台或者多台实例(正常监控也需要移除)</li>
<li>2、移除后的实例开始更新</li>
<li>3、上线测试后无异常开始接入负载均衡器或者路由</li>
<li>4、新增实例监控</li>
<li>5、继续上线后一批实例，直到集群中所有的实例都更新</li>
</ul>
<h5 id="优点：-1">优点：</h5><ul>
<li>更新过程体验影响少，风险较少</li>
<li>费用对比蓝绿花费开销较少，无需额外新增机器</li>
</ul>
<h5 id="缺点：-1">缺点：</h5><ul>
<li>上线/回滚完成时间相对较慢</li>
<li>需要监控和负载均衡器的移除和接入能力</li>
</ul>
<h4 id="灰度发布">灰度发布</h4><h5 id="定义">定义</h5><p>灰度发布（又名金丝雀发布）是指在黑与白之间，能够平滑过渡的一种发布方式。在其上可以进行A/B testing，即让一部分用户继续用产品特性A，一部分用户开始用产品特性B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。（类似地下采煤使用的金丝雀方法，当金丝雀遇到有毒气体时候，产生痛苦信号）A/B testing和金丝雀的差别在于A/B 测试对于特定业务的关键绩效指标来说，确定那个版本执行得更好。</p>
<h5 id="方法">方法</h5><ul>
<li>首先部署少量服务器密切</li>
<li>观察是否因为版本产生预期结果</li>
<li>当结果满意时候再全量部署</li>
</ul>
<p> <img src="/img/201807/beta.png" style="width: 550x;"></p>
<p> <img src="/img/201807/AB-test.png" style="width: 550x;"></p>
<p> 优缺点可以参考上面</p>
<h4 id="关于CAP定理">关于CAP定理</h4><ul>
<li>一致性（Consistence） （等同于所有节点访问同一份最新的数据副本）</li>
<li>可用性（Availability）（每次请求都能获取到非错的响应——但是不保证获取的数据为最新数据）</li>
<li>分区容错性（Partition tolerance）（以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择[3]。）</li>
</ul>
<p>我们这里只讨论一致性问题，其他你们可以自行思考下：</p>
<ul>
<li>建议无状态(session等信息存放在缓存数据库)</li>
<li>如果新版本的操作涉及到数据库更改，建议保持只新增不删减字段操作</li>
</ul>
<p>要是存在多版本同时存在，注意考虑以下：</p>
<ul>
<li>1、功能开关</li>
<li>2、前后版本兼容</li>
</ul>
<p>参考资料包括以下：</p>
<ul>
<li><a href="http://blog.christianposta.com/deploy/blue-green-deployments-a-b-testing-and-canary-releases/" target="_blank" rel="noopener">http://blog.christianposta.com/deploy/blue-green-deployments-a-b-testing-and-canary-releases/</a></li>
<li><a href="https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html" target="_blank" rel="noopener">https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html</a></li>
</ul>

	
	</div>
	
  
</div>
	<a type="button" href="/2018/07/29/企业常用几种部署方式-蓝绿部署、滚动部署、金丝雀部署/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-07-29 </div>
			<div class="article-title"><a href="/2018/07/29/Pyecharts-生成图表-附Django支持/">Pyecharts 生成图表(附Django支持)</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <blockquote>
<p>pyecharts 是一个用于生成 Echarts 图表的类库。Echarts 是百度开源的一个数据可视化 JS 库。用 Echarts 生成的图可视化效果非常棒，pyecharts 是为了与 Python 进行对接，方便在 Python 中直接使用数据生成图。</p>
</blockquote>
<h3 id="安装">安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyecharts</span><br></pre></td></tr></table></figure>
<h3 id="简单实例">简单实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> Bar</span><br><span class="line">bar = Bar(<span class="string">"我的第一个图表"</span>, <span class="string">"这里是副标题"</span>)</span><br><span class="line">bar.add(<span class="string">"服装"</span>, [<span class="string">"衬衫"</span>, <span class="string">"羊毛衫"</span>, <span class="string">"雪纺衫"</span>, <span class="string">"裤子"</span>, <span class="string">"高跟鞋"</span>, <span class="string">"袜子"</span>], [<span class="number">5</span>, <span class="number">20</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">75</span>, <span class="number">90</span>])</span><br><span class="line"><span class="comment"># bar.print_echarts_options() # 该行只为了打印配置项，方便调试时使用</span></span><br><span class="line">bar.render()    <span class="comment"># 生成本地 HTML 文件</span></span><br></pre></td></tr></table></figure>
<p>默认当前目录下生成render.html，使用浏览器打开如下：<br> <img src="/img/201807/Pyecharts01.png" style="width: 550x;"></p>
<h5 id="图形绘制过程">图形绘制过程</h5><p>基本上所有的图表类型都是这样绘制的：</p>
<ul>
<li>chart_name = Type() 初始化具体类型图表。</li>
<li>add() 添加数据及配置项。</li>
<li>render() 生成本地文件（html/svg/jpeg/png/pdf/gif）。</li>
</ul>
<p>add() 数据一般为两个列表（长度一致）。如果你的数据是字典或者是带元组的字典。可利用 cast() 方法转换。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line">cast(seq)</span><br><span class="line">转换数据序列，将带字典和元组类型的序列转换为 k_lst,v_lst 两个列表</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>元组列表</strong><br>[(A1, B1), (A2, B2), (A3, B3), (A4, B4)] –&gt; k_lst[ A[i1, i2…] ], v_lst[ B[i1, i2…] ]</li>
<li><strong>字典列表</strong><br>[{A1: B1}, {A2: B2}, {A3: B3}, {A4: B4}] –&gt; k_lst[ A[i1, i2…] ], v_lst[ B[i1, i2…] ]</li>
<li><strong>字典</strong><br>{A1: B1, A2: B2, A3: B3, A4: B4} – &gt; k_lst[ A[i1, i2…] ], v_lst[ B[i1, i2…] ]</li>
</ul>
<h3 id="结合Django显示以上图形">结合Django显示以上图形</h3><h4 id="基础环境">基础环境</h4><ul>
<li><strong>Django_version:</strong> 2.1a1</li>
<li><strong>Python_verison:</strong> 3.6.5</li>
</ul>
<h4 id="url-py">url.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span>  TemplateView  <span class="comment">#通用视图</span></span><br><span class="line"><span class="keyword">from</span> apps.ops <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r'^test/$'</span>, views.test),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="app-ops-views-py">app.ops.views.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader</span><br><span class="line"><span class="keyword">from</span> pyecharts <span class="keyword">import</span> Bar</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line">REMOTE_HOST = <span class="string">"https://pyecharts.github.io/assets/js"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(request)</span>:</span></span><br><span class="line">    template = loader.get_template(<span class="string">'test/pyecharts.html'</span>)</span><br><span class="line">    b = bar()</span><br><span class="line">    context = dict(</span><br><span class="line">        myechart=b.render_embed(),</span><br><span class="line">        host=REMOTE_HOST,</span><br><span class="line">        script_list=b.get_js_dependencies()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.render(context, request))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    bar = Bar(<span class="string">"我的第一个图表"</span>, <span class="string">"这里是副标题"</span>)</span><br><span class="line">    bar.add(<span class="string">"服装"</span>, [<span class="string">"衬衫"</span>, <span class="string">"羊毛衫"</span>, <span class="string">"雪纺衫"</span>, <span class="string">"裤子"</span>, <span class="string">"高跟鞋"</span>, <span class="string">"袜子"</span>], [<span class="number">5</span>, <span class="number">20</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">75</span>, <span class="number">90</span>])</span><br><span class="line">    <span class="comment"># bar.print_echarts_options() # 该行只为了打印配置项，方便调试时使用</span></span><br><span class="line">    <span class="comment"># bar.render()  # 生成本地 HTML 文件</span></span><br><span class="line">    <span class="keyword">return</span> bar</span><br></pre></td></tr></table></figure>
<ul>
<li><p>script_list 是 Page() 类渲染网页所需要依赖的 echarts js 库，依赖的库的数量取决于所要渲染的图形种类。</p>
</li>
<li><p>host 是 echarts js 库的地址，默认提供的地址为 <a href="https://pyecharts.github.io/assets/js" target="_blank" rel="noopener">https://pyecharts.github.io/assets/js</a> 当然，如果你愿意你也可以改变这个地址，先克隆 <a href="https://github.com/pyecharts/assets" target="_blank" rel="noopener">https://github.com/pyecharts/assets</a> 然后将 js 文件夹挂载在你自己的服务器上即可。</p>
</li>
</ul>
<h4 id="templates/test/pyecharts-html">templates/test/pyecharts.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- myfirstvis/templates/pyecharts.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Proudly presented by PycCharts<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    &#123;% for jsfile_name in script_list %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; host &#125;&#125;/&#123;&#123; jsfile_name &#125;&#125;.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  &#123;&#123; myechart|safe &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动django访问/test/即可</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2018/07/29/Pyecharts-生成图表-附Django支持/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-07-29 </div>
			<div class="article-title"><a href="/2018/07/29/Python调用Zabbix-Api获取数据/">Python调用Zabbix Api获取数据</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="请求的方法参数">请求的方法参数</h3><p>官方原文：</p>
<ul>
<li><strong>jsonrpc</strong> - the version of the JSON-RPC protocol used by the API; the  Zabbix API implements JSON-RPC version 2.0;</li>
<li><strong>method</strong> - the API method being called;</li>
<li><strong>params</strong> - parameters that will be passed to the API method;</li>
<li><strong>id</strong> - an arbitrary identifier of the request;</li>
<li><strong>auth</strong> - a user authentication token; since we don’t have one yet, it’s set to null.</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th style="text-align:center">值类型</th>
<th style="text-align:left">说明</th>
<th>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td>jsonrpc</td>
<td style="text-align:center">str</td>
<td style="text-align:left">接口版本</td>
<td>是</td>
</tr>
<tr>
<td>method</td>
<td style="text-align:center">str</td>
<td style="text-align:left">请求方法</td>
<td>是</td>
</tr>
<tr>
<td>params</td>
<td style="text-align:center">json</td>
<td style="text-align:left">请求方法参数</td>
<td>是</td>
</tr>
<tr>
<td>user</td>
<td style="text-align:center">str</td>
<td style="text-align:left">zabbix账号</td>
<td>是</td>
</tr>
<tr>
<td>password</td>
<td style="text-align:center">str</td>
<td style="text-align:left">zabbix密码</td>
<td>是</td>
</tr>
<tr>
<td>auth</td>
<td style="text-align:center">str</td>
<td style="text-align:left">认证的key</td>
<td>是</td>
</tr>
<tr>
<td>id</td>
<td style="text-align:center">int</td>
<td style="text-align:left">认证id</td>
<td>是</td>
</tr>
</tbody>
</table>
<p>请求事例：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST http://company.com/zabbix/api_jsonrpc.php HTTP/1.1</span><br><span class="line">Content-Type: application/json-rpc</span><br><span class="line"></span><br><span class="line">&#123;"jsonrpc":"2.0","method":"apiinfo.version","id":1,"auth":null,"params":&#123;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="python获取token">python获取token</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys, argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zabbix_Api</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.url = <span class="string">'http://IP/zabbix/api_jsonrpc.php'</span></span><br><span class="line">        self.header = &#123;<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>&#125;</span><br><span class="line">        self.id = <span class="number">1</span></span><br><span class="line">        self.user=<span class="string">"zabbix登录账号"</span></span><br><span class="line">        self.password=<span class="string">"zabbix登录密码"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">json_obj</span><span class="params">(self,method,auth=True,params=&#123;&#125;)</span>:</span></span><br><span class="line">        obj = &#123;<span class="string">'jsonrpc'</span>: <span class="string">'2.0'</span>,</span><br><span class="line">               <span class="string">'method'</span>: method,</span><br><span class="line">               <span class="string">'params'</span>: params,</span><br><span class="line">               <span class="string">'auth'</span>: auth,</span><br><span class="line">               <span class="string">'id'</span>: self.id&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth:</span><br><span class="line">            <span class="keyword">del</span> obj[<span class="string">"auth"</span>]</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_login</span><span class="params">(self)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"user.login"</span>,auth=<span class="keyword">False</span>, params=&#123;<span class="string">"user"</span>: self.user, <span class="string">"password"</span>: self.password&#125;)</span><br><span class="line">        <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(Zabbix_Api().user_login())</span><br></pre></td></tr></table></figure>
<h3 id="获取版本信息">获取版本信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_version</span><span class="params">(self)</span>:</span></span><br><span class="line">    data=self.json_obj(method=<span class="string">"apiinfo.version"</span>,</span><br><span class="line">        params=&#123;</span><br><span class="line">            <span class="string">"output"</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        auth=<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)</span><br></pre></td></tr></table></figure>
<h3 id="host-get方法获取所有的主机ID">host.get方法获取所有的主机ID</h3><table>
<thead>
<tr>
<th>参数名称</th>
<th style="text-align:center">值类型</th>
<th style="text-align:left">说明</th>
<th>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td>jsonrpc</td>
<td style="text-align:center">str</td>
<td style="text-align:left">接口版本</td>
<td>是</td>
</tr>
<tr>
<td>method</td>
<td style="text-align:center">str</td>
<td style="text-align:left">请求方法</td>
<td>是</td>
</tr>
<tr>
<td>params</td>
<td style="text-align:center">json</td>
<td style="text-align:left">请求方法参数</td>
<td>是</td>
</tr>
<tr>
<td>output</td>
<td style="text-align:center">array</td>
<td style="text-align:left">输出格式</td>
<td>是</td>
</tr>
<tr>
<td>groupids</td>
<td style="text-align:center">str/array</td>
<td style="text-align:left">主机组id</td>
<td>是</td>
</tr>
<tr>
<td>auth</td>
<td style="text-align:center">str</td>
<td style="text-align:left">认证的key</td>
<td>是</td>
</tr>
<tr>
<td>id</td>
<td style="text-align:center">int</td>
<td style="text-align:left">认证id</td>
<td>是</td>
</tr>
</tbody>
</table>
<p>请求事例(参考上面类)：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_host</span><span class="params">(self)</span>:</span></span><br><span class="line">    data=self.json_obj(method=<span class="string">"host.get"</span>,</span><br><span class="line">        params=&#123;</span><br><span class="line">            <span class="string">"output"</span>: [<span class="string">"hostid"</span>, <span class="string">"name"</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        auth=self.user_login())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)</span><br></pre></td></tr></table></figure></p>
<h3 id="itemsid-get方法获取单个主机下所有的监控项ID">itemsid.get方法获取单个主机下所有的监控项ID</h3><table>
<thead>
<tr>
<th>参数名称</th>
<th style="text-align:center">值类型</th>
<th style="text-align:left">说明</th>
<th>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td>jsonrpc</td>
<td style="text-align:center">str</td>
<td style="text-align:left">接口版本</td>
<td>是</td>
</tr>
<tr>
<td>method</td>
<td style="text-align:center">str</td>
<td style="text-align:left">请求方法</td>
<td>是</td>
</tr>
<tr>
<td>params</td>
<td style="text-align:center">json</td>
<td style="text-align:left">请求方法参数</td>
<td>是</td>
</tr>
<tr>
<td>output</td>
<td style="text-align:center">array</td>
<td style="text-align:left">输出格式</td>
<td>是</td>
</tr>
<tr>
<td>groupids</td>
<td style="text-align:center">str/array</td>
<td style="text-align:left">主机组id</td>
<td>是</td>
</tr>
<tr>
<td>auth</td>
<td style="text-align:center">str</td>
<td style="text-align:left">认证的key</td>
<td>是</td>
</tr>
<tr>
<td>id</td>
<td style="text-align:center">int</td>
<td style="text-align:left">认证id</td>
<td>是</td>
</tr>
</tbody>
</table>
<p>请求事例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mem_total</span><span class="params">(self,hostid)</span>:</span></span><br><span class="line">    data=self.json_obj(method=<span class="string">"item.get"</span>,</span><br><span class="line">        params=&#123;</span><br><span class="line">            <span class="string">"output"</span>: <span class="string">"extend"</span>,</span><br><span class="line">            <span class="string">"hostids"</span>: hostid,</span><br><span class="line">            <span class="string">"search"</span>: &#123;</span><br><span class="line">                <span class="string">"key_"</span>: <span class="string">"vm.memory.size[total]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        auth=self.user_login())</span><br><span class="line">    <span class="keyword">return</span> int(json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>][<span class="number">0</span>][<span class="string">"lastvalue"</span>])/<span class="number">1024</span>/<span class="number">1024</span>/<span class="number">1024</span></span><br></pre></td></tr></table></figure></p>
<h3 id="以上完整事例">以上完整事例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys, argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zabbix_Api</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.url = <span class="string">'http://192.168.31.249/zabbix/api_jsonrpc.php'</span></span><br><span class="line">        self.header = &#123;<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>&#125;</span><br><span class="line">        self.id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">json_obj</span><span class="params">(self,method,auth=True,params=&#123;&#125;)</span>:</span></span><br><span class="line">        obj = &#123;<span class="string">'jsonrpc'</span>: <span class="string">'2.0'</span>,</span><br><span class="line">               <span class="string">'method'</span>: method,</span><br><span class="line">               <span class="string">'params'</span>: params,</span><br><span class="line">               <span class="string">'auth'</span>: auth,</span><br><span class="line">               <span class="string">'id'</span>: self.id&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth:</span><br><span class="line">            <span class="keyword">del</span> obj[<span class="string">"auth"</span>]</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_login</span><span class="params">(self)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"user.login"</span>,auth=<span class="keyword">False</span>, params=&#123;<span class="string">"user"</span>: <span class="string">"yunwei"</span>, <span class="string">"password"</span>: <span class="string">"yunwei"</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_host</span><span class="params">(self)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"host.get"</span>,</span><br><span class="line">            params=&#123;</span><br><span class="line">                <span class="string">"output"</span>: [<span class="string">"hostid"</span>, <span class="string">"name"</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            auth=self.user_login())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_mem_total</span><span class="params">(self,hostid)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"item.get"</span>,</span><br><span class="line">            params=&#123;</span><br><span class="line">                <span class="string">"output"</span>: <span class="string">"extend"</span>,</span><br><span class="line">                <span class="string">"hostids"</span>: hostid,</span><br><span class="line">                <span class="string">"search"</span>: &#123;</span><br><span class="line">                    <span class="string">"key_"</span>: <span class="string">"vm.memory.size[total]"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            auth=self.user_login())</span><br><span class="line">        <span class="keyword">return</span> int(json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>][<span class="number">0</span>][<span class="string">"lastvalue"</span>])/<span class="number">1024</span>/<span class="number">1024</span>/<span class="number">1024</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># for k in Zabbix_Api().get_host()["result"]:</span></span><br><span class="line">    <span class="comment">#     print(k["hostid"],k["name"],str(round(Zabbix_Api().get_mem(k["hostid"]),2))+"G")</span></span><br><span class="line">    print(Zabbix_Api().get_mem_total(<span class="number">10084</span>))</span><br></pre></td></tr></table></figure>
<p>以上只是简单举例，具体实践可参考官网文档(要永远相信官方文档是最好的文档)：<a href="https://www.zabbix.com/documentation/3.0/manual/api" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.0/manual/api</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2018/07/29/Python调用Zabbix-Api获取数据/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-07-29 </div>
			<div class="article-title"><a href="/2018/07/29/Django中的缓存配置/">Django中的缓存配置</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <blockquote>
<p>按照《大型网站技术架构》中所说，网站性能优化的第一定律：优先考虑缓存优化性能.今天简单探讨下django的缓存实现。</p>
</blockquote>
<p>缓存一些东西是为了保存那些需要很多计算资源的结果，这样的话就不必在下次重复消耗计算资源。 下面是一些伪代码，用来解释缓存怎样在动态生成的网页中工作的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iven a URL, <span class="keyword">try</span> finding that page <span class="keyword">in</span> the cache</span><br><span class="line"><span class="keyword">if</span> the page <span class="keyword">is</span> <span class="keyword">in</span> the cache:</span><br><span class="line">    <span class="keyword">return</span> the cached page</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    generate the page</span><br><span class="line">    save the generated page <span class="keyword">in</span> the cache (<span class="keyword">for</span> next time)</span><br><span class="line">    <span class="keyword">return</span> the generated page</span><br></pre></td></tr></table></figure></p>
<h4 id="Django中的缓存类型">Django中的缓存类型</h4><ul>
<li>1、内存缓存</li>
<li>2、数据库缓存</li>
<li>3、文件缓存</li>
</ul>
<h4 id="Django如何设置缓存">Django如何设置缓存</h4><p>缓存系统需要一些设置才能使用。 也就是说，你必须告诉他你要把数据缓存在哪里- 是数据库中，文件系统或者直接在内存中。 这个决定很重要，因为它会影响你的缓存性能，缓存配置是通过setting 文件的CACHES 配置来实现的。 </p>
<h5 id="缓存参数">缓存参数</h5><ul>
<li><p><strong>TIMEOUT:</strong> 用于缓存的默认超时（以秒为单位）。此参数默认为300秒（5分钟）。</p>
</li>
<li><p><strong>OPTIONS:</strong> 应传递给缓存后端的任何选项。(包括以下)</p>
</li>
<li>MAX_ENTRIES：删除旧值之前缓存中允许的最大条目数。此参数默认为300。</li>
<li>CULL_FREQUENCY：MAX_ENTRIES达到时剔除的条目部分。实际比率是 ，设置为在达到时剔除一半数目。</li>
<li>EY_PREFIX：一个字符串，将自动包含（默认情况下预先添加）到Django服务器使用的所有缓存键。</li>
<li>VERSION：Django服务器生成的缓存键的默认版本号。</li>
<li>KEY_FUNCTION 包含函数的虚线路径的字符串，用于定义如何将前缀，版本和密钥组合为最终缓存键。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###例子</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.filebased.FileBasedCache'</span>,</span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'/var/tmp/django_cache'</span>,</span><br><span class="line">        <span class="string">'TIMEOUT'</span>: <span class="number">60</span>,</span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">            <span class="string">'MAX_ENTRIES'</span>: <span class="number">1000</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="内存缓存(Memcached)">内存缓存(Memcached)</h5><p>Memcached是Django本身支持的最快，最有效的缓存类型，它 是一个完全基于内存的缓存服务器，最初是为了处理LiveJournal.com的高负载而开发的，后来由Danga Interactive开源。Facebook和Wikipedia等网站使用它来减少数据库访问并显着提高网站性能。</p>
<p>Memcached作为守护进程运行，并分配了指定数量的RAM。它所做的就是提供一个快速接口，用于在缓存中添加，检索和删除数据。所有数据都直接存储在内存中，因此不会产生数据库或文件系统使用的开销。</p>
<p>安装Memcached本身后，您需要安装Memcached绑定。有几个Python Memcached绑定可用; 最常见的两个是python-memcached和pylibmc。</p>
<p>在Django中使用Memcached：</p>
<ul>
<li>设置BACKEND为 django.core.cache.backends.memcached.MemcachedCache或 django.core.cache.backends.memcached.PyLibMCCache（取决于您选择的memcached绑定）</li>
<li>设置LOCATION为ip:port值，其中ip是Memcached守护程序的IP地址，port是运行Memcached的端口，或者是unix:path值，其中 path是Memcached Unix套接字文件的路径。</li>
</ul>
<p><strong>Memcached使用python-memcached绑定在localhost（127.0.0.1）端口11211上运行:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.memcached.MemcachedCache'</span>,</span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'127.0.0.1:11211'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>Memcached可通过/tmp/memcached.sock使用python-memcached绑定的本地Unix套接字文件:</strong></p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    '<span class="attribute">default'</span>: &#123;</span><br><span class="line">        'BACKEND': 'django<span class="variable">.core</span><span class="variable">.cache</span><span class="variable">.backends</span><span class="variable">.memcached</span><span class="variable">.MemcachedCache</span>',</span><br><span class="line">        'LOCATION': 'unix:/tmp/memcached<span class="variable">.sock</span>',</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>用pylibmc绑定时，请不要包含unix:/前缀:</strong><br><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    '<span class="attribute">default'</span>: &#123;</span><br><span class="line">        'BACKEND': 'django<span class="variable">.core</span><span class="variable">.cache</span><span class="variable">.backends</span><span class="variable">.memcached</span><span class="variable">.PyLibMCCache</span>',</span><br><span class="line">        'LOCATION': '/tmp/memcached<span class="variable">.sock</span>',</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="数据库缓存">数据库缓存</h5><p>Django可以将其缓存的数据存储在您的数据库中。如果你有一个快速，索引良好的数据库服务器，这种方法效果最好。</p>
<p>要将数据库表用作缓存后端：</p>
<ul>
<li>设置BACKEND为 django.core.cache.backends.db.DatabaseCache</li>
<li>设置LOCATION为tablename，数据库表的名称，注意这个表应该是还没有新增的。</li>
</ul>
<p><strong>缓存表的名称为my_cache_table：</strong><br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">CACHES</span> = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.db.DatabaseCache'</span>,</span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'my_cache_table'</span>,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>创建缓存表,在使用数据库缓存之前，必须使用以下命令创建缓存表：</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage<span class="selector-class">.py</span> createcachetable</span><br></pre></td></tr></table></figure>
<h6 id="多个数据库">多个数据库</h6><p>如果对多个数据库使用数据库缓存，则还需要为数据库缓存表设置路由指令。出于路由的目的，数据库缓存表CacheEntry在名为的应用程序中显示为名为的模型 django_cache。此模型不会出现在模型缓存中，但模型详细信息可用于路由目的。</p>
<p>例如，以下路由器将指向所有高速缓存读取操作cache_replica，并将所有写入操作指向 cache_primary。缓存表将仅同步到 cache_primary：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheRouter</span>:</span></span><br><span class="line">    <span class="string">"""A router to control all database cache operations"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">db_for_read</span><span class="params">(self, model, **hints)</span>:</span></span><br><span class="line">        <span class="string">"All cache read operations go to the replica"</span></span><br><span class="line">        <span class="keyword">if</span> model._meta.app_label == <span class="string">'django_cache'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'cache_replica'</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">db_for_write</span><span class="params">(self, model, **hints)</span>:</span></span><br><span class="line">        <span class="string">"All cache write operations go to primary"</span></span><br><span class="line">        <span class="keyword">if</span> model._meta.app_label == <span class="string">'django_cache'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'cache_primary'</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_migrate</span><span class="params">(self, db, app_label, model_name=None, **hints)</span>:</span></span><br><span class="line">        <span class="string">"Only install the cache model on primary"</span></span><br><span class="line">        <span class="keyword">if</span> app_label == <span class="string">'django_cache'</span>:</span><br><span class="line">            <span class="keyword">return</span> db == <span class="string">'cache_primary'</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure></p>
<p>如果未指定数据库缓存模型的路由方向，则缓存后端将使用该default数据库。当然，如果不使用数据库缓存后端，则无需担心为数据库缓存模型提供路由指令。</p>
<h4 id="文件系统缓存">文件系统缓存</h4><p>基于文件的后端将每个缓存值序列化并存储为单独的文件。要使用此后端设置BACKEND来 “django.core.cache.backends.filebased.FileBasedCache”和 LOCATION到合适的目录。例如，要存储缓存数据/var/tmp/django_cache，请使用以下设置：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">CACHES</span> = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.filebased.FileBasedCache'</span>,</span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'/var/tmp/django_cache'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果您使用的是Windows，请将驱动器号放在路径的开头，如下所示：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">CACHES</span> = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.core.cache.backends.filebased.FileBasedCache'</span>,</span><br><span class="line">        <span class="string">'LOCATION'</span>: <span class="string">'c:/foo/bar'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="缓存整个站点">缓存整个站点</h4><p>可以在settings配置文件添加如下：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">MIDDLEWARE</span> = [</span><br><span class="line">    <span class="string">'django.middleware.cache.UpdateCacheMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.cache.FetchFromCacheMiddleware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<h4 id="views视图缓存">views视图缓存</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"></span><br><span class="line"><span class="meta">@cache_page(60 * 15)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>注意：cache_page：缓存时间以秒为单位</p>
<h4 id="访问缓存">访问缓存</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> caches</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache1 = caches[<span class="string">'myalias'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache2 = caches[<span class="string">'myalias'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cache1 <span class="keyword">is</span> cache2</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<h4 id="基本用法">基本用法</h4><p>语法： </p>
<ul>
<li><p>新增缓存：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set(key,</span> <span class="string">value,</span> <span class="string">timeout)</span></span><br><span class="line"><span class="string">get(key)</span> <span class="meta">---</span> <span class="string">当存在key不会再新增</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取缓存：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">get</span><span class="params">(key)</span></span>---获取单个值</span><br><span class="line"><span class="function"><span class="title">get_many</span><span class="params">([<span class="string">'key1'</span>, <span class="string">'key2'</span>, <span class="string">'key3'</span>])</span></span>---获取多个值</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除缓存</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cache.<span class="keyword">delete</span>(<span class="string">'a'</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>清空缓存</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cache.<span class="built_in">clear</span>()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>还可以分别使用incr()或decr()方法增加或减少已存在的密钥 。默认情况下，现有缓存值将递增或递减1.可以通过为递增/递减调用提供参数来指定其他递增/递减值。如果您尝试递增或递减不存在的缓存键，将引发ValueError：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; cache.set(<span class="string">'num'</span>, <span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; cache.incr(<span class="string">'num'</span>)</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; cache.incr(<span class="string">'num'</span>, <span class="number">10</span>)</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; cache.decr(<span class="string">'num'</span>)</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; cache.decr(<span class="string">'num'</span>, <span class="number">5</span>)</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure></p>
<p>要是还有疑问，具体可参考：<a href="https://docs.djangoproject.com/zh-hans/2.0/topics/cache/" target="_blank" rel="noopener">https://docs.djangoproject.com/zh-hans/2.0/topics/cache/</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2018/07/29/Django中的缓存配置/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-06-16 </div>
			<div class="article-title"><a href="/2018/06/16/Celery-分布式任务队列/">Celery - 分布式任务队列</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>Celery 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供维护这样一个系统的必需工具。</p>
<p>它是一个专注于实时处理的任务队列，同时也支持任务调度。</p>
<p>Celery 有广泛、多样的用户与贡献者社区，你可以通过 IRC 或是 邮件列表 加入我们。</p>
<p>Celery 是开源的，使用 BSD 许可证 授权。<br>中文官网文档地址：<a href="http://docs.jinkan.org/docs/celery/" target="_blank" rel="noopener">http://docs.jinkan.org/docs/celery/</a></p>
<h3 id="举例">举例</h3><p>创建task.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line">app =Celery(<span class="string">'tasks'</span>,broker=<span class="string">'redis://127.0.0.1:6379/0'</span>,backend=<span class="string">'redis://127.0.0.1:6379/0'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure></p>
<p>启动<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost python]<span class="comment"># celery -A task worker --loglevel=info</span></span><br><span class="line">/usr/lib/python2<span class="number">.7</span>/site-packages/celery/platforms.py:<span class="number">796</span>: RuntimeWarning: Yo<span class="string">u're running the worker with superuser privileges: this is</span></span><br><span class="line"><span class="string">absolutely not recommended!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please specify a different user using the -u option.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">User information: uid=0 euid=0 gid=0 egid=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  uid=uid, euid=euid, gid=gid, egid=egid,</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> -------------- celery@localhost.localdomain v4.1.1 (latentcall)</span></span><br><span class="line"><span class="string">---- **** ----- </span></span><br><span class="line"><span class="string">--- * ***  * -- Linux-3.10.0-693.el7.x86_64-x86_64-with-centos-7.4.1708-Core 2018-06-06 05:25:17</span></span><br><span class="line"><span class="string">-- * - **** --- </span></span><br><span class="line"><span class="string">- ** ---------- [config]</span></span><br><span class="line"><span class="string">- ** ---------- .&gt; app:         tasks:0x7f5c3038c150</span></span><br><span class="line"><span class="string">- ** ---------- .&gt; transport:   redis://127.0.0.1:6379/0</span></span><br><span class="line"><span class="string">- ** ---------- .&gt; results:     redis://127.0.0.1:6379/0</span></span><br><span class="line"><span class="string">- *** --- * --- .&gt; concurrency: 1 (prefork)</span></span><br><span class="line"><span class="string">-- ******* ---- .&gt; task events: OFF (enable -E to monitor tasks in this worker)</span></span><br><span class="line"><span class="string">--- ***** ----- </span></span><br><span class="line"><span class="string"> -------------- [queues]</span></span><br><span class="line"><span class="string">                .&gt; celery           exchange=celery(direct) key=celery</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[tasks]</span></span><br><span class="line"><span class="string">  . task.add</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[2018-06-06 05:25:17,206: INFO/MainProcess] Connected to redis://127.0.0.1:6379/0</span></span><br><span class="line"><span class="string">[2018-06-06 05:25:17,218: INFO/MainProcess] mingle: searching for neighbors</span></span><br><span class="line"><span class="string">[2018-06-06 05:25:18,241: INFO/MainProcess] mingle: all alone</span></span><br><span class="line"><span class="string">[2018-06-06 05:25:18,281: INFO/MainProcess] celery@localhost.localdomain ready.</span></span><br><span class="line"><span class="string">[2018-06-06 05:26:01,848: INFO/MainProcess] Received task: task.add[69c90eef-309c-45e7-a888-1357129aae6d]</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<blockquote>
<p>注意安装redis模块：pip install redis</p>
</blockquote>
</blockquote>
<h3 id="执行调度">执行调度</h3><p>导入模块并执行调度<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> task <span class="keyword">import</span> add  <span class="comment">#注意模块路径</span></span><br><span class="line">In [<span class="number">2</span>]: add.delay(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line">Out[<span class="number">2</span>]: &lt;AsyncResult: <span class="number">4e4</span>ab6aa<span class="number">-266e-4178</span>-b668<span class="number">-39</span>ada6382113&gt;</span><br></pre></td></tr></table></figure></p>
<p>查看Celery终端输出<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2018</span><span class="number">-06</span><span class="number">-06</span> <span class="number">05</span>:<span class="number">32</span>:<span class="number">20</span>,<span class="number">583</span>: INFO/ForkPoolWorker<span class="number">-1</span>] Task task.add[<span class="number">4e4</span>ab6aa<span class="number">-266e-4178</span>-b668<span class="number">-39</span>ada6382113] succeeded <span class="keyword">in</span> <span class="number">0.00385068000105</span>s: <span class="number">5</span></span><br></pre></td></tr></table></figure></p>
<p>查看结果<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">3</span>]: result = add.delay(<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: print(result.get())</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure></p>
<p>查看模块的属性列表：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: dir(result)</span><br><span class="line"></span><br><span class="line">Out[<span class="number">5</span>]: </span><br><span class="line">[<span class="string">'TimeoutError'</span>,</span><br><span class="line"> <span class="string">'__class__'</span>,</span><br><span class="line"> <span class="string">'__copy__'</span>,</span><br><span class="line"> <span class="string">'__delattr__'</span>,</span><br><span class="line"> <span class="string">'__dict__'</span>,</span><br><span class="line"> <span class="string">'__doc__'</span>,</span><br><span class="line"> <span class="string">'__eq__'</span>,</span><br><span class="line"> <span class="string">'__format__'</span>,</span><br><span class="line"> <span class="string">'__getattribute__'</span>,</span><br><span class="line"> <span class="string">'__hash__'</span>,</span><br><span class="line"> <span class="string">'__init__'</span>,</span><br><span class="line"> <span class="string">'__module__'</span>,</span><br><span class="line"> <span class="string">'__ne__'</span>,</span><br><span class="line"> <span class="string">'__new__'</span>,</span><br><span class="line"> <span class="string">u'__reduce__'</span>,</span><br><span class="line"> <span class="string">'__reduce_args__'</span>,</span><br><span class="line"> <span class="string">'__reduce_ex__'</span>,</span><br><span class="line"> <span class="string">'__repr__'</span>,</span><br><span class="line"> <span class="string">'__setattr__'</span>,</span><br><span class="line"> <span class="string">'__sizeof__'</span>,</span><br><span class="line"> <span class="string">'__str__'</span>,</span><br><span class="line"> <span class="string">'__subclasshook__'</span>,</span><br><span class="line"> <span class="string">'__unicode__'</span>,</span><br><span class="line"> <span class="string">'__unicode_repr__'</span>,</span><br><span class="line"> <span class="string">'__weakref__'</span>,</span><br><span class="line"> <span class="string">'_cache'</span>,</span><br><span class="line"> <span class="string">'_get_task_meta'</span>,</span><br><span class="line"> <span class="string">'_iter_meta'</span>,</span><br><span class="line"> <span class="string">'_maybe_reraise_parent_error'</span>,</span><br><span class="line"> <span class="string">'_maybe_set_cache'</span>,</span><br><span class="line"> <span class="string">'_on_fulfilled'</span>,</span><br><span class="line"> <span class="string">'_parents'</span>,</span><br><span class="line"> <span class="string">'_set_cache'</span>,</span><br><span class="line"> <span class="string">'_to_remote_traceback'</span>,</span><br><span class="line"> <span class="string">'app'</span>,</span><br><span class="line"> <span class="string">'as_tuple'</span>,</span><br><span class="line"> <span class="string">'backend'</span>,</span><br><span class="line"> <span class="string">'build_graph'</span>,</span><br><span class="line"> <span class="string">'children'</span>,</span><br><span class="line"> <span class="string">'collect'</span>,</span><br><span class="line"> <span class="string">'failed'</span>,</span><br><span class="line"> <span class="string">'forget'</span>,</span><br><span class="line"> <span class="string">'get'</span>,</span><br><span class="line"> <span class="string">'get_leaf'</span>,</span><br><span class="line"> <span class="string">'graph'</span>,</span><br><span class="line"> <span class="string">'id'</span>,</span><br><span class="line"> <span class="string">'info'</span>,</span><br><span class="line"> <span class="string">'iterdeps'</span>,</span><br><span class="line"> <span class="string">'maybe_reraise'</span>,</span><br><span class="line"> <span class="string">'maybe_throw'</span>,</span><br><span class="line"> <span class="string">'on_ready'</span>,</span><br><span class="line"> <span class="string">'parent'</span>,</span><br><span class="line"> <span class="string">'ready'</span>,</span><br><span class="line"> <span class="string">'result'</span>,</span><br><span class="line"> <span class="string">'revoke'</span>,</span><br><span class="line"> <span class="string">'state'</span>,</span><br><span class="line"> <span class="string">'status'</span>,</span><br><span class="line"> <span class="string">'successful'</span>,</span><br><span class="line"> <span class="string">'supports_native_join'</span>,</span><br><span class="line"> <span class="string">'task_id'</span>,</span><br><span class="line"> <span class="string">'then'</span>,</span><br><span class="line"> <span class="string">'throw'</span>,</span><br><span class="line"> <span class="string">'traceback'</span>,</span><br><span class="line"> <span class="string">'wait'</span>]</span><br></pre></td></tr></table></figure></p>
<p>获取id<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">6</span>]: print(result.id)</span><br><span class="line"><span class="number">30</span>f7fce2<span class="number">-2687</span><span class="number">-448</span>c<span class="number">-816</span>f<span class="number">-11334</span>efc6442</span><br></pre></td></tr></table></figure></p>
<p>登录reids查看<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost python]<span class="comment"># redis-cli</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; KEYS *</span><br><span class="line"><span class="number">1</span>) <span class="string">"_kombu.binding.celery.pidbox"</span></span><br><span class="line"><span class="number">2</span>) <span class="string">"celery-task-meta-69c90eef-309c-45e7-a888-1357129aae6d"</span></span><br><span class="line"><span class="number">3</span>) <span class="string">"_kombu.binding.celery"</span></span><br><span class="line"><span class="number">4</span>) <span class="string">"_kombu.binding.celeryev"</span></span><br><span class="line"><span class="number">5</span>) <span class="string">"celery-task-meta-4e4ab6aa-266e-4178-b668-39ada6382113"</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get celery-task-meta<span class="number">-4e4</span>ab6aa<span class="number">-266e-4178</span>-b668<span class="number">-39</span>ada6382113</span><br><span class="line"><span class="string">"&#123;\"status\": \"SUCCESS\", \"traceback\": null, \"result\": 5, \"task_id\": \"4e4ab6aa-266e-4178-b668-39ada6382113\", \"children\": []&#125;"</span></span><br></pre></td></tr></table></figure></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2018/06/16/Celery-分布式任务队列/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-06-16 </div>
			<div class="article-title"><a href="/2018/06/16/Python-Zabbix-Api/">Python Zabbix Api</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h3 id="请求的方法参数">请求的方法参数</h3><p>官方原文：</p>
<ul>
<li><strong>jsonrpc</strong> - the version of the JSON-RPC protocol used by the API; the  Zabbix API implements JSON-RPC version 2.0;</li>
<li><strong>method</strong> - the API method being called;</li>
<li><strong>params</strong> - parameters that will be passed to the API method;</li>
<li><strong>id</strong> - an arbitrary identifier of the request;</li>
<li><strong>auth</strong> - a user authentication token; since we don’t have one yet, it’s set to null.</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th style="text-align:center">值类型</th>
<th style="text-align:left">说明</th>
<th>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td>jsonrpc</td>
<td style="text-align:center">str</td>
<td style="text-align:left">接口版本</td>
<td>是</td>
</tr>
<tr>
<td>method</td>
<td style="text-align:center">str</td>
<td style="text-align:left">请求方法</td>
<td>是</td>
</tr>
<tr>
<td>params</td>
<td style="text-align:center">json</td>
<td style="text-align:left">请求方法参数</td>
<td>是</td>
</tr>
<tr>
<td>user</td>
<td style="text-align:center">str</td>
<td style="text-align:left">zabbix账号</td>
<td>是</td>
</tr>
<tr>
<td>password</td>
<td style="text-align:center">str</td>
<td style="text-align:left">zabbix密码</td>
<td>是</td>
</tr>
<tr>
<td>auth</td>
<td style="text-align:center">str</td>
<td style="text-align:left">认证的key</td>
<td>是</td>
</tr>
<tr>
<td>id</td>
<td style="text-align:center">int</td>
<td style="text-align:left">认证id</td>
<td>是</td>
</tr>
</tbody>
</table>
<p>请求事例：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST http://company.com/zabbix/api_jsonrpc.php HTTP/1.1</span><br><span class="line">Content-Type: application/json-rpc</span><br><span class="line"></span><br><span class="line">&#123;"jsonrpc":"2.0","method":"apiinfo.version","id":1,"auth":null,"params":&#123;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="python获取token">python获取token</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys, argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zabbix_Api</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.url = <span class="string">'http://IP/zabbix/api_jsonrpc.php'</span></span><br><span class="line">        self.header = &#123;<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>&#125;</span><br><span class="line">        self.id = <span class="number">1</span></span><br><span class="line">        self.user=<span class="string">"zabbix登录账号"</span></span><br><span class="line">        self.password=<span class="string">"zabbix登录密码"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">json_obj</span><span class="params">(self,method,auth=True,params=&#123;&#125;)</span>:</span></span><br><span class="line">        obj = &#123;<span class="string">'jsonrpc'</span>: <span class="string">'2.0'</span>,</span><br><span class="line">               <span class="string">'method'</span>: method,</span><br><span class="line">               <span class="string">'params'</span>: params,</span><br><span class="line">               <span class="string">'auth'</span>: auth,</span><br><span class="line">               <span class="string">'id'</span>: self.id&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth:</span><br><span class="line">            <span class="keyword">del</span> obj[<span class="string">"auth"</span>]</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_login</span><span class="params">(self)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"user.login"</span>,auth=<span class="keyword">False</span>, params=&#123;<span class="string">"user"</span>: self.user, <span class="string">"password"</span>: self.password&#125;)</span><br><span class="line">        <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(Zabbix_Api().user_login())</span><br></pre></td></tr></table></figure>
<h3 id="获取版本信息">获取版本信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_version</span><span class="params">(self)</span>:</span></span><br><span class="line">    data=self.json_obj(method=<span class="string">"apiinfo.version"</span>,</span><br><span class="line">        params=&#123;</span><br><span class="line">            <span class="string">"output"</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        auth=<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)</span><br></pre></td></tr></table></figure>
<h3 id="host-get方法获取所有的主机ID">host.get方法获取所有的主机ID</h3><table>
<thead>
<tr>
<th>参数名称</th>
<th style="text-align:center">值类型</th>
<th style="text-align:left">说明</th>
<th>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td>jsonrpc</td>
<td style="text-align:center">str</td>
<td style="text-align:left">接口版本</td>
<td>是</td>
</tr>
<tr>
<td>method</td>
<td style="text-align:center">str</td>
<td style="text-align:left">请求方法</td>
<td>是</td>
</tr>
<tr>
<td>params</td>
<td style="text-align:center">json</td>
<td style="text-align:left">请求方法参数</td>
<td>是</td>
</tr>
<tr>
<td>output</td>
<td style="text-align:center">array</td>
<td style="text-align:left">输出格式</td>
<td>是</td>
</tr>
<tr>
<td>groupids</td>
<td style="text-align:center">str/array</td>
<td style="text-align:left">主机组id</td>
<td>是</td>
</tr>
<tr>
<td>auth</td>
<td style="text-align:center">str</td>
<td style="text-align:left">认证的key</td>
<td>是</td>
</tr>
<tr>
<td>id</td>
<td style="text-align:center">int</td>
<td style="text-align:left">认证id</td>
<td>是</td>
</tr>
</tbody>
</table>
<p>请求事例(参考上面类)：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_host</span><span class="params">(self)</span>:</span></span><br><span class="line">    data=self.json_obj(method=<span class="string">"host.get"</span>,</span><br><span class="line">        params=&#123;</span><br><span class="line">            <span class="string">"output"</span>: [<span class="string">"hostid"</span>, <span class="string">"name"</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        auth=self.user_login())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)</span><br></pre></td></tr></table></figure></p>
<h3 id="itemsid-get方法获取单个主机下所有的监控项ID">itemsid.get方法获取单个主机下所有的监控项ID</h3><table>
<thead>
<tr>
<th>参数名称</th>
<th style="text-align:center">值类型</th>
<th style="text-align:left">说明</th>
<th>是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td>jsonrpc</td>
<td style="text-align:center">str</td>
<td style="text-align:left">接口版本</td>
<td>是</td>
</tr>
<tr>
<td>method</td>
<td style="text-align:center">str</td>
<td style="text-align:left">请求方法</td>
<td>是</td>
</tr>
<tr>
<td>params</td>
<td style="text-align:center">json</td>
<td style="text-align:left">请求方法参数</td>
<td>是</td>
</tr>
<tr>
<td>output</td>
<td style="text-align:center">array</td>
<td style="text-align:left">输出格式</td>
<td>是</td>
</tr>
<tr>
<td>groupids</td>
<td style="text-align:center">str/array</td>
<td style="text-align:left">主机组id</td>
<td>是</td>
</tr>
<tr>
<td>auth</td>
<td style="text-align:center">str</td>
<td style="text-align:left">认证的key</td>
<td>是</td>
</tr>
<tr>
<td>id</td>
<td style="text-align:center">int</td>
<td style="text-align:left">认证id</td>
<td>是</td>
</tr>
</tbody>
</table>
<p>请求事例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mem_total</span><span class="params">(self,hostid)</span>:</span></span><br><span class="line">    data=self.json_obj(method=<span class="string">"item.get"</span>,</span><br><span class="line">        params=&#123;</span><br><span class="line">            <span class="string">"output"</span>: <span class="string">"extend"</span>,</span><br><span class="line">            <span class="string">"hostids"</span>: hostid,</span><br><span class="line">            <span class="string">"search"</span>: &#123;</span><br><span class="line">                <span class="string">"key_"</span>: <span class="string">"vm.memory.size[total]"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        auth=self.user_login())</span><br><span class="line">    <span class="keyword">return</span> int(json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>][<span class="number">0</span>][<span class="string">"lastvalue"</span>])/<span class="number">1024</span>/<span class="number">1024</span>/<span class="number">1024</span></span><br></pre></td></tr></table></figure></p>
<h3 id="以上完整事例">以上完整事例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys, argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Zabbix_Api</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.url = <span class="string">'http://192.168.31.249/zabbix/api_jsonrpc.php'</span></span><br><span class="line">        self.header = &#123;<span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>&#125;</span><br><span class="line">        self.id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">json_obj</span><span class="params">(self,method,auth=True,params=&#123;&#125;)</span>:</span></span><br><span class="line">        obj = &#123;<span class="string">'jsonrpc'</span>: <span class="string">'2.0'</span>,</span><br><span class="line">               <span class="string">'method'</span>: method,</span><br><span class="line">               <span class="string">'params'</span>: params,</span><br><span class="line">               <span class="string">'auth'</span>: auth,</span><br><span class="line">               <span class="string">'id'</span>: self.id&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth:</span><br><span class="line">            <span class="keyword">del</span> obj[<span class="string">"auth"</span>]</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_login</span><span class="params">(self)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"user.login"</span>,auth=<span class="keyword">False</span>, params=&#123;<span class="string">"user"</span>: <span class="string">"yunwei"</span>, <span class="string">"password"</span>: <span class="string">"yunwei"</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_host</span><span class="params">(self)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"host.get"</span>,</span><br><span class="line">            params=&#123;</span><br><span class="line">                <span class="string">"output"</span>: [<span class="string">"hostid"</span>, <span class="string">"name"</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            auth=self.user_login())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_mem_total</span><span class="params">(self,hostid)</span>:</span></span><br><span class="line">        data=self.json_obj(method=<span class="string">"item.get"</span>,</span><br><span class="line">            params=&#123;</span><br><span class="line">                <span class="string">"output"</span>: <span class="string">"extend"</span>,</span><br><span class="line">                <span class="string">"hostids"</span>: hostid,</span><br><span class="line">                <span class="string">"search"</span>: &#123;</span><br><span class="line">                    <span class="string">"key_"</span>: <span class="string">"vm.memory.size[total]"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            auth=self.user_login())</span><br><span class="line">        <span class="keyword">return</span> int(json.loads(requests.post(url=self.url, headers=self.header, data=json.dumps(data)).text)[<span class="string">"result"</span>][<span class="number">0</span>][<span class="string">"lastvalue"</span>])/<span class="number">1024</span>/<span class="number">1024</span>/<span class="number">1024</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># for k in Zabbix_Api().get_host()["result"]:</span></span><br><span class="line">    <span class="comment">#     print(k["hostid"],k["name"],str(round(Zabbix_Api().get_mem(k["hostid"]),2))+"G")</span></span><br><span class="line">    print(Zabbix_Api().get_mem_total(<span class="number">10084</span>))</span><br></pre></td></tr></table></figure>
<p>以上只是简单举例，具体实践可参考官网文档(要永远相信官方文档是最好的文档)：<a href="https://www.zabbix.com/documentation/3.0/manual/api" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.0/manual/api</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2018/06/16/Python-Zabbix-Api/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div class="widget tag">
    <h3 class="title">归档</h3>
    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">2019年02月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">2018年07月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">2018年06月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">2018年05月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">2018年03月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">2018年02月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">2018年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">2017年11月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">2017年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">2017年08月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">2017年07月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">2017年03月</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">2017年02月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">2016年01月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">2015年12月</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">2015年11月</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">2015年10月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">2015年09月</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">2015年08月</a><span class="archive-list-count">5</span></li></ul>
  </div>

		
			
		
			

		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2019/02/18/如何搭建高可用Docker-Harbor仓库/"><i class="fa fa-file-o"></i>如何搭建高可用Docker Harbor仓库</a>
      </li>
    
      <li>
        <a href="/2019/02/17/Python调用Jenkins-api-文档/"><i class="fa fa-file-o"></i>Python调用Jenkins api 文档</a>
      </li>
    
      <li>
        <a href="/2019/02/17/centos7-docker-使用ss科学上网/"><i class="fa fa-file-o"></i>centos7 docker 使用ss科学上网</a>
      </li>
    
      <li>
        <a href="/2019/02/17/分布式时序数据库InfluxDB/"><i class="fa fa-file-o"></i>分布式时序数据库InfluxDB</a>
      </li>
    
      <li>
        <a href="/2018/07/29/企业常用几种部署方式-蓝绿部署、滚动部署、金丝雀部署/"><i class="fa fa-file-o"></i>企业常用几种部署方式(蓝绿部署、滚动部署、金丝雀部署)</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://linuxops.cc" title="Macro博客" target="_blank" ]);">Macro博客</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.uinion.com/" title="uinion小站" target="_blank" ]);">uinion小站</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 林文杰
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'ZP2ZSuHgipSZfRyU8uTR','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'linuxunix' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
