<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Page 6 | BY DevOps | 今晚打老虎</title>
  <meta name="author" content="林文杰">
  
  <meta name="description" content="DevOps 技术运维小学生">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="BY DevOps | 今晚打老虎">

  
    <meta property="og:image" content="undefined">
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>
</html>
 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">BY DevOps | 今晚打老虎</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1>记录Linux的点点滴滴（DevOps技术运维小学生）</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Welcome to my blog.
</div>    

		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-02-14 </div>
			<div class="article-title"><a href="/2017/02/14/阿里云CDN缓存刷新（PYTHON实现）/">阿里云CDN缓存刷新（PYTHON实现）</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p><strong>阿里云CDN缓存刷新（PYTHON实现）</strong><br><strong>项目背景：</strong><br>由来：由于作者公司把Ucloud云服务器迁移到阿里云上，并使用了阿里的OSS文件系统，出于成本考虑并使用上阿里的CDN服务。但是迁移后，开发隔三两日就跑过来叫帮忙刷新缓存。当时思想，每次这样搞并发长久之策，便尝试编写缓存系统。<br><strong>编写过程</strong><br>1、查阅官方API文档<br><a href="https://help.aliyun.com/document_detail/27200.html?spm=5176.doc27201.6.624.B0NT84" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/27200.html?spm=5176.doc27201.6.624.B0NT84</a><br>2、选择前端框架<br>觉得最快实现还是选择Bootstrap<br>3、选择后端框架<br>选择基于PYTHON的DJANGO框架<br><strong>部分截图</strong><br><img src="/img/201702/aliyun1.png" style="width: 550x;"><br><img src="/img/201702/aliyun2.png" style="width: 550x;"></p>
<p><strong>Github地址</strong><br><a href="https://github.com/linuxunix/AliCDN/" target="_blank" rel="external">https://github.com/linuxunix/AliCDN/</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2017/02/14/阿里云CDN缓存刷新（PYTHON实现）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-02-14 </div>
			<div class="article-title"><a href="/2017/02/14/DJANGO模型及查询/">DJANGO模型及查询</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p><strong>DJANGO模型及查询</strong><br><strong><em>MTV 开发模式</em></strong><br>在钻研更多代码之前，让我们先花点时间考虑下 Django 数据驱动 Web 应用的总体设计。<br>为什么用缩写？<br>像 MVC 这样的明确定义模式的主要用于改善开发人员之间的沟通。 比起告诉同事，“让我们采用抽象的数据存取方式，然后单独划分一层来显示数据，并且在中间加上一个控制它的层”，一个通用的说法会让你收益，你只需要说：“我们在这里使用MVC模式吧。”。<br>Django 紧紧地遵循这种 MVC 模式，可以称得上是一种 MVC 框架。 以下是 Django 中 M、V 和 C 各自的含义：<br>M ，数据存取部分，由django数据库层处理。<br>V ，选择显示哪些数据要显示以及怎样显示的部分，由视图和模板处理。<br>C ，根据用户输入委派视图的部分，由 Django 框架根据 URLconf 设置，对给定 URL 调用适当的 Python 函数。</p>
<p><strong>数据库配置</strong><br>Mysql数据库需要安装mysqld-python：<br>yum install python-devel mysql-devel zlib-devel openssl-devel -y</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim settings.py</span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,   <span class="comment">###mysql</span></span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'db_name'</span>, </span><br><span class="line">        <span class="string">'USER'</span>:<span class="string">'username'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>:<span class="string">'db_host'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>:<span class="string">'db_password'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编写Model</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">254</span>,verbose_name=<span class="string">u'标题'</span>)</span><br><span class="line">    type_choices=(</span><br><span class="line">        (<span class="string">u'Linux运维'</span>,<span class="string">u'Linux运维'</span>),</span><br><span class="line">        (<span class="string">u'Python编程'</span>,<span class="string">u'Python编程'</span>),</span><br><span class="line">    )</span><br><span class="line">    type = models.CharField(choices=type_choices, max_length=<span class="number">128</span>,verbose_name=<span class="string">u'分类'</span>)</span><br><span class="line">    category = models.ForeignKey(<span class="string">'Category'</span>,verbose_name=<span class="string">u'标签'</span>)</span><br><span class="line">    summary = models.TextField(max_length=<span class="number">500</span>)</span><br><span class="line">    author = models.ForeignKey(<span class="string">'UserProfile'</span>)</span><br><span class="line">    content = models.TextField(max_length=<span class="number">100000</span>)</span><br><span class="line">    head_img = models.ImageField(upload_to=<span class="string">"static/imgs/upload"</span>)</span><br><span class="line">    publish_date =models.DateTimeField(auto_now_add=<span class="keyword">True</span>,verbose_name=<span class="string">u'创建时间'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br></pre></td></tr></table></figure></p>
<p>执行thon manage.py migrate新增表<br><strong>查询</strong><br><img src="/img/201702/showtables.png" style="width: 550x;"><br>进入python manage.py  shell<br><strong>查询全部文章</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> blog <span class="keyword">import</span> models</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a=models.Article.objects.all()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> a</span><br><span class="line">&lt;QuerySet [&lt;Article: NGINX隐藏版本号&gt;, &lt;Article: MYSQL主从复制&gt;, &lt;Article: CentOS终端如何显示中文同时出现乱码怎么办？&gt;, &lt;Article: EXSI5<span class="number">.5</span>安装vSphere&gt;, &lt;Article: PYTHON 和MYSQL交互&gt;, &lt;Article: JENKINS安装&gt;, &lt;Article: python-nmap端口扫描&gt;, &lt;Article: MONGODB索引优化案例&gt;, &lt;Article: SSH批量登录并执行命令（PYTHON实现）&gt;, &lt;Article: 集群与高可用之LVS介绍&gt;, &lt;Article: DJANGO登陆注销&gt;]&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>查询最新发表的前5篇文章</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> blog <span class="keyword">import</span> models</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = models.Article.objects.all().order_by(<span class="string">'-publish_date'</span>)[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> b</span><br><span class="line">&lt;QuerySet [&lt;Article: DJANGO登陆注销&gt;, &lt;Article: 集群与高可用之LVS介绍&gt;, &lt;Article: SSH批量登录并执行命令（PYTHON实现）&gt;, &lt;Article: MONGODB索引优化案例&gt;, &lt;Article: python-nmap端口扫描&gt;]&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>查询带有MYSQL的文章</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c= models.Article.objects.filter(title__icontains=<span class="string">'mysql'</span>)   <span class="comment">### icontains不区分大小写</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> c</span><br><span class="line">&lt;QuerySet [&lt;Article: MYSQL主从复制&gt;, &lt;Article: PYTHON 和MYSQL交互&gt;]&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c= models.Article.objects.filter(title__contains=<span class="string">'MYSQL'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> c</span><br><span class="line">&lt;QuerySet [&lt;Article: MYSQL主从复制&gt;, &lt;Article: PYTHON 和MYSQL交互&gt;]&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c= models.Article.objects.filter(title__contains=<span class="string">'mysql'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> c</span><br><span class="line">&lt;QuerySet []&gt;</span><br></pre></td></tr></table></figure></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2017/02/14/DJANGO模型及查询/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-02-14 </div>
			<div class="article-title"><a href="/2017/02/14/django登陆注销/">django登陆注销</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>#django登陆注销<br>任何一个动态系统基本离不开登录和注销，现在作为运维自动化的追随者使用python语言的较多。当然你坚持PHP是世界上最好的语言那我也没有办法。下面介绍下DJANGO框架的登录和注销<br><strong>Views代码</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> authenticate,login,logout</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required<span class="comment">#登陆后才能进入系统的模块</span></span><br><span class="line"><span class="meta">@login_required  #登陆后才能进入系统</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">acc_login</span><span class="params">(request)</span>:</span></span><br><span class="line">    login_err = <span class="string">''</span></span><br><span class="line">    <span class="comment"># print request.POST</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">'inputUsername'</span>)</span><br><span class="line">        password = request.POST.get(<span class="string">'inputPassword'</span>)</span><br><span class="line">        user = authenticate(username=username, password=password)</span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            login(request,user)</span><br><span class="line">            <span class="keyword">if</span> user.is_active:</span><br><span class="line">                <span class="keyword">return</span> HttpResponseRedirect(<span class="string">'/'</span>)</span><br><span class="line">        login_err = <span class="string">"请检查用户名和密码是否正确"</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, &#123;</span><br><span class="line">        <span class="string">'login_err'</span>: login_err</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">acc_logout</span><span class="params">(request)</span>:</span></span><br><span class="line">    logout(request)</span><br><span class="line">    <span class="keyword">return</span>  HttpResponseRedirect(<span class="string">"/"</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>URLS代码</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> app1 <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^$'</span>,views.index),</span><br><span class="line">    url(<span class="string">r'^index.html'</span>,views.index),</span><br><span class="line">    url(<span class="string">r'^login/$'</span>,views.acc_login),</span><br><span class="line">    url(<span class="string">r'^logout/$'</span>,views.acc_logout,name=<span class="string">'acc_logout'</span>), <span class="comment">####添加name作用是在前端使用&#123;% url 'acc_logout' %&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>前端index.html</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul class="nav navbar-nav navbar-right"&gt;</span><br><span class="line">    &#123;% if request.user.is_authenticated %&#125;  &lt;!-- 判断用户是否已登录 --&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href="#"&gt;欢迎您：&#123;&#123; request.user &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">      &lt;li&gt;&lt;a href="&#123;% url 'acc_logout' %&#125;"&gt;注销&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">         &lt;li&gt;&lt;a href="/login/"&gt;登陆&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">         &lt;li&gt;&lt;a href="/reg/"&gt;注册&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure></p>
<p><strong>前端login.htm</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="container"&gt;</span><br><span class="line">  &lt;form class="form-signin" method="post"&gt;&#123;% csrf_token %&#125;</span><br><span class="line">    &lt;h2 class="form-signin-heading"&gt;Please sign in&lt;/h2&gt;</span><br><span class="line">    &lt;label for="text" class="sr-only"&gt;Username&lt;/label&gt;</span><br><span class="line">    &lt;input type="text" name="inputUsername" class="form-control" placeholder="Username" required autofocus&gt;</span><br><span class="line">    &lt;label for="inputPassword" class="sr-only"&gt;Password&lt;/label&gt;</span><br><span class="line">    &lt;input type="password" name="inputPassword" class="form-control" placeholder="Password" required&gt;</span><br><span class="line">    &lt;div class="checkbox"&gt;</span><br><span class="line">      &lt;label&gt;</span><br><span class="line">        &lt;input type=<span class="string">"checkbox"</span> value=<span class="string">"remember-me"</span>&gt; Remember me</span><br><span class="line">      &lt;/label&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;span style="color: red;"&gt;&#123;&#123; login_err &#125;&#125;&lt;/span&gt;</span><br><span class="line">    &lt;button class="btn btn-lg btn-primary btn-block" type="submit"&gt;Sign in&lt;/button&gt;</span><br></pre></td></tr></table></figure></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2017/02/14/django登陆注销/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-02-14 </div>
			<div class="article-title"><a href="/2017/02/14/python-nmap端口扫描/">python-nmap端口扫描</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>python-nmap是python的一个模块库，使用这个模块可以让python很方便的操作nmap扫描器来工作，它可以帮助管理员完成自动扫描任务和生成报告的工具，它还支持nmap的脚步输出。</p>
<p><strong>坏境准备：</strong></p>
<p>###1、安装python-nmap和yum install nmap</p>
<p>[root@localhost ~]# pip install python-nmap<br>You are using pip version 7.1.0, however version 9.0.1 is available.<br>You should consider upgrading via the ‘pip install –upgrade pip’ command.<br>Collecting python-nmap<br>  Downloading python-nmap-0.6.1.tar.gz (41kB)<br>    100%  45kB 40kBs<br>Installing collected packages python-nmap<br>  Running setup.py install for python-nmap<br>Successfully installed python-nmap-0.6.1</p>
<p>具体查看链接：<a href="http://xael.org/pages/python-nmap-en.html" target="_blank" rel="noopener">http://xael.org/pages/python-nmap-en.html</a><br>[root@localhost ~]# yum install –y nmap</p>
<p>###2、python 脚本代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost shell]<span class="comment"># cat saomiao.py </span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> nmap</span><br><span class="line"></span><br><span class="line">scan_row = [ ]</span><br><span class="line">input_data = raw_input(<span class="string">'Please input host and port: '</span>)</span><br><span class="line">scan_row = input_data.split(<span class="string">" "</span>)</span><br><span class="line"><span class="keyword">if</span> len( scan_row ) !=<span class="number">2</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Input errors,example\"192.168.1.0/24 80,443,22\""</span></span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line">hosts = scan_row[<span class="number">0</span>]  <span class="comment">#接收用户输入的主机</span></span><br><span class="line">port = scan_row[<span class="number">1</span>]  <span class="comment">#接收用户输入的端口</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    nm = nmap.PortScanner() <span class="comment">#创建端口扫描对象</span></span><br><span class="line"><span class="keyword">except</span> nmap.PortScannerError:</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'Nmap not found,'</span>,sys.exc_info()[<span class="number">0</span>])</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    nm.scan(hosts=hosts,arguments=<span class="string">'-v -sS -p '</span>+port)</span><br><span class="line"><span class="keyword">except</span> Exception,e:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Scan error:"</span>+str(e)</span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> nm.all_hosts():</span><br><span class="line">    print(<span class="string">'----------------------------------------------------'</span>)</span><br><span class="line">    print(<span class="string">'Host : %s (%s)'</span> % (host, nm[host].hostname()))</span><br><span class="line">    print(<span class="string">'State : %s'</span> % nm[host].state())</span><br><span class="line">    <span class="keyword">for</span> proto <span class="keyword">in</span> nm[host].all_protocols():</span><br><span class="line">        print(<span class="string">'----------'</span>)</span><br><span class="line">        print(<span class="string">'Protocol : %s'</span> % proto)</span><br><span class="line">        lport = nm[host][proto].keys()</span><br><span class="line">        lport.sort()</span><br><span class="line">        <span class="keyword">for</span> port <span class="keyword">in</span> lport:</span><br><span class="line">            <span class="keyword">print</span> (<span class="string">'port : %s\tstate : %s'</span> % (port, nm[host][proto][port][<span class="string">'state'</span>]))</span><br></pre></td></tr></table></figure></p>
<p>###3、执行测试<br>如果执行过程出现报错：<br>[root@localhost shell]# python nmap.py<br>Please input host and port: 192.168.1.200 80<br>Traceback (most recent call last):<br>  File “nmap.py”, line 4, in <module><br>    import nmap<br>  File “/data/shell/nmap.py”, line 16, in <module><br>    except nmap.PortScannerError:<br>AttributeError: ‘module’ object has no attribute ‘PortScannerError’</module></module></p>
<p>发现，脚本名称为nmap.py 更改名称后执行正常。</p>
<p>###Port scanning result： </p>
<ul>
<li><strong>10.6.17.83</strong> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">10</span><span class="number">-6</span><span class="number">-17</span><span class="number">-83</span> shell]<span class="comment"># python saomiao.py </span></span><br><span class="line">Please input host <span class="keyword">and</span> port: <span class="number">10.6</span><span class="number">.17</span><span class="number">.83</span> <span class="number">1</span><span class="number">-65535</span></span><br><span class="line"> ---------------------------------------------------- </span><br><span class="line"> Host : <span class="number">10.6</span><span class="number">.17</span><span class="number">.83</span> (localhost) State : up </span><br><span class="line"> Protocol : tcp port : <span class="number">3306</span> state : open </span><br><span class="line"> port : <span class="number">8022</span> state : open </span><br><span class="line"> port : <span class="number">8080</span> state : open </span><br><span class="line"> port : <span class="number">10050</span> state : open </span><br><span class="line"> port : <span class="number">10051</span> state : open</span><br></pre></td></tr></table></figure>
</li>
</ul>

	
	</div>
	
  
</div>
	<a type="button" href="/2017/02/14/python-nmap端口扫描/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-01-23 </div>
			<div class="article-title"><a href="/2016/01/23/EXSI5-5░▓╫░vSphere/">EXSI5.5安装vSphere </a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>什么是EXSI？？？</p>
<p>ESXi专为运行虚拟机、最大限度降低配置要求和简化部署而设计。只需几分钟时间，客户便可完成从安装到运行虚拟机的全过程，特别是在下载并安装预配置虚拟设备的时候。<br>ESXi 专为运行虚拟机、最大限度降低配置要求和简化部署而设计。只需几分钟时间，客户便可完成从安装到运行虚拟机的全过程，特别是在下载并安装预配置虚拟设备的 时候。在VMware Virtual Appliance Marketplace 上有800多款为VMware hypervisor 创建的虚拟设备，如今，ESXi已经实现了与Virtual Appliance Marketplace的直接整合，使用户能够即刻下载并运行虚拟设备。这为即插即用型软件的交付与安装提供了一种全新和极其简化的方式。</p>
<p>那vSphere是啥？<br>VMware vSphere 是业界领先且最可靠的虚拟化平台。vSphere将应用程序和操作系统从底层硬件分离出来，从而简化了 IT操作。您现有的应用程序可以看到专有资源，而您的服务器则可以作为资源池进行管理。因此，您的业务将在简化但恢复能力极强的 IT 环境中运行。其实vSphere将应用程序和操作系统从底层硬件分离出来,我们通过vSphere管理多台EXSI主机，实现例如克隆主机等一系列操作，从而简化单独对一台台主机操作。</p>
<blockquote>
<p>安装EXSI实战：</p>
</blockquote>
<p>机器：戴尔R720服务器<br>安装EXSI：<a href="http://www.dell.com/Support/Article/cn/zh/cnbsd1/SLN287730" target="_blank" rel="noopener">http://www.dell.com/Support/Article/cn/zh/cnbsd1/SLN287730</a>  （本来计划写一遍安装教程，但是发现网上太多了，同时他们写的都比自己好，就直接搬戴尔知识库的上来分享给有需要的小伙伴,同时已经介绍如何安装虚拟机，当然建议小伙伴们安装WIN2008）</p>
<blockquote>
<p>安装vSphere(由于手内暂时得一台空闲的实体机，搭建HA、分布式交换机那些暂时先不说|</p>
</blockquote>
<p>1、官网下载vSphere：  <a href="https://my.vmware.com/cn/web/vmware/downloads" target="_blank" rel="noopener">https://my.vmware.com/cn/web/vmware/downloads</a><br>2、把安装挂载在WIN2008机器上：</p>
<p><br><img src="/img/201601/vSphere1.png" style="width: 550x;"></p>
<p><br><img src="/img/201601/vSphere2.png" style="width: 550x;"></p>
<blockquote>
<p>安装Vcenter Single sign-On</p>
</blockquote>
<p><br><img src="/img/201601/vSphere3.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere4.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere5.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere6.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere7.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere8.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere9.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere10.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere11.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere12.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere13.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere14.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere15.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere16.png" style="width: 550x;"><br>默认就行把sso密码输入即可<br><br><img src="/img/201601/vSphere17.png" style="width: 550x;"></p>
<blockquote>
<p>安装vcenter server</p>
</blockquote>
<p><br><img src="/img/201601/vSphere18.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere19.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere20.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere21.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere22.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere23.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere24.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere25.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere26.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere27.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere28.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere29.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere30.png" style="width: 550x;"><br><br><img src="/img/201601/vSphere31.png" style="width: 550x;"></p>
<blockquote>
<p>客户端登陆</p>
</blockquote>
<p><br><img src="/img/201601/vSphere32.png" style="width: 550x;"><br>administrator@vsphere.local密码是SSO创建的密码<br><br><img src="/img/201601/vSphere33.png" style="width: 550x;"></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2016/01/23/EXSI5-5░▓╫░vSphere/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-01-23 </div>
			<div class="article-title"><a href="/2016/01/23/soltstack░▓╫░/">soltstack安装</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <blockquote>
<p>SaltStack是什么？</p>
</blockquote>
<p>Salt是一种和以往不同的基础设施管理方法，它是建立在大规模系统高速通讯能力可以大幅提升的想法上。这种方法使得Salt成为一个强大的能够解决基础设施中许多特定问题的多任务系统。远程执行引擎是Salt的核心，它能够为多组系统创建高速、安全的双向通讯网络。基于这个通许系统，Salt提供了一个非常快速、灵活并且容易使用的配置管理系统，称之为“Salt States”。</p>
<blockquote>
<p>安装准备</p>
</blockquote>
<p>rpm -Uvh <a href="http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="noopener">http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a><br>Salt的master和minion包是分开的。机器只需要安装相应的包即可运行。通常情况下，会有一个master和多个minions。<br>在salt-master上，运行:<br>yum install salt-master<br>在salt-minion上，运行:<br>yum install salt-minion</p>
<blockquote>
<p>实战安装</p>
<p>Master:192.168.108.129</p>
</blockquote>
<p>[root@server1 ~]# rpm -Uvh <a href="http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="noopener">http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a><br>Retrieving <a href="http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="noopener">http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a><br>warning: /var/tmp/rpm-tmp.iZuZME: Header V3 RSA/SHA256 Signature, key ID 0608b895: NOKEY<br>Preparing…                ########################################### [100%]<br>    package epel-release-6-8.noarch is already installed<br>[root@server1 ~]# yum install -y salt-master<br>已加载插件：fastestmirror, refresh-packagekit, security<br>设置安装进程<br>Loading mirror speeds from cached hostfile<br>epel/metalink                                                                                                                                   | 5.4 kB     00:00     </p>
<ul>
<li>base: mirrors.aliyun.com<br>….省略</li>
</ul>
<blockquote>
<p>Minion：192.168.108.141</p>
</blockquote>
<p>[root@server2 ~]# rpm -Uvh <a href="http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm" target="_blank" rel="noopener">http://ftp.linux.ncsu.edu/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</a><br>[root@server2 ~]# yum install -y salt-minion </p>
<p>Master<br>配置master开机自动启动:<br>[root@server2 ~]# chkconfig salt-master on<br>启动Master:<br>[root@server1 ~]# service salt-master start<br>Starting salt-master daemon:                               [确定]<br>[root@server1 ~]# lsof -i:4505<br>COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>salt-mast 2833 root   12u  IPv4  22272      0t0  TCP *:4505 (LISTEN)</p>
<p>Minion<br>配置Minion开机自动启动:<br>[root@server2 ~]# chkconfig salt-minion on<br>启动Minion:<br>[root@server2 ~]# chkconfig salt-minion on<br>Starting salt-minion daemon:                               [确定]<br>[root@server2 ~]# vim /etc/salt/minion —配置文件<br>[root@server2 ~]# grep -v ‘^#’ /etc/salt/minion<br>master: 192.168.108.129</p>
<blockquote>
<p>测试</p>
</blockquote>
<p>Master<br>[root@server1 ~]# salt-key<br>Accepted Keys:<br>Denied Keys:<br>Unaccepted Keys:<br>server2   —默认是主机2的系统名，可以修改/etc/salt/minion的id字段<br>Rejected Keys:<br>把server2加入监控列表<br>[root@server1 ~]# salt-key -a server2<br>The following keys are going to be accepted:<br>Unaccepted Keys:<br>server2<br>Proceed? [n/Y] y<br>Key for minion server2 accepted.<br>[root@server1 ~]# salt-key<br>Accepted Keys:<br>server2<br>Denied Keys:<br>Unaccepted Keys:<br>Rejected Keys:<br>测试<br>[root@server1 ~]# salt ‘<em>‘ test.ping  &lt;==</em>代表所有主机<br>server2:<br>    True<br>[root@server1 ~]# salt ‘*’ cmd.run ‘df -h’ &lt;==远程执行命令<br>server2:<br>    Filesystem                    Size  Used Avail Use% Mounted on<br>    /dev/mapper/VolGroup-lv_root   18G  8.2G  8.4G  50% /<br>    tmpfs                         491M   92K  491M   1% /dev/shm<br>    /dev/sda1                     485M   35M  426M   8% /boot<br>    /dev/sr0                      4.2G  4.2G     0 100% /media/CentOS_6.5_Final</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2016/01/23/soltstack░▓╫░/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-01-23 </div>
			<div class="article-title"><a href="/2016/01/23/mongodb╦ў╥¤╙┼╗п░╕└¤/">mongodb索引优化案例</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>通过mongodb查看日志发现一堆等待信息,同时发现日志文件太大，日志格式如下：</p>
<p>2016-01-19T00:00:04.739+0800 [conn1788] warning: ClientCursor::staticYield can’t unlock b/c of recursive lock ns:  top: { opid: 18394915, active: true, secs_running: 1, op: “query”, ns: “”, query: { findAndModify: “AutoDesign”, query: { RequestState: 1, RequestType: 0 }, sort: { RequestTime: 1 }, update: { $set: { RequestState: 2, HandleTime: new Date(1453132701269), ArrangeMachineIp: “10.X.X.X” } } }, client: “10.X.X.X”, desc: “conn1788”, threadId: “0x7f49bb859700”, connectionId: 1788, locks: { ^: “w”, ^JIAXXX: “W” }, waitingForLock: false, numYields: 0, lockStats: { timeLockedMicros: {}, timeAcquiringMicros: { r: 0, w: 5 } } }</p>
<p><br><img src="/img/201601/mongodb.png" style="width: 650x;"></p>
<p>explain 操作提供了查询信息，使用索引及查询统计等。有利于我们对索引的优化。<br>indexOnly: 字段为 false，表示没有使用了索引。<br>cursor：如果没有使用索引，游标的类型是BasicCursor。这个键还会给出你所使用的索引的名称，你通过这个名称可以查看当前数据库下的system.indexes集合（系统自动创建，由于存储索引信息，这个稍微会提到）来得到索引的详细信息。<br>nscanned/nscannedObjects：表明当前这次查询一共扫描了集合中多少个文档<br>millis：当前查询所需时间，毫秒数。<br>indexBounds：当前查询具体使用的索引。</p>
<p>MongoDB 3.0之后，explain的返回与使用方法与之前版本有点不同，explain有三种模式，分别如下：<br>queryPlanner<br>executionStats<br>allPlansExecution<br>例如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.c1.find(&#123;name:<span class="string">"linuxunix"</span>&#125;).explain(<span class="string">"executionStats"</span>)</span><br><span class="line">&#123;</span><br><span class="line">         <span class="string">"queryPlanner"</span> : &#123;</span><br><span class="line">                   <span class="string">"plannerVersion"</span> : <span class="number">1</span>,</span><br><span class="line">                   <span class="string">"namespace"</span> : <span class="string">"test.c1"</span>,</span><br><span class="line">                   <span class="string">"indexFilterSet"</span> : false,</span><br><span class="line">                   <span class="string">"parsedQuery"</span> : &#123;</span><br><span class="line">                            <span class="string">"name"</span> : &#123;</span><br><span class="line">                                     <span class="string">"$eq"</span> : <span class="string">"linuxunix"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                   &#125;,</span><br><span class="line">                   <span class="string">"winningPlan"</span> : &#123;</span><br><span class="line">                            <span class="string">"stage"</span> : <span class="string">"COLLSCAN"</span>,</span><br><span class="line">                            <span class="string">"filter"</span> : &#123;</span><br><span class="line">                                     <span class="string">"name"</span> : &#123;</span><br><span class="line">                                               <span class="string">"$eq"</span> : <span class="string">"linuxunix"</span></span><br><span class="line">                                     &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="string">"direction"</span> : <span class="string">"forward"</span></span><br><span class="line">                   &#125;,</span><br><span class="line">                   <span class="string">"rejectedPlans"</span> : [ ]</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="string">"executionStats"</span> : &#123;</span><br><span class="line">                   <span class="string">"executionSuccess"</span> : true,</span><br><span class="line">                   <span class="string">"nReturned"</span> : <span class="number">1</span>,</span><br><span class="line">                   <span class="string">"executionTimeMillis"</span> : <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"totalKeysExamined"</span> : <span class="number">0</span>,</span><br><span class="line">                   <span class="string">"totalDocsExamined"</span> : <span class="number">10</span>,</span><br><span class="line">                   <span class="string">"executionStages"</span> : &#123;</span><br><span class="line">                            <span class="string">"stage"</span> : <span class="string">"COLLSCAN"</span>,</span><br><span class="line">                            <span class="string">"filter"</span> : &#123;</span><br><span class="line">                                     <span class="string">"name"</span> : &#123;</span><br><span class="line">                                               <span class="string">"$eq"</span> : <span class="string">"linuxunix"</span></span><br><span class="line">                                     &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="string">"nReturned"</span> : <span class="number">1</span>,</span><br><span class="line">                            <span class="string">"executionTimeMillisEstimate"</span> : <span class="number">0</span>,</span><br><span class="line">                            <span class="string">"works"</span> : <span class="number">12</span>,</span><br><span class="line">                            <span class="string">"advanced"</span> : <span class="number">1</span>,</span><br><span class="line">                            <span class="string">"needTime"</span> : <span class="number">10</span>,</span><br><span class="line">                            <span class="string">"needYield"</span> : <span class="number">0</span>,</span><br><span class="line">                            <span class="string">"saveState"</span> : <span class="number">0</span>,</span><br><span class="line">                            <span class="string">"restoreState"</span> : <span class="number">0</span>,</span><br><span class="line">                            <span class="string">"isEOF"</span> : <span class="number">1</span>,</span><br><span class="line">                            <span class="string">"invalidates"</span> : <span class="number">0</span>,</span><br><span class="line">                            <span class="string">"direction"</span> : <span class="string">"forward"</span>,</span><br><span class="line">                            <span class="string">"docsExamined"</span> : <span class="number">10</span></span><br><span class="line">                   &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="string">"serverInfo"</span> : &#123;</span><br><span class="line">                   <span class="string">"host"</span> : <span class="string">"server2"</span>,</span><br><span class="line">                   <span class="string">"port"</span> : <span class="number">27017</span>,</span><br><span class="line">                   <span class="string">"version"</span> : <span class="string">"3.2.0"</span>,</span><br><span class="line">                   <span class="string">"gitVersion"</span> : <span class="string">"45d947729a0315accb6d4f15a6b06be6d9c19fe7"</span></span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&gt; db.test.getIndexKeys()  &lt;==获取所有索引的字段</span><br><span class="line">&gt; db.test.getIndexes()  &lt;==获取所有索引的相关信息</span><br></pre></td></tr></table></figure></p>
<p>从日志和以上相关命令找出主要是由于没有新增索引引起的。<br>MongoDB索引：</p>
<p>索引通常能够极大的提高查询的效率，如果没有索引，MongoDB在读取数据时必须扫描集合中的每个文件并选取那些符合查询条件的记录。<br>这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。<br>索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中，索引是对数据库表中一列或多列的值进行排序的一种结构。<br>ensureIndex() 方法</p>
<p>MongoDB使用 ensureIndex() 方法来创建索引。<br>语法</p>
<p>ensureIndex()方法基本语法格式如下所示：</p>
<blockquote>
<p>db.COLLECTION_NAME.ensureIndex({KEY:1})<br>语法中 Key 值为你要创建的索引字段，1为指定按升序创建索引，如果你想按降序来创建索引指定为-1即可。</p>
</blockquote>
<p>此处引出优化器profile话题<br>优化器profile(类似MySQL的慢查询日志)  默认是关闭的，且默认是100毫秒.我们可以通过设置profile找出查询慢的例子，通过索引等相关优化减少查询时间，<br>设置profile很简单，以下是一些基本语法：<br>db.getProfilingLevel();    –0 如果是0,说明没有开启慢查询日志<br>db.setProfilingLevel(1);   –1 表示开启记录慢查询（默认为100ms）<br>db.setProfilingLevel(2);   –2 表示记录所有命令</p>
<blockquote>
<p>db.setProfilingLevel(1,1000)<br>{ “was” : 0, “slowms” : 100, “ok” : 1 }<br>show tables<br>test<br>system.profile  &lt;==默认慢查询日志保存在此位置</p>
</blockquote>
<p>总结mongodb优化方案：</p>
<p> 1：创建索引<br> 2：限定返回结果条数<br> 3：查询使用到的字段，不查询所有字段<br> 4：采用profiling慢查询日志       </p>

	
	</div>
	
  
</div>
	<a type="button" href="/2016/01/23/mongodb╦ў╥¤╙┼╗п░╕└¤/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-01-23 </div>
			<div class="article-title"><a href="/2016/01/23/NGINX╥■▓╪░ц▒╛║┼/">NGINX隐藏版本号</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>adminuser@ubuntu:/usr/local/nginx/nginx/sbin$ curl -I 192.168.1.230<br>HTTP/1.1 200 OK<br>Server: openresty/1.7.0.1<br>Date: Wed, 20 Jan 2016 01:34:05 GMT<br>Content-Type: text/html<br>Content-Length: 612<br>Last-Modified: Fri, 15 Jan 2016 03:50:32 GMT<br>Connection: keep-alive<br>ETag: “56986c88-264”<br>Accept-Ranges: bytes</p>
<blockquote>
<p>隐藏版本号：</p>
</blockquote>
<p>adminuser@ubuntu:/usr/local/nginx/nginx/conf$ sudo vim nginx.conf</p>
<p>http<br>{<br>server_tokens off;  新增这个隐藏版本号<br>}</p>
<blockquote>
<p>更改后reload之后，测试：</p>
</blockquote>
<p>adminuser@ubuntu:/usr/local/nginx/nginx/sbin$ curl -I 192.168.1.230<br>HTTP/1.1 200 OK<br>Server: openresty<br>Date: Wed, 20 Jan 2016 01:44:02 GMT<br>Content-Type: text/html<br>Content-Length: 612<br>Last-Modified: Fri, 15 Jan 2016 03:50:32 GMT<br>Connection: keep-alive<br>ETag: “56986c88-264”<br>Accept-Ranges: bytes</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2016/01/23/NGINX╥■▓╪░ц▒╛║┼/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-01-05 </div>
			<div class="article-title"><a href="/2016/01/05/centos░▓╫░glusterfs/">centos安装glusterfs和实战</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>刚过元旦，由于最近比较忙，还木有时间给各位小伙伴们拜年，在此祝各位小伙伴们新年新气象，在新的一年内财源广进，身体健康。</p>
<blockquote>
<p>什么是分布式文件系统：</p>
<p>分布式文件系统（Distributed File System）是指文件系统管理的物理存储资源不一定直接连接在本地节点上，而是通过计算机网络与节点相连。分布式文件系统的设计基于客户机/服务器模 式。一个典型的网络可能包括多个供多用户访问的服务器。另外，对等特性允许一些系统扮演客户机和服务器的双重角色。例如，用户可以“发表”一个允许其他客 户机访问的目录，一旦被访问，这个目录对客户机来说就像使用本地驱动器一样。</p>
</blockquote>
<p><strong>分区磁盘</strong><br>[root@localhost src]# fdisk -l<br>[root@localhost src]# mkfs.etx4  /dev/sdb</p>
<p><strong>1、下载glusterfs源码包到/usr/local/urc</strong><br><a href="http://www.gluster.org/download/" target="_blank" rel="noopener">http://www.gluster.org/download/</a></p>
<p><strong>2、解压</strong><br>[root@localhost src]# tar zvxf glusterfs-3.6.6.tar.gz </p>
<p><strong>3、编译安装</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost glusterfs<span class="number">-3.6</span><span class="number">.6</span>]<span class="comment"># ./configure   --prefix=/usr/local/glusterfs -enable-systemt</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment"># 如果出现下面错误</span></span><br><span class="line">checking <span class="keyword">for</span> flex... no</span><br><span class="line">checking <span class="keyword">for</span> lex... no</span><br><span class="line">configure: error: Flex <span class="keyword">or</span> lex required to build glusterfs.</span><br><span class="line">解决方法 [root@localhost glusterfs<span class="number">-3.6</span><span class="number">.6</span>]<span class="comment"># yum -y install flex</span></span><br><span class="line"><span class="comment"># 如果出现下面错误</span></span><br><span class="line">configure: error: GNU Bison required to build glusterfs.</span><br><span class="line">解决方法 [root@localhost glusterfs<span class="number">-3.6</span><span class="number">.6</span>]<span class="comment"># yum -y install bison</span></span><br><span class="line"><span class="comment"># 如果出现下面错误</span></span><br><span class="line">configure: error: OpenSSL crypto library <span class="keyword">is</span> required to build glusterfs</span><br><span class="line">解决方法 [root@localhost glusterfs<span class="number">-3.6</span><span class="number">.6</span>]<span class="comment"># yum -y install openssl-devel</span></span><br><span class="line"></span><br><span class="line">configure: error: libxml2 devel libraries <span class="keyword">not</span> found</span><br><span class="line">解决方法：[root@localhost glusterfs<span class="number">-3.6</span><span class="number">.6</span>]<span class="comment"># yum install libxml2 libxml2-devel</span></span><br><span class="line">--------------------------------------------------------------------------------------------------------------------</span><br><span class="line">[root@localhost glusterfs<span class="number">-3.6</span><span class="number">.6</span>]<span class="comment">#make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p><strong>4、查看版本信息</strong><br>[root@localhost sbin]# ./gluster –version<br>glusterfs 3.6.6 built on Dec 27 2015 03:48:07<br>Repository revision: git://git.gluster.com/glusterfs.git<br>Copyright (c) 2006-2011 Gluster Inc. <a href="http://www.gluster.com" target="_blank" rel="noopener">http://www.gluster.com</a><br>GlusterFS comes with ABSOLUTELY NO WARRANTY.<br>You may redistribute copies of GlusterFS under the terms of the GNU General Public License.</p>
<p><strong>5、glusterfs 启动</strong><br>[root@localhost sbin]#  service glusterd start<br>Starting glusterd:                                         [确定]</p>
<p>[root@localhost sbin]# ps -ef |grep glusterd<br>root      49226      1  0 03:56 ?        00:00:00 /usr/local/glusterfs/sbin/glusterd –pid-file=/var/run/glusterd.pid<br>root      49363   6751  0 03:57 pts/2    00:00:00 grep glusterd</p>
<p><strong>6、gluster基本操作</strong><br>6.1、创建并启动volume<br>[root@localhost sbin]# ./gluster volume create help<br>Usage: volume create <new-volname> [stripe <count>] [replica <count>] [disperse [<count>]] [redundancy <count>] [transport <tcp|rdma|tcp,rdma>] <new-brick>… [force]<br>[root@localhost sbin]# ./gluster volume create  testvol 192.168.108.141:/data/brick1 192.168.108.141:/data/brick2<br>volume create: testvol: failed: The brick 192.168.108.141:/data/brick1 is being created in the root partition. It is recommended that you don’t use the system’s root partition for storage backend. Or use ‘force’ at the end of the command if you want to override this behavior.<br>提示：建议您不使用系统的根分区来存储后端。或使用“强制”命令结束时，如果你想重写此行为。<br>[root@localhost sbin]# ./gluster volume create  testvol 192.168.108.141:/data/brick1 192.168.108.141:/data/brick2 force<br>volume create: testvol: success: please start the volume to access data<br>[root@localhost sbin]# ./gluster volume info<br>Volume Name: testvol<br>Type: Distribute<br>Volume ID: 1b1c1b4d-cd7e-4770-beb4-8dfa1499d723<br>Status: Created<br>Number of Bricks: 2<br>Transport-type: tcp<br>Bricks:<br>Brick1: 192.168.108.141:/data/brick1<br>Brick2: 192.168.108.141:/data/brick2</new-brick></tcp|rdma|tcp,rdma></count></count></count></count></new-volname></p>
<p>[root@localhost sbin]# ./gluster volume start testvol   —testvol 是指创建volume的名字<br>volume start: testvol: success<br>[root@localhost sbin]# ./gluster volume info</p>
<p>Volume Name: testvol<br>Type: Distribute<br>Volume ID: 1b1c1b4d-cd7e-4770-beb4-8dfa1499d723<br>Status: Started<br>Number of Bricks: 2<br>Transport-type: tcp<br>Bricks:<br>Brick1: 192.168.108.141:/data/brick1<br>Brick2: 192.168.108.141:/data/brick2</p>
<p>[root@localhost sbin]# mount -t glusterfs 192.168.108.141:/testvol /mnt<br>[root@localhost sbin]# mount<br>/dev/mapper/VolGroup-lv_root on / type ext4 (rw)<br>proc on /proc type proc (rw)<br>sysfs on /sys type sysfs (rw)<br>devpts on /dev/pts type devpts (rw,gid=5,mode=620)<br>tmpfs on /dev/shm type tmpfs (rw)<br>/dev/sda1 on /boot type ext4 (rw)<br>none on /proc/sys/fs/binfmt_misc type binfmt_misc (rw)<br>gvfs-fuse-daemon on /root/.gvfs type fuse.gvfs-fuse-daemon (rw,nosuid,nodev)<br>/dev/sr0 on /media/CentOS_6.5_Final type iso9660 (ro,nosuid,nodev,uhelper=udisks,uid=0,gid=0,iocharset=utf8,mode=0400,dmode=0500)<br>192.168.108.141:/testvol on /mnt type fuse.glusterfs (rw,default_permissions,allow_other,max_read=131072)<br>[root@localhost sbin]# df -h<br>Filesystem                    Size  Used Avail Use% Mounted on<br>/dev/mapper/VolGroup-lv_root   18G  8.0G  8.6G  49% /<br>tmpfs                         491M  228K  491M   1% /dev/shm<br>/dev/sda1                     485M   35M  426M   8% /boot<br>/dev/sr0                      4.2G  4.2G     0 100% /media/CentOS_6.5_Final<br>192.168.108.141:/testvol       35G   16G   18G  49% /mnt</p>
<p>[root@localhost /]# cd /mnt/<br>[root@localhost mnt]# touch file.{1..10}<br>[root@localhost mnt]# ll<br>总用量 8<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.1<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.10<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.2<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.3<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.4<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.5<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.6<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.7<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.8<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.9</p>
<p>drwxr-xr-x 2 root root 8192 12月 27 22:53 test11[root@localhost /]# cd /mnt/<br>[root@localhost mnt]# ll<br>总用量 8<br>drwxr-xr-x 2 root root 8192 12月 27 22:53 test11<br>[root@localhost mnt]# touch file.{1..10}<br>[root@localhost mnt]# ll<br>总用量 8<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.1<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.10<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.2<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.3<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.4<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.5<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.6<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.7<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.8<br>-rw-r–r– 1 root root    0 12月 27 23:05 file.9<br>drwxr-xr-x 2 root root 8192 12月 27 22:53 test11<br>[root@localhost /]# ll /data/brick1/<br>总用量 4<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.6<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.7<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.8<br>drwxr-xr-x 2 root root 4096 12月 27 22:53 test11<br>[root@localhost /]# ll /data/brick2/<br>总用量 4<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.1<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.10<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.2<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.3<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.4<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.5<br>-rw-r–r– 2 root root    0 12月 27 23:05 file.9<br>drwxr-xr-x 2 root root 4096 12月 27 22:53 test11<br>提示：当我们创建了testvol时候，在挂载点上创建11个文件，自动分配给两个节点。<br><strong>分配4个节点实战：</strong><br>[root@localhost /]# /usr/local/glusterfs/sbin/gluster  volume create testvol2 192.168.108.141:/data/brick3 192.168.108.141:/data/brick4 192.168.108.141:/data/brick5 192.168.108.141:/data/brick6 force<br>volume create: testvol2: success: please start the volume to access data<br>[root@localhost data]# /usr/local/glusterfs/sbin/gluster  volume info</p>
<p>Volume Name: testvol<br>Type: Distribute<br>Volume ID: 1b1c1b4d-cd7e-4770-beb4-8dfa1499d723<br>Status: Started<br>Number of Bricks: 2<br>Transport-type: tcp<br>Bricks:<br>Brick1: 192.168.108.141:/data/brick1<br>Brick2: 192.168.108.141:/data/brick2</p>
<p>Volume Name: testvol2<br>Type: Distribute<br>Volume ID: 1aa17053-51d7-4d9d-bb5f-3b6ed4ddc559<br>Status: Created<br>Number of Bricks: 4<br>Transport-type: tcp<br>Bricks:<br>Brick1: 192.168.108.141:/data/brick3<br>Brick2: 192.168.108.141:/data/brick4<br>Brick3: 192.168.108.141:/data/brick5<br>Brick4: 192.168.108.141:/data/brick6<br>[root@localhost data]# /usr/local/glusterfs/sbin/gluster  volume stop  testvol2  –停止testvol2卷<br>Stopping volume will make its data inaccessible. Do you want to continue? (y/n) y<br>volume stop: testvol2: failed: Volume testvol2 is not in the started state<br>[root@localhost data]# /usr/local/glusterfs/sbin/gluster  volume delete  testvol2   –删除testvol2卷<br>Deleting volume will erase all information about the volume. Do you want to continue? (y/n) y<br>volume delete: testvol2: success<br>[root@localhost data]# /usr/local/glusterfs/sbin/gluster  volume info</p>
<p>Volume Name: testvol<br>Type: Distribute<br>Volume ID: 1b1c1b4d-cd7e-4770-beb4-8dfa1499d723<br>Status: Started<br>Number of Bricks: 2<br>Transport-type: tcp<br>Bricks:<br>Brick1: 192.168.108.141:/data/brick1<br>Brick2: 192.168.108.141:/data/brick2</p>
<p>[root@localhost data]# /usr/local/glusterfs/sbin/gluster  volume create  test2vol replica 2  192.168.108.141:/data/brick3 192.168.108.141:/data/brick4 192.168.108.141:/data/brick5 192.168.108.141:/data/brick6 force<br>Multiple bricks of a replicate volume are present on the same server. This setup is not optimal.<br>Do you still want to continue creating the volume?  (y/n) y<br>volume create: test2vol: success: please start the volume to access data</p>
<p>[root@localhost data]# /usr/local/glusterfs/sbin/gluster  volume info</p>
<p>Volume Name: test2vol<br>Type: Distributed-Replicate<br>Volume ID: 581ca5a1-2651-47cc-a35f-0a018b164871<br>Status: Created<br>Number of Bricks: 2 x 2 = 4<br>Transport-type: tcp<br>Bricks:<br>Brick1: 192.168.108.141:/data/brick3<br>Brick2: 192.168.108.141:/data/brick4<br>Brick3: 192.168.108.141:/data/brick5<br>Brick4: 192.168.108.141:/data/brick6</p>
<p>Volume Name: testvol<br>Type: Distribute<br>Volume ID: 1b1c1b4d-cd7e-4770-beb4-8dfa1499d723<br>Status: Started<br>Number of Bricks: 2<br>Transport-type: tcp<br>Bricks:<br>Brick1: 192.168.108.141:/data/brick1<br>Brick2: 192.168.108.141:/data/brick2</p>
<p>[root@localhost data]# mount -t glusterfs  192.168.108.141:/test2vol /mnt/test2vol/    –挂载test2vol卷<br>Mount failed. Please check the log file for more details.<br>[root@localhost data]# df -h                                                                                                       –由于卷没有启动，所以挂载失败<br>Filesystem                    Size  Used Avail Use% Mounted on<br>/dev/mapper/VolGroup-lv_root   18G  7.9G  8.6G  48% /<br>tmpfs                         491M  224K  491M   1% /dev/shm<br>/dev/sda1                     485M   35M  426M   8% /boot<br>192.168.108.141:/testvol       35G   16G   18G  48% /mnt<br>[root@localhost data]# /usr/local/glusterfs/sbin/gluster  volume  start test2vol<br>volume start: test2vol: success<br>[root@localhost data]# mount -t glusterfs  192.168.108.141:/test2vol /mnt/test2vol/<br>[root@localhost data]# df -h<br>Filesystem                    Size  Used Avail Use% Mounted on<br>/dev/mapper/VolGroup-lv_root   18G  7.9G  8.6G  48% /<br>tmpfs                         491M  224K  491M   1% /dev/shm<br>/dev/sda1                     485M   35M  426M   8% /boot<br>192.168.108.141:/testvol       35G   16G   18G  48% /mnt<br>192.168.108.141:/test2vol      35G   16G   18G  48% /mnt/test2vol</p>
<p>[root@localhost data]# cd /mnt/test2vol/<br>[root@localhost test2vol]# ll<br>总用量 0<br>[root@localhost test2vol]# touch file.{20..30}<br>[root@localhost test2vol]# ll<br>总用量 0<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.20<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.21<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.22<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.23<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.24<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.25<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.26<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.27<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.28<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.29<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.30<br>[root@localhost test2vol]# ll /data/brick<br>brick1/ brick2/ brick3/ brick4/ brick5/ brick6/<br>[root@localhost test2vol]# ll /data/brick3/<br>总用量 0<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.20<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.21<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.22<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.28<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.30<br>[root@localhost test2vol]# ll /data/brick4<br>总用量 0<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.20<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.21<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.22<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.28<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.30<br>[root@localhost test2vol]# ll /data/brick5<br>总用量 0<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.23<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.24<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.25<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.26<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.27<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.29<br>[root@localhost test2vol]# ll /data/brick6<br>总用量 0<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.23<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.24<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.25<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.26<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.27<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.29<br>由上可以得出：当写入数据时候、数据结构是以下图：</p>
<p>把节点3的数据删除，能不能恢复：</p>
<p>[root@localhost test2vol]# ll /data/brick3<br>总用量 0<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.20<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.21<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.22<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.28<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.30<br>[root@localhost test2vol]# rm -rf /data/brick3/*<br>[root@localhost test2vol]# ll /data/brick3<br>总用量 0<br>[root@localhost test2vol]# ll /mnt/test2vol<br>总用量 0<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.20<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.21<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.22<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.23<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.24<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.25<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.26<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.27<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.28<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.29<br>-rw-r–r– 1 root root 0 12月 27 23:29 file.30</p>
<p>当节点3数据掉失后，卷数据显示还是正常的。</p>
<p>均衡下：</p>
<p>[root@localhost test2vol]# /usr/local/glusterfs/sbin/gluster volume rebalance test2vol start<br>volume rebalance: test2vol: success: Initiated rebalance on volume test2vol.<br>Execute “gluster volume rebalance <volume-name> status” to check status.<br>ID: adb5c963-10a5-463c-adac-f6a4f0b3ce5e</volume-name></p>
<p>[root@localhost test2vol]# ll /data/brick3   –数据已经恢复<br>总用量 0<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.20<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.21<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.22<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.28<br>-rw-r–r– 2 root root 0 12月 27 23:29 file.30</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2016/01/05/centos░▓╫░glusterfs/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-01-05 </div>
			<div class="article-title"><a href="/2016/01/05/╗∙╙┌-memcached-╡─-tomcat-╝п╚║╓о-session-╣▓╧э/">基于 memcached 的 tomcat 集群之 session 共享</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <blockquote>
<p>Memcached 是一个高性能的分布式内存对象缓存系统，用于动态 Web  应用以减轻数据库负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高动态、数据库驱动网站的速度。Memcached 是基于一个存储 key / value 的 hashmap。</p>
</blockquote>
<p><strong>Memcached安装</strong><br>安装环境</p>
<p>CentOS 6.5<br>libevent-2.0.22-stable.tar.gz<br>memcached-1.4.24.tar.gz</p>
<p>安装 libevent</p>
<p>memcached 依赖 libevent 库，检查 libevent 是否已安装<br>[root@localhost ~]## rpm -qa | grep libevent<br>到 libevent 官网下载所需版本的安装文件<br>[root@localhost ~]# tar zxvf libevent-2.0.22-stable.tar.gz<br>[root@localhost ~]# cd libevent-2.0.22-stable<br>[root@localhost libevent-2.0.22-stable]# ./configure –prefix=/usr/local/libevent<br>[root@localhost ~]# make<br>[root@localhost ~]# make install</p>
<p>安装 memcached</p>
<p>到 memcached 官网下载所需版本的安装文件<br>[root@localhost ~]# tar zxvf memcached-1.4.24.tar.gz<br>[root@localhost memcached-1.4.24]# cd memcached-1.4.24<br>[root@localhost memcached-1.4.24]# ./configure –prefix=/usr/local/memcached –with-libevent=/usr/local/libevent/<br>[root@localhost memcached-1.4.24]# make<br>[root@localhost memcached-1.4.24]# make install</p>
<p>启动 memcached</p>
<p>[root@localhost memcached-1.4.24]# /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211 -c 1024 –P /tmp/memcached.pid<br>启动参数    描述<br>-d    启动一个守护进程<br>-m    分配给 memcached 的内存大小，单位 MB<br>-u    启动 memcached 的用户<br>-c    最大运行的并发连接数<br>-p    设置 memcached 监听的端口<br>-P    设置保存 memcached 的 pid 文件</p>
<p>查看 memcached</p>
<p>[root@localhost memcached-1.4.24]# ps -ef | grep memcached</p>
<p>关闭 memcached</p>
<p>[root@localhost memcached-1.4.24]# ps -ef | grep memcached</p>
<p>root  92911009:09 ?  00:00:00 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211 -c 1024 –P /tmp/memcached.pid</p>
<p>[root@localhost memcached-1.4.24]# kill -99291</p>
<p>防火墙开启 11211 端口</p>
<p>[root@localhost memcached-1.4.24]# vi /etc/sysconfig/iptables<br>加入如下一行配置<br>-A INPUT -m state –state NEW -m tcp -p tcp –dport 11211 -j ACCEPT<br>重启防火墙服务<br>[root@localhost memcached-1.4.24]# service iptables restart</p>
<p> <strong>基于 memcached 的 tomcat 集群之 session 共享</strong><br>实现在多台服务器之间共享 session 会话中的数据。</p>
<blockquote>
<p>JAR 包<br>asm-4.0.jar<br>kryo-1.04.jar<br>minlog-1.2.jar<br>reflectasm-1.04.jar<br>kryo-serializers-0.10.jar<br>spymemcached-2.8.12.jar<br>couchbase-client-1.1.4.jar<br>msm-kryo-serializer-1.6.4.jar<br>memcached-session-manager-1.6.4.jar<br>memcached-session-manager-tc7-1.6.4.jar</p>
</blockquote>
<ul>
<li><strong>配置</strong></li>
</ul>
<p>将 JAR 包全部放到 $Tomcat/lib 目录下（$Tomcat 表示 Tomcat 安装的根目录，以下同）。<br>编辑 $Tomcat/conf/context.xml 文件，在 <context> 节点下加入如下配置<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;Manager className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span></span><br><span class="line">         memcachedNodes=<span class="string">"n1:192.168.1.102:11211,n2:192.168.1.103:11211"</span></span><br><span class="line">         sticky=<span class="string">"false"</span></span><br><span class="line">         lockingMode=<span class="string">"auto"</span></span><br><span class="line">         sessionBackupAsync= <span class="string">"false"</span></span><br><span class="line">         sessionBackupTimeout=<span class="string">"300"</span></span><br><span class="line">         requestUriIgnorePattern= <span class="string">".*\.(png|gif|jpg|ico|css|js)$"</span></span><br><span class="line">         transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span> /&gt;</span><br></pre></td></tr></table></figure></context></p>
<ul>
<li><strong>memcachedNodes- </strong><br>必须项 </li>
</ul>
<p>配置 memcached 节点。格式：<id>:<host>:<port>，多个节点之间，用空格或英文逗号分隔</port></host></id></p>
<ul>
<li><strong>sticky </strong></li>
</ul>
<p>可选项<br>是否粘性。默认为 true。粘性会话需要保证每个用户的请求都路由到同一台 Tomcat 服务器中。否则，需要设置成非粘性会话。</p>
<ul>
<li><strong>lockingMode</strong></li>
</ul>
<p>可选项<br>用于非粘性会话。默认为 none。<br>可选值    描述<br>none    不锁定 session<br>all    每个请求访问 session 的期间，session 一直被锁定，直到请求结束<br>auto    只锁定写请求的 session，只读请求的 session 不会被锁定<br>uriPattern:<regexp>    通过正则表达式的方式来对请求的 URI 进行匹配，匹配上的会被锁定</regexp></p>
<ul>
<li><strong>sessionBackupAsync </strong></li>
</ul>
<p>可选项<br>设置 session 会话中的数据是否异步同步到 memcached 中，默认为 true。</p>
<ul>
<li><strong>requestUriIgnorePattern </strong></li>
</ul>
<p>可选项<br>设置忽略会话同步的请求的 URI 地址的正则表达式。这应该包含静态资源的请求。</p>
<ul>
<li><strong>failoverNodes </strong></li>
</ul>
<p>可选项<br>memcached 故障转移节点配置。用于粘性会话，非粘性会话不可用。如：<br>failoverNodes=”n1”，含义是告诉 msm 将 session 会话中的数据存储到 memcached 的 n2 节点中，如果 n2 节点宕掉等致使其不能正常提供服务，msm 才会将 session 会话中的数据存储到 memcached 的 n1 节点中。<br>sessionAttributeFilter</p>
<p>可选项<br>配置同步 session 会话数据的属性名称的正则表达式。如果不设置，则将 session 中全部的属性保存到 memcached 中。</p>
<ul>
<li><strong>transcoderFactoryClass </strong></li>
</ul>
<p>可选项<br>配置序列化和反序列化 session 会话中的数据到 memcached 中的编码转换器的工厂类名。<br>默认是 de.javakaffee.web.msm.JavaSerializationTranscoderFactory</p>
<ul>
<li><strong>backupThreadCount</strong></li>
</ul>
<p>可选项<br>用于异步存储 session 会话中的数据到 memcached 中的线程数。（当 sessionBackupAsync=”true” 时，该配置项有效）</p>
<ul>
<li><strong>sessionBackupTimeout</strong></li>
</ul>
<p>可选项<br>备份 session 会话数据所需时间如果大于该值，将导致 session 会话数据同步失败。默认为 100（单位毫秒）</p>
<p>以上由基友整理，博客地址为：<a href="http://fanlychie.github.io" target="_blank" rel="noopener">http://fanlychie.github.io</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2016/01/05/╗∙╙┌-memcached-╡─-tomcat-╝п╚║╓о-session-╣▓╧э/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
    	<li class="prev"><a href="/page/5/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i> Prev</a></li>
  		

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/7/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div class="widget tag">
    <h3 class="title">归档</h3>
    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">2019年03月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">2019年02月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">2018年07月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">2018年06月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">2018年05月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">2018年03月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">2018年02月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">2018年01月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">2017年11月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">2017年09月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">2017年08月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">2017年07月</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">2017年03月</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">2017年02月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">2016年01月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">2015年12月</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">2015年11月</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">2015年10月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">2015年09月</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">2015年08月</a><span class="archive-list-count">5</span></li></ul>
  </div>

		
			
		
			

		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2019/03/03/pyevn-pipenv初始化你需要的python环境/"><i class="fa fa-file-o"></i>pyevn+pipenv初始化你需要的python环境</a>
      </li>
    
      <li>
        <a href="/2019/02/18/Ansible模块中核心类（附执行剧本实例代码）/"><i class="fa fa-file-o"></i>Ansible模块中核心类（附执行剧本实例代码）</a>
      </li>
    
      <li>
        <a href="/2019/02/18/Docker如何推送镜像到Harbor？/"><i class="fa fa-file-o"></i>Docker如何推送镜像到Harbor？</a>
      </li>
    
      <li>
        <a href="/2019/02/18/如何搭建高可用Docker-Harbor仓库/"><i class="fa fa-file-o"></i>如何搭建高可用Docker Harbor仓库</a>
      </li>
    
      <li>
        <a href="/2019/02/17/Python调用Jenkins-api-文档/"><i class="fa fa-file-o"></i>Python调用Jenkins api 文档</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://linuxops.cc" title="Macro博客" target="_blank" ]);">Macro博客</a></li>
	
		<li><i class="fa fa-github"></i><a href="http://www.uinion.com/" title="uinion小站" target="_blank" ]);">uinion小站</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2019 林文杰
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
  <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'ZP2ZSuHgipSZfRyU8uTR','2.0.0');
  </script>



  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'linuxunix' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
